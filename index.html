<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="color-scheme" content="light dark">
    <title>PrismV - 당신의 단어를 기록하세요</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a3a">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* ShiftV Color Palette */
            --bg-main: #1a1a3a;
            --primary: #ff8fcd;
            --accent: #ff60a8;
            --danger: #ff5577;
            --text-main: #f0f0ff;
            --text-dim: #a8a8d8;
            --glass-bg: rgba(42, 42, 98, 0.4);
            --glass-border: rgba(180, 180, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.25);
            --glass-blur: 12px;
            --bg-dimbox: rgba(81, 81, 187, 0.2);
            --radius-xl: 30px;
            --radius-l: 20px;
            --radius-m: 15px;
            --radius-s: 10px;
            --ios-slider: rgba(255, 255, 255, 0.2);

            --grad-dark: linear-gradient(135deg, #1e1e48 0%, #2a2a60 50%, #151532 100%);
            --grad-light: linear-gradient(160deg, #fdeef5 0%, #dfe9f3 100%);

            --bg-gradient-dark: linear-gradient(135deg, #1e1e48 0%, #2a2a60 50%, #151532 100%);
            --input-bg: rgba(255, 255, 255, 0.05);

            --tab-height-mobile: 65px;
            --tab-width-desktop: 250px;
            --stat-widget: rgba(35, 15, 69, 0.2);
            --header-collapsed-height: 80px;
            /* 헤더 최소 높이 고정 */
            --header-expanded-height: auto;
            /* 사이드바 넓이 */
        }

        body.light-mode {
            --bg-main: #fdeef5;
            --bg-gradient-dark: linear-gradient(160deg, #fdeef5 0%, #dfe9f3 100%);
            --text-main: #2c2c58;
            --text-dim: #525273;
            --primary: #ff6ba9;
            --accent: #e04f84;
            --danger: #ee5253;
            --bg-dimbox: rgba(255, 205, 231, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.08);
            --ios-slider: rgba(255, 255, 255, 0.4);
            /* 밝은 테두리 */
            --glass-shadow: 0 8px 32px rgba(155, 93, 123, 0.2);
            --header-bg: rgba(255, 255, 255, 0.9);
            /* 라이트 헤더는 밝고 불투명하게 */
            --header-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            --card-bg: rgba(0, 0, 0, 0.03);
            /* 아주 연한 회색 배경 */

            --input-bg: rgba(255, 255, 255, 1);

            --stat-widget: rgba(255, 248, 251, 0.4);
            --bg-gradient: linear-gradient(135deg, #faf5f7 0%, #e2c3d1 100%);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* --- [CSS 수정] body 배경 전환 애니메이션 오류 해결 --- */
        body {
            font-family: 'Poppins', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Biaodian Pro Sans", "Meiryo", sans-serif;
            margin: 0;

            /* [핵심 수정] body에는 배경색만 지정하고 그라데이션은 제거 */
            background-color: var(--bg-main);
            color: var(--text-main);

            height: 100vh;
            overflow: hidden;

            /* 색상 변경 애니메이션 */
            transition: background-color 0.5s ease, color 0.5s ease;
            user-select: none;

            /* 가상 요소를 위한 포지셔닝 컨텍스트 */
            position: relative;
            z-index: 0;
        }

        /* [신규] 다크 모드용 그라데이션 레이어 (기본 보임) */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--grad-dark);
            z-index: -2;
            /* 맨 뒤 */
            opacity: 1;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        /* [신규] 라이트 모드용 그라데이션 레이어 (기본 숨김) */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--grad-light);
            z-index: -1;
            /* 다크 레이어 바로 앞 */
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        /* [핵심] 라이트 모드 클래스가 붙으면 투명도를 교차시킴 (Cross-fade) */
        body.light-mode::before {
            opacity: 0;
            /* 다크 배경 숨김 */
        }

        body.light-mode::after {
            opacity: 1;
            /* 라이트 배경 보임 */
        }

        /* --- [NEW] Layout & Header System (Anti-Jitter) --- */
        /* 메인 레이아웃 (스크롤 영역 분리를 위함) */
        .app-wrapper {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }


        /* 컨텐츠 영역: 전체 화면에서 사이드바 뺀 나머지 */
        .container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0 20px;
            padding-top: 30px !important;
            box-sizing: border-box;
            /* 기존 padding 20px 제거 */
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .container.no-scroll {
            overflow: hidden !important;
        }

        .stat-widget-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        h2 {
            color: var(--primary);
            font-size: 1.5rem;
            margin: 0 0 20px 0;
        }

        h3 {
            color: var(--accent);
            font-size: 1.2rem;
            margin: 20px 0 10px 0;
        }

        p.desc {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin-top: -10px;
            margin-bottom: 20px;
        }

        /* --- Glass Components --- */
        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-l);
            padding: 20px;
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(var(--glass-blur));
            margin-bottom: 0px;
            transition: 0.3s;
        }


        /* --- Navigation Bar (ShiftV Style) --- */
        .tab-bar {
            width: 50px;
            /* 기본 너비 (접힘 상태) */
            height: 100%;
            background: var(--glass-bg);
            border-right: 1px solid var(--glass-border);
            backdrop-filter: blur(var(--glass-blur));

            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            /* 아이콘 중앙 정렬 */
            padding-top: 40px;
            gap: 10px;

            z-index: 100;
            transition: width 0.3s ease;
            /* 부드러운 확장 애니메이션 */
            overflow: hidden;
            white-space: nowrap;
        }



        .tab-button {
            width: 100%;
            height: 56px;
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;

            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* 내부 요소 왼쪽 정렬 */
            padding: 0 15px;
            /* 좌우 여백 */
            gap: 15px;
            /* 아이콘과 텍스트 사이 간격 */
            transition: 0.2s;
            position: relative;
        }

        .tab-button:hover,
        .tab-button.active {
            color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        /* 아이콘 영역 (SVG 및 이모티콘) */
        /* 사이드바 아이콘 */
        .tab-icon-area {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            flex-shrink: 0;
            /* 이모티콘 전용 폰트 스택 */
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
        }

        /* 언어 추가 모달의 국기 */
        .flag-icon {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
        }

        /* 홈 대시보드 및 통계 위젯 내의 국기 */
        .stat-widget div[style*="font-size:2.5rem"],
        /* 대시보드 국기 */
        .stat-widget div[style*="font-size:2rem"]

        /* 오답노트 아이콘 */
            {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
        }

        /* 그룹 상세 헤더 등 국기 들어가는 곳 공통 */
        span {
            font-family: inherit;
            /* 기본 상속하되 필요한 곳에 위 폰트 적용됨 */
        }

        .tab-button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        /* 텍스트 라벨 (기본 숨김 -> 호버 시 표시) */
        .tab-label {
            font-size: 1rem;
            font-weight: 600;
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            /* 접혀있을 때 클릭 방해 방지 */
        }


        /* --- Language Tabs (Top Chips) --- */
        .lang-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin-bottom: 10px;
            padding-bottom: 5px;
            scrollbar-width: none;
        }

        .lang-tabs::-webkit-scrollbar {
            display: none;
        }

        .lang-chip {
            padding: 8px 16px;
            border-radius: var(--radius-xl);
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            font-size: 0.9rem;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .lang-chip.active {
            background: var(--primary);
            color: #1a1a3a;
            /* Dark text for contrast */
            border-color: var(--primary);
            font-weight: bold;
        }

        .lang-chip .del-btn {
            width: 18px;
            height: 18px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            margin-left: 5px;
        }

        .add-lang-btn {
            background: transparent;
            border: 2px dashed var(--accent);
            color: var(--accent);
        }

        #word-items-list {
            margin: 0 auto;
            padding-bottom: 120px;
        }

        /* 호버 시 색상 살짝 변경 */

        .word-content {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .word-term {
            color: var(--text-main);
            font-weight: bold;
            font-size: 1.15rem;
        }

        .word-pron {
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: normal;
            margin-left: 8px;
        }

        .word-meaning {
            color: var(--text-dim);
            margin-top: 4px;
            font-size: 1rem;
        }


        /* 5. 언어 선택 화면 - 그리드 시스템 분리 */
        /* 스마트 그룹: 모바일 무조건 2열 */
        .smart-group-grid {
            display: grid;
            /* PC/태블릿 기본: 공간 있으면 여러 열로 표시 (버튼 너무 커짐 방지) */
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        @media (max-width: 600px) {
            .smart-group-grid {
                /* 모바일에서는 무조건 2열 고정 */
                grid-template-columns: repeat(2, 1fr) !important;
            }



        }

        /* [CSS 수정] iOS 스위치 스타일 */
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;

            /* 기본(다크모드): 반투명 흰색 트랙 */
            background-color: rgba(255, 255, 255, 0.15);

            transition: .4s;
            border-radius: 34px;
        }

        /* ★ [여기 추가됨] 라이트 모드일 땐 트랙을 '반투명 검정(회색)'으로 변경 ★ */
        body.light-mode .ios-slider {
            background-color: rgba(0, 0, 0, 0.15);
        }

        .ios-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            /* 손잡이는 항상 흰색 */
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            /* 손잡이 그림자 추가로 가시성 확보 */
        }

        .ios-switch input:checked+.ios-slider {
            background-color: var(--primary);
            /* 켜지면 테마 색상 */
        }

        .ios-switch input:checked+.ios-slider:before {
            transform: translateX(22px);
        }

        /* Quiz Type Toggle Button */
        .q-type-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .q-type-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            padding: 14px;
            border-radius: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
        }

        .q-type-btn:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .q-type-btn.active {
            background: rgba(255, 143, 205, 0.15);
            /* Primary color low opacity */
            border: 1px solid var(--primary);
            color: var(--text-main);
            font-weight: 600;
            box-shadow: 0 0 10px rgba(255, 143, 205, 0.1);
        }


        /* [CSS 추가] 그룹 관리 모드용 스타일 */
        .vocab-card.managing {
            border: 1px solid var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .group-manage-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }

        /* 나의 단어장: 모바일 무조건 1열 (리스트 형태) */
        .my-vocab-list {
            display: flex;
            flex-direction: column;
            gap: 0px;
            padding-bottom: 80px;
            /* 하단 FAB 가려짐 방지 */
        }

        /* 단어장 카드 스타일 (리스트형에 맞게 높이 조정) */
        .vocab-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            min-height: 80px;
        }


        /* sub text는 흐리게 */

        .dict-btn {
            font-size: 0.85rem;
            color: #ffffff !important;
            background: linear-gradient(135deg, #03C75A, #02b350);
            /* 네이버 그린 */
            border: none;
            padding: 6px 14px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(3, 199, 90, 0.3);
            transition: 0.2s;
            white-space: nowrap;
            /* 줄바꿈 방지 */
        }

        .dict-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(3, 199, 90, 0.5);
        }

        /* --- Inputs & Forms --- */
        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-s);
            color: var(--text-main);
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(255, 143, 205, 0.2);
        }

        .glass-btn {
            width: 100%;
            padding: 14px;
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            color: var(--text-main);
            border-radius: var(--radius-l);
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
        }

        .glass-btn.primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        /* --- Floating Action Button --- */
        .fab {
            position: fixed;
            bottom: calc(var(--tab-height-mobile) + 20px);
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            box-shadow: 0 8px 20px rgba(255, 143, 205, 0.4);
            transition: transform 0.3s;
            z-index: 500;
        }

        .fab:active {
            transform: scale(0.9);
        }




        /* 4. 프로그레스 바 가독성 (배경 진하게) */
        .progress-btn {
            background: rgba(255, 255, 255, 0.05);
            /* 다크: 연한 투명 */
        }

        .progress-bg-bar {
            opacity: 0.8;
            /* 다크: 진하게 */
        }


        .tab-button {
            flex-direction: row;
            font-size: 1rem;
            width: 100%;
            height: 56px;

            /* [핵심 수정] 기본(축소) 상태: 패딩 없이 완전 중앙 정렬 */
            justify-content: center;
            padding: 0;
            gap: 0;
            /* 축소시 갭 제거 */
        }


        .tab-label {
            /* 기본적으로 숨겨서 축소 시 정렬 방해 금지 */
            display: none;
        }


        .fab {
            bottom: 40px;
            right: 40px;
        }

        /* 라벨 등장 애니메이션 추가 */
        @keyframes fadeInLabel {
            0% {
                opacity: 0;
                transform: translateX(-10px);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }



        .flag-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: var(--radius-m);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: 0.2s;
        }

        .flag-option:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
        }

        .flag-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .flag-name {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        /* 홈 대시보드 위젯 스타일 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-widget {
            background: var(--stat-widget);
            border-radius: var(--radius-m);
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .stat-label1 {
            font-size: 0.8rem;
            color: var(--accent);
        }

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        .danger-text {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        @media (max-width: 480px) {

            /* 1. 단어 리스트 아이템: 패딩을 더 줄여서 날렵하게 */
            .word-item {
                padding: 8px 10px !important;
                min-height: 60px;
                /* 최소 높이 축소 */
            }

            /* 2. 메인 단어(한국어) 크기 확실하게 줄임 */
            .word-row-main {
                flex-direction: row;
                align-items: baseline;
                font-size: 0.8rem !important;
                /* 모바일용 크기 강제 적용 */
                flex-wrap: wrap;
                gap: 4px;
            }

            /* 3. 발음 기호: 더 작게, 액센트 컬러 */
            .word-pron {
                font-size: 0.7rem !important;
                margin-left: 2px !important;
            }

            /* 4. 뜻(의미): 정보량을 위해 크기 축소 및 줄바꿈 허용 */
            .word-row-sub {
                font-size: 0.7rem !important;
                margin-top: 1px !important;
                white-space: normal !important;
            }

            /* 5. 버튼 그룹 간격: 더 오밀조밀하게 */
            .icon-actions {
                gap: 5px !important;
            }

            /* 6. 아이콘 버튼(스피커 등): 사이즈 축소 */
            .icon-btn {
                width: 28px !important;
                height: 28px !important;
                font-size: 0.85rem !important;
            }

            /* 7. 사전 버튼: 작고 둥글게 */
            .dict-btn {
                padding: 4px 8px !important;
                font-size: 0.7rem !important;
                border-radius: 12px;
            }

            /* 8. 퀴즈(▶) 버튼: 스피커 아이콘과 크기 통일 */
            .quiz-start-btn {
                width: 28px !important;
                height: 28px !important;
                font-size: 0.7rem !important;
                margin-left: 0 !important;
                padding-left: 9px !important;
                padding: 0 !important;
            }

            /* 번호 영역 공간 축소 */
            .word-item>div:first-child {
                width: 15px !important;
                margin-right: 8px !important;
            }

            .item-number {
                font-size: 0.8rem !important;
            }

            /* 헤더 관련 기존 스타일 (유지) */
            .main-title {
                white-space: normal;
                word-break: keep-all;
                font-size: 1.3rem;
            }

            .stats-dashboard {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stat-divider {
                display: none;
            }

            .main-title {
                white-space: normal;
                word-break: keep-all;
                font-size: 1.3rem;
            }

            .fixed-header-layer.shrunk .header-subtitle {
                display: none !important;
            }

            /* 헤더 서브 타이틀(기본) - 여기선 크기만 줄임 */
            .header-subtitle {
                font-size: 0.75rem !important;
                margin-bottom: 2px;
            }

        }

        /* 3. Drag Handle Style */
        .drag-handle {
            cursor: grab;
            font-size: 1.5rem;
            color: var(--text-dim);
            padding: 10px 15px;
            /* 터치 영역 확보 */
            touch-action: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drag-handle:active {
            cursor: grabbing;
            color: var(--primary);
        }

        /* 드래그 중인 아이템 효과 */
        .word-item.dragging,
        .glass-card.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed var(--accent);
        }

        /* 4. 그룹 리스트 관리 스타일 */
        .group-actions {
            display: none;
            align-items: center;
            gap: 8px;
        }

        /* 관리 모드가 아니어도 기본 버튼들이 예쁘게 보이게 */
        .btn-icon-text {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 5px;
            color: var(--text-dim);
            transition: 0.2s;
        }

        .btn-icon-text:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }

        .btn-icon-text.del:hover {
            color: var(--danger);
            background: rgba(255, 85, 119, 0.1);
        }


        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* 퀴즈 정답 버튼 스타일 */
        .choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 15px;
            font-size: 1rem;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
            text-align: left;
        }

        .choice-btn:active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        /* 퀴즈 정답 버튼 스타일 */
        .choice-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 15px;
            font-size: 1rem;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
            text-align: left;
        }

        .choice-btn:active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }



        .quiz-start-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(255, 107, 169, 0.3);
            transition: transform 0.2s;
            margin-left: 8px;
            /* 사전 버튼 옆 간격 */
            padding-left: 7px;
            /* 시각적 중앙 보정 */
        }

        .quiz-start-btn:hover {
            transform: scale(1.1);
        }



        /* 타이틀 컨테이너 (스크롤 시 헤더 탑으로 이동 연출을 위해 분리) */
        .title-container {
            transition: 0.3s;
        }



        /* 뒤로가기 버튼 스타일 미세 조정 */
        .back-icon-btn {
            background: rgba(128, 128, 128, 0.1);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }

        .back-icon-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: transparent;
        }



        /* 타이틀 옆 편집 버튼 (작고 투명하게) */
        .title-edit-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: 0.2s;
            opacity: 0.5;
            vertical-align: middle;
            display: inline-flex;
        }

        .title-edit-btn:hover {
            background: rgba(128, 128, 128, 0.2);
            opacity: 1;
            color: var(--primary);
        }

        /* Play All 버튼 */
        .play-all-btn {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
            /* 절대 안 줄어듦 */
        }

        .play-all-btn:hover {
            transform: translateY(-2px);
        }


        /* 2. 리스트 컨트롤 바 */
        .list-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 15px 10px;
            gap: 10px;
        }

        .manage-btn {
            font-size: 0.85rem;
            padding: 6px 14px;
            background: var(--accent);
            color: #fff;
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

        .manage-btn.active {
            background: transparent;
            border: 3px solid var(--glass-border);
            color: var(--accent);
            border-color: var(--accent);

            font-weight: 900;
        }

        /* 3. 리스트 아이템 리디자인 */
        .word-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px;
            background: var(--glass-bg);
            border: 1px solid transparent;
            border-bottom: 1px solid var(--glass-border);
            transition: 0.2s;
        }

        .word-item:first-child {
            border-radius: 16px 16px 0 0;
        }

        .word-item:last-child {
            border-bottom: none;
            border-radius: 0 0 16px 16px;
        }

        .word-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .item-number {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-dim);
            opacity: 0.5;
            width: 0px;
            text-align: center;
        }

        .word-content {
            flex: 1;
            min-width: 0;
            /* Flexbox text-overflow issue fix */
            margin-right: 10px;
        }

        .word-row-main {
            font-size: 1.15rem;
            font-weight: bold;
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
            /* 중요: Wrap 허용 */
        }

        .word-pron {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: normal;
        }

        .word-row-sub {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* 긴 뜻은 ... 처리 */
        }

        /* 아이콘 액션 버튼들 */
        .icon-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-dim);
            cursor: pointer;
            transition: 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--primary);
            border-color: var(--primary);
        }

        .icon-btn.play-sound {
            color: var(--text-main);
        }

        /* 관리 모드일 때만 보이는 버튼 */
        .manage-controls {
            display: none;
            gap: 5px;
        }

        .word-item.managing .manage-controls {
            display: flex;
        }

        .word-item.managing .default-actions {
            display: none;
        }

        /* 순서 이동 버튼 */
        .move-btn {
            cursor: grab;
            font-size: 1.2rem;
            color: var(--text-dim);
            padding: 0 5px;
        }

        .move-btn:hover {
            color: var(--text-main);
        }

        .header-main-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }





        body.light-mode .glass-header.shrink {
            background: rgba(255, 255, 255, 0.98);
            /* 라이트모드 하얗게 */
        }




        /* 편집 버튼 */
        .title-edit-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 0.9rem;
            vertical-align: middle;
            opacity: 0.5;
            transition: 0.2s;
        }

        .title-edit-btn:hover {
            opacity: 1;
            color: var(--primary);
        }



        .fixed-header-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: transparent !important;
            /* <<-- 핵심: 투명화 */
            box-shadow: none !important;
            backdrop-filter: none !important;
            border: none !important;
            padding: 10px 0;
            /* 카드 위아래 여백 */
        }


        .header-card-inner {
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            /* 리스트와 폭 맞춤 (모바일 기준) */
            width: calc(100% - 40px);
            margin: 0 auto;
            /* 중앙 정렬 */
        }

        .delete-btn-x {
            background: rgba(255, 85, 119, 0.1);
            color: var(--danger);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }

        .delete-btn-x:hover {
            background: var(--danger);
            color: white;
        }


        .fixed-header-layer.shrunk {
            border-radius: 0;
            background: rgba(30, 30, 45, 0.98);
        }

        body.light-mode .fixed-header-layer.shrunk {
            background: rgba(255, 255, 255, 0.98);
        }

        .header-content {
            padding: 15px 20px 0 20px;
        }

        /* 2. 헤더 내부: 버튼 및 타이틀 줄 */
        .top-row {
            display: grid;
            /* 좌측버튼 | 빈공간 | 우측버튼 (타이틀은 모바일에서 아래로) */
            grid-template-columns: 40px 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        /* 축소 시 마진 줄임 */
        .fixed-header-layer.shrunk .top-row {
            margin-bottom: 5px;
        }

        /* 3. 통계 패널 (높이 애니메이션 대상) */
        .stats-wrapper {
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            opacity: 1;
            max-height: 400px;
            /* 헤더 하단 여백 */
        }

        .fixed-header-layer.shrunk .stats-wrapper {
            max-height: 0;
            margin-bottom: 0;
            opacity: 0;
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            text-align: center;
            border-radius: 12px;
            padding: 12px;
        }

        /* 4. 스크롤 영역 (실제 컨텐츠) */
        .scroll-content-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* 헤더 높이만큼 밀어주는 투명 Spacer */
        #header-spacer {
            transition: height 0.3s;
            pointer-events: none;
        }

        /* --- [모바일 타이틀 대응] --- */
        /* 기본(PC): 타이틀이 가운데 있음 */
        .header-title-area {
            grid-column: 2 / 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
            text-align: left;
        }

        .main-title {
            font-size: 1.6rem;
            margin: 0;
            font-weight: 800;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 600px 이하 모바일 */
        @media(max-width: 600px) {
            .top-row {
                /* 모바일은 2줄로: 버튼들(1줄) / 타이틀(2줄) */
                grid-template-columns: 40px 1fr auto;
                /* 타이틀을 위해 Grid Area 재정의하거나, 단순하게 타이틀 div를 밖으로 빼는게 나음. 
                   여기서는 CSS Grid Area로 재배치 */
                grid-template-areas:
                    "back . play"
                    "title title title";
                margin-bottom: 10px;
                gap: 5px;
            }

            .back-icon-btn {
                grid-area: back;
            }

            .play-all-btn {
                grid-area: play;
                justify-self: end;
            }

            .header-title-area {
                grid-area: title;
                margin-top: 5px;
            }

            /* 줄바꿈 허용 */
            .main-title {
                white-space: normal;
                word-break: keep-all;
                font-size: 1.4rem;
            }

            .header-subtitle {
                font-size: 0.8rem;
                margin-bottom: 2px;
            }

            /* 통계 그리드 2열 */
            .stats-dashboard {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .stat-divider {
                display: none;
            }
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Shrunk 상태일때는 다시 한 줄로 (모바일도) */
        @media(max-width: 600px) {
            .fixed-header-layer.shrunk .top-row {
                grid-template-areas: "back title play";
                margin-bottom: 5px;
                gap: 10px;
            }

            .fixed-header-layer.shrunk .header-title-area {
                margin-top: 0;
            }

            .fixed-header-layer.shrunk .main-title {
                white-space: nowrap;
                font-size: 1.1rem;
                /* 다시 한 줄 말줄임 */
            }

            .fixed-header-layer.shrunk .header-subtitle {
                display: none;
            }
        }




        body.light-mode .glass-header.shrink {
            background: rgba(255, 255, 255, 0.98);
        }




        /* --- [UPDATED] Responsive Grid & Progress Button UI --- */

        /* 1. 홈 화면 반응형 그리드 (가로폭 씹힘 방지) */
        .lang-stat-grid {
            display: grid;
            /* 중요: minmax(0, 1fr)로 설정해야 컨테이너를 넘치지 않고 줄어듭니다. */
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) !important;
            grid-template-rows: auto auto;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
            /* 부모에 꽉 차게 */
            box-sizing: border-box;
            /* 패딩 포함 */
        }

        /* 폰트 크기 반응형 자동 조절 (작은 화면에서 줄어들게) */
        .lang-stat-value {
            font-size: clamp(0.7rem, 4vw, 1.1rem);
            /* 최소 0.8, 최대 1.1 */
            font-weight: 700;
            white-space: nowrap;
        }

        /* 2. [NEW] Progress Button UI (버튼 위에 텍스트 + 진행률 배경) */
        .progress-btn-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .progress-btn {
            position: relative;
            width: 100%;
            height: 60px;
            /* 높이 고정 (터치하기 좋게) */
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            /* 기본 배경 (회색/투명) */
            border-radius: 30px;
            /* 둥근 캡슐 형태 */
            overflow: hidden;
            /* 배경 바가 튀어나가지 않게 */
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }

        .progress-btn:active {
            transform: scale(0.98);
        }

        /* 실제 진행률을 나타내는 배경 바 (absolute로 뒤에 깔림) */
        .progress-bg-bar {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background: var(--primary);
            /* 진행 색상 */
            opacity: 0.8;
            transition: width 1s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 1;
        }

        /* 텍스트 내용 (z-index로 앞으로 뺌) */
        .progress-content {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: var(--text-main);
            /* 텍스트 색상 */
            font-weight: 600;
        }

        /* 정답률 텍스트 스타일 */
        .progress-rate {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        body.light-mode .progress-btn {
            background: rgba(255, 255, 255, 0.8);
            /* 라이트: 거의 흰색 */
            box-shadow: 0 2px 8px rgba(200, 150, 170, 0.1);
            /* 그림자 추가 */
            border: 1px solid rgba(200, 0, 100, 0.05);
        }

        body.light-mode .progress-bg-bar {
            opacity: 0.2;
            /* 라이트: 은은하게 */
        }

        /* 정답률 텍스트 잘 보이게 */
        body.light-mode .progress-content {
            color: #333;
            font-weight: 700;
        }

        body.light-mode .progress-rate {
            color: var(--accent);
        }

        /* 태그 리스트 배경 바 색상 (회색 대신 테마 컬러) */
        .progress-bg-bar[style*="background:var(--accent)"] {
            background: var(--accent) !important;
        }

        /* [추가] 모달 제목 정렬 */
        .modal-panel h3 {
            margin: 10px 0;
            text-align: center;
        }





        /* 3. 모달 스크롤 레이아웃 재정의 */
        /* 전체 화면 덮는 모달 (기존 클래스 덮어쓰기) */
        .modal-panel.scrollable-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            max-width: 100% !important;
            /* PC 제한 해제 */
            border-radius: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: var(--bg-main);
            /* 배경색 불투명하게 */
        }



        body.light-mode .modal-sticky-header {
            /* 라이트모드 헤더 */
            background: rgba(253, 238, 245, 0.98);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        body.light-mode .modal-sticky-header {
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }


        /* 기존 단순 컨텐츠 래퍼 (.modal-panel 바로 아래 div 등) 호환성 처리 */
        .modal-panel>h3,
        .modal-panel>p.desc,
        .modal-panel>div.input-group,
        .modal-panel>div.flag-grid {
            /* 만약 .modal-scroll-body 안에 없더라도 최소한의 마진 확보 */
            margin-left: 20px;
            margin-right: 20px;
        }

        /* 플래그 그리드 마진 복구 */
        .flag-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* 한 줄에 3개 */
            gap: 15px;
            /* 카드 사이 간격 */
            row-gap: 25px;
            /* 줄 사이 간격 (버튼끼리 너무 붙지 않게) */
            margin-top: 25px;
            padding: 10px;
            /* 그리드 자체 패딩 */
        }

        /* 2. 설정창 등 모달 내부 카드 간격 */
        .modal-card-spacer {
            margin-bottom: 20px;
            /* 카드들 사이의 여백 */
        }


        /* 5. 퀴즈 기록 리스트 아이템 스타일 (리스트형) */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .history-item:active {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(0.98);
        }

        body.light-mode .history-item {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        /* 그라디언트 텍스트 (리퀴드 포인트) */
        .liquid-text-gradient {
            background: linear-gradient(135deg, var(--text-main) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        /* 강조용 태그 스타일 */
        .group-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(var(--primary-rgb), 0.1);
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 4px;
        }






        /* 2. 고도화된 차트 및 하단 상세 뷰 스타일 */

        /* 차트 컨테이너 */
        .chart-wrapper {
            background: rgba(0, 0, 0, 0.2);
            /* 차트 배경을 조금 더 어둡게 */
            border-radius: 20px;
            padding: 20px 10px 5px 10px;
            /* 상우하좌 */
            margin: 20px 0;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        body.light-mode .chart-wrapper {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.02);
        }

        /* 차트 요소들 */
        .chart-axis-line {
            stroke: var(--text-dim);
            stroke-width: 0.5;
            opacity: 0.3;
        }

        .chart-axis-text {
            fill: var(--text-dim);
            font-size: 10px;
        }

        .chart-line-path {
            fill: none;
            stroke: var(--primary);
            stroke-width: 3;
            stroke-linecap: round;
        }

        .chart-dot {
            fill: var(--bg-main);
            stroke: var(--primary);
            stroke-width: 1px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .chart-dot:hover,
        .chart-dot.selected {
            r: 6;
            stroke: white;
            fill: var(--accent);
        }

        /* 3. 하단 상세 정보 카드 (애니메이션 포함) */
        .detail-view-container {
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .detail-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* 오답 리스트 아이템 스타일 */
        .wrong-item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.light-mode .wrong-item-row {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .wrong-item-row:last-child {
            border-bottom: none;
        }

        @media (max-width: 600px) {
            .lang-stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* 모바일 2열 */
        }

        /* 태그 프로그레스 바 */
        .tag-stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 12px;
        }

        .tag-name {
            width: 80px;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-track {
            flex: 1;
            height: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            margin: 0 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s ease;
        }

        .tag-pct {
            width: 45px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--accent);
        }

        /* SVG 차트 스타일 */
        .chart-container {
            width: 100%;
            height: 250px;
            position: relative;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 15px;
            padding: 10px;
            border: 1px solid var(--glass-border);
        }

        .chart-point {
            cursor: pointer;
            transition: r 0.2s;
        }

        .chart-point:hover {
            r: 6;
            fill: white;
        }

        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            pointer-events: none;
            display: none;
        }





        /* --- [FINAL FIX] Modal Engine & Layout --- */

        /* 1. 오버레이: 전체 화면을 덮고, 자식(패널)을 아래쪽에 정렬 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            /* 배경 더 어둡게 (뒤 화면 가림) */
            backdrop-filter: blur(8px);
            /* 블러 강화 */
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;

            /* Flexbox로 패널 위치 잡기 */
            flex-direction: column;
            justify-content: flex-end;
            /* 아래쪽 정렬 */
            align-items: center;
            /* 가로 중앙 */
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* 2. 패널: 오버레이 안에서 아래쪽에서 올라옴 */
        .modal-panel,
        .modal-panel.scrollable-modal {
            position: relative;
            /* Fixed가 아닌 Relative로 변경 (중요) */
            width: 100%;
            max-width: 600px;
            /* PC에서는 너무 안 퍼지게 */
            height: 92vh;
            /* 높이 설정 */

            background: rgba(30, 30, 45, 0.98);
            /* 거의 불투명하게 (뒤 안 비치게) */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            border-radius: 28px 28px 0 0;

            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.7);

            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);

            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-overlay.active .modal-panel {
            transform: translateY(0);
        }

        /* [라이트모드 패널] */
        body.light-mode .modal-panel,
        body.light-mode .modal-panel.scrollable-modal {
            background: #ffffff;
            /* 완전 흰색 배경 (가독성 최우선) */
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* 3. 모달 헤더 */
        .modal-sticky-header {
            flex-shrink: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: inherit;
            /* 패널 배경색 따라감 */
        }

        body.light-mode .modal-sticky-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* 4. 스크롤 본문 (여백 재설정) */
        .modal-scroll-body {
            flex: 1;
            overflow-y: auto;
            /* 좌우 여백 20px, 하단 여백을 넉넉하게 50px로 늘려 사진 속 '마진 추가' 요청 해결 */
            padding: 20px 20px 50px 20px;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            /* 너비 꽉 채우기 */
            box-sizing: border-box;
            /* 패딩 포함 너비 계산 */
        }

        /* [추가] 모달 내부에서 버튼들이 바닥에 붙지 않게 감싸는 컨테이너 */
        .modal-footer-gap {
            height: 30px;
            width: 100%;
        }

        /* 입력 필드 그룹 마진 수정 */
        .input-group {
            margin-bottom: 15px;
            width: 100%;
        }

        select option {
            background-color: var(--bg-main);
            /* 테마 배경색 따름 */
            color: var(--text-main);
            /* 테마 글자색 따름 */
        }

        /* --- <style> 맨 아래에 추가 --- */

        /* 로고 이미지 스타일 */
        .logo-container {
            display: flex;
            justify-content: center;
            /* 가운데 정렬 */
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            padding-top: 10px;
        }

        .app-logo {
            height: 260px;
            /* 상단 로고 기본 높이 */
            width: auto;
            object-fit: contain;
            transition: all 0.3s ease;
        }

        /* 설정창 하단 앱 정보 카드용 큰 로고 */
        .app-logo.large {
            height: 260px;
            margin-bottom: 10px;
        }

        /* --- [CSS 수정] 1. 홈 대시보드 그리드 개선 (모바일 잘림 방지) --- */
        /* 기존 .lang-stat-grid 관련 스타일이 있다면 덮어씌워짐, 혹은 별도 클래스로 활용 */
        .dashboard-responsive-grid {
            display: grid;
            /* 핵심: 화면이 좁을 땐 100%를 채우고, 여유가 생기면 최소 260px씩 나눔 */
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 260px), 1fr));
            gap: 20px;
            padding-bottom: 100px;
            width: 100%;
            box-sizing: border-box;
            /* 패딩 포함 너비 계산 */
        }

        /* --- [CSS 수정] 2. 모달 애니메이션 로직 개선 --- */
        .modal-overlay {
            display: none;
            /* JS로 active 클래스가 붙으면 flex로 변경됨 */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;

            /* 투명도 애니메이션 */
            opacity: 0;
            transition: opacity 0.3s ease;

            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        /* 활성화 상태 (열림) */
        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        /* 닫히는 중 상태 (JS에서 닫기 버튼 누르면 잠시 이 클래스를 부여) */
        .modal-overlay.closing {
            display: flex;
            /* 닫히는 동안에도 보여야 함 */
            opacity: 0;
            /* 투명해짐 */
        }

        .modal-panel {
            /* 기존 스타일 유지하되 transform 초기값 설정 */
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 92vh;
            background: rgba(30, 30, 45, 0.98);
            /* 다크모드 기본 */
            border-radius: 28px 28px 0 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;

            /* 아래에서 올라오는 애니메이션 */
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 라이트모드 대응 */
        body.light-mode .modal-panel {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.1);
        }

        /* 모달이 활성화되면 패널이 올라옴 */
        .modal-overlay.active .modal-panel {
            transform: translateY(0);
        }

        /* 닫히는 중에는 패널이 다시 내려감 */
        .modal-overlay.closing .modal-panel {
            transform: translateY(100%);
        }


        /* --- [CSS 추가] 초기 설정 마법사 스타일 --- */
        .setup-step.hidden {
            display: none;
        }

        /* 선택된 테마 버튼 강조 */
        .theme-selected {
            border-color: var(--primary) !important;
            background: rgba(var(--primary-rgb), 0.1) !important;
            font-weight: bold;
            color: var(--primary) !important;
        }
    </style>
</head>

<body class="dark-mode">

    <!-- [수정] 초기 설정 팝업 (데이터 불러오기 추가 + 내부 로직 개선) -->
    <div id="setup-popup" class="modal-overlay">
        <div class="modal-panel">
            <!-- 상단 헤더 (단계 표시용, 1단계에선 숨김) -->
            <div class="modal-sticky-header" id="setup-header" style="display:none;">
                <button onclick="prevSetupStep()" class="back-icon-btn">←</button>
                <h3 style="margin:0; font-size:1.1rem;">초기 설정</h3>
                <div style="width:40px;"></div>
            </div>

            <div class="modal-scroll-body" style="padding-top:20px;">

                <!-- STEP 1: 환영 인사 & 데이터 복원 -->
                <div id="setup-step-1" class="setup-step">
                    <div
                        style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:60vh;">
                        <div class="logo-container" style="margin-bottom:30px;">
                            <img src="./Asset/PrismV_dark.png" class="app-logo large" id="setup-logo" alt="PrismV Logo"
                                style="height:150px;">
                        </div>
                        <h1 style="font-size:2rem; margin:0 0 10px 0;" class="liquid-text-gradient">Welcome!</h1>
                        <p class="desc">당신의 단어를 기록하고, 완벽하게 기억하세요.</p>

                        <!-- [추가됨] 숨겨진 파일 입력 -->
                        <input type="file" id="setup-file-import" style="display:none;"
                            onchange="importSetupData(this)">

                        <!-- 시작하기 버튼 -->
                        <button class="glass-btn primary" onclick="goSetupStep(2)"
                            style="margin-top:40px; width:80%;">시작하기</button>

                        <!-- [추가됨] 기존 정보 불러오기 버튼 (태두리만) -->
                        <button class="glass-btn" onclick="triggerSetupImport()"
                            style="margin-top:10px; width:80%; background:transparent; border:1px solid var(--text-dim); color:var(--text-dim);">
                            📂 기존 정보 불러오기
                        </button>
                    </div>
                </div>

                <!-- STEP 2: 언어 설정 -->
                <div id="setup-step-2" class="setup-step hidden">
                    <div style="text-align:center; margin-bottom:20px;">
                        <h2 style="margin:0;">언어 설정 🌐</h2>
                        <p class="desc">모국어와 학습할 언어를 선택하세요.</p>
                    </div>

                    <!-- 모국어 선택 -->
                    <div class="glass-card" style="padding:20px; margin-bottom:20px;">
                        <label class="input-label" style="margin-bottom:8px;">나의 모국어 (System Language)</label>
                        <select id="setup-sys-lang" onchange="updateSysLang(this.value)" style="margin:0;">
                            <option value="ko">한국어 (Korean)</option>
                            <option value="en">English</option>
                            <option value="ja">日本語</option>
                            <option value="zh">中文 (Chinese)</option>
                            <option value="es">Español (Spanish)</option>
                        </select>
                    </div>

                    <!-- 학습 언어 선택 (그리드) -->
                    <label class="input-label" style="margin-left:5px; margin-bottom:10px;">학습할 언어 추가</label>
                    <div id="setup-flag-grid" class="flag-grid" style="margin-top:0; padding:0;">
                        <!-- JS로 렌더링 -->
                    </div>

                    <div style="height:30px;"></div>
                    <button class="glass-btn primary" onclick="goSetupStep(3)">다음 (Next)</button>
                </div>

                <!-- STEP 3: 테마 및 미리보기 -->
                <div id="setup-step-3" class="setup-step hidden">
                    <div style="text-align:center; margin-bottom:20px;">
                        <h2 style="margin:0;">테마 설정 🎨</h2>
                        <p class="desc">눈이 편안한 모드를 선택하세요.</p>
                    </div>

                    <!-- 테마 버튼 -->
                    <div style="display:flex; gap:15px; margin-bottom:30px; justify-content:center;">
                        <button class="glass-btn" onclick="previewTheme('dark')" id="btn-setup-dark"
                            style="flex:1; border:2px solid var(--glass-border);">Dark 🌙</button>
                        <button class="glass-btn" onclick="previewTheme('light')" id="btn-setup-light"
                            style="flex:1; border:1px solid var(--glass-border);">Light ☀️</button>
                    </div>

                    <!-- 미리보기 카드 -->
                    <label class="input-label" style="text-align:center; margin-bottom:10px;">미리보기 (Preview)</label>
                    <div class="glass-card word-item"
                        style="padding:15px; display:flex; align-items:center; opacity:1; transform:scale(1);">
                        <div style="width:15px; text-align:center; color:var(--text-dim); font-size:0.9rem;">1</div>
                        <div style="flex:1; margin-left:10px;">
                            <div style="color:var(--text-main); font-weight:600; font-size:1.15rem;">
                                Prism <span
                                    style="font-weight:normal; color:var(--accent); font-size:0.85rem; margin-left:5px;">[prɪzəm]</span>
                            </div>
                            <div style="color:var(--text-dim); margin-top:2px; font-size:1rem;">프리즘, 분광</div>
                        </div>
                        <div class="icon-btn"
                            style="width:32px; height:32px; display:flex; align-items:center; justify-content:center;">
                            🔊</div>
                    </div>

                    <div style="height:50px;"></div>
                    <button class="glass-btn primary" onclick="finishSetup()">설정 완료 (Finish)</button>
                </div>

                <div class="modal-footer-gap"></div>
            </div>
        </div>
    </div>

    <div class="app-wrapper">
        <!-- 메인 네비게이션 (Tabs) -->
        <nav class="tab-bar" id="app-nav-bar">
            <!-- JS로 홈 + 언어탭 생성 -->
        </nav>

        <main class="container" id="main-view-area">
            <!-- JS가 현재 탭에 맞는 화면(홈 위젯 or 언어별 그룹)을 여기에 그립니다 -->
        </main>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="main-fab" onclick="openAddWordModal()">+</button>

    <!-- [수정] Modal: 단어 추가/수정 (Label 정리 + 예문으로 변경) -->
    <div id="modal-add-word" class="modal-overlay">
        <div class="modal-panel">
            <!-- 고정 헤더 영역 -->
            <div class="modal-sticky-header">
                <button onclick="closeModal('modal-word-detail')" class="back-icon-btn"
                    style="border:none; background:none;">✕</button>
                <h3 style="margin:0; font-size:1.1rem;">${t('word_detail')}</h3>
                <button id="btn-detail-edit" class="title-edit-btn" style="font-size:1.1rem; opacity:1;">✎</button>
            </div>

            <!-- 스크롤 본문 영역 -->
            <div class="modal-scroll-body">
                <p class="desc" style="text-align:center; margin-bottom:20px;">현재 언어: <span id="current-lang-display"
                        style="color:var(--primary); font-weight:bold;">-</span></p>

                <style>
                    .input-group {
                        margin-bottom: 10px;
                    }

                    .input-label {
                        display: block;
                        font-size: 0.8rem;
                        color: var(--text-dim);
                        margin-bottom: 4px;
                        font-weight: 600;
                    }

                    .tag-chip {
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        background: rgba(255, 255, 255, 0.05);
                        border: 1px solid var(--glass-border);
                        border-radius: 8px;
                        padding: 6px 12px;
                        margin: 0 6px 6px 0;
                        /* 간격 */
                        font-size: 0.85rem;
                        color: var(--text-dim);
                        cursor: pointer;
                        transition: 0.2s;
                        user-select: none;
                    }

                    .tag-chip:hover {
                        border-color: var(--primary);
                        color: var(--text-main);
                        background: rgba(255, 255, 255, 0.1);
                    }
                </style>

                <!-- 단어 입력 -->
                <div class="input-group">
                    <span class="input-label" id="lbl-term">단어/표현</span>
                    <input type="text" id="inp-term" placeholder="Prism">
                </div>

                <!-- 발음 입력 -->
                <div class="input-group">
                    <span class="input-label" id="lbl-pron">발음/읽는 법</span>
                    <input type="text" id="inp-pron" placeholder="[prɪzəm]">
                </div>

                <!-- 뜻 입력 -->
                <div class="input-group">
                    <span class="input-label" id="lbl-mean">뜻/의미</span>
                    <input type="text" id="inp-mean" placeholder="프리즘, 분광">
                </div>

                <!-- 예문(메모) 입력 -->
                <div class="input-group">
                    <span class="input-label" id="lbl-memo">예문 (선택)</span>
                    <input type="text" id="inp-memo" placeholder="A prism decomposes light into a spectrum.">
                </div>

                <!-- 태그 입력 및 범주 목록 -->
                <div class="input-group" style="position:relative;">
                    <span class="input-label" id="lbl-tags">태그 (선택)</span>
                    <input type="text" id="inp-tags" placeholder="#IT #Science" oninput="filterTags(this.value)">
                    <div id="tag-suggestions"
                        style="margin-top:8px; max-height:100px; overflow-y:auto; display:flex; flex-wrap:wrap;"></div>
                </div>

                <!-- 버튼 영역 -->
                <div style="display:flex; gap:10px; margin-top:25px;">
                    <button class="glass-btn primary" onclick="saveWord(false)" id="btn-save"
                        style="flex:1;">저장</button>
                    <button class="glass-btn primary" onclick="saveWord(true)" id="btn-save-cont"
                        style="flex:1; background:rgba(255,255,255,0.2); border:1px solid var(--accent);">저장 &
                        계속</button>
                </div>
                <button class="glass-btn" onclick="closeModal('modal-add-word')" id="btn-cancel"
                    style="margin-top:10px;">취소</button>
                <div style="height:30px;"></div>
            </div>
        </div>
    </div>

    <!-- [수정] Modal: 언어 추가 -->
    <!-- [수정] Modal: 언어 추가 (구조 통일) -->
    <div id="modal-add-lang" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-sticky-header">
                <button onclick="closeModal('modal-add-lang')" class="back-icon-btn"
                    style="border:none; background:none;">✕</button>
                <h3 style="margin:0; font-size:1.1rem;">언어 추가/관리</h3>
                <div style="width:40px;"></div>
            </div>
            <div class="modal-scroll-body">
                <p class="desc" style="text-align:center; margin-bottom:15px;">국기를 클릭하여 학습 언어를 추가하세요.</p>
                <div id="flag-selection-area" class="flag-grid" style="margin-bottom:20px;">
                    <!-- JS로 국기 버튼 생성됨 -->
                </div>
                <button class="glass-btn" onclick="closeModal('modal-add-lang')">닫기</button>
                <div class="modal-footer-gap"></div>
            </div>
        </div>
    </div>

    <!-- [수정] Modal: 새 단어장 (디자인 개선) -->
    <div id="modal-create-group" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-sticky-header">
                <button onclick="closeModal('modal-create-group')" class="back-icon-btn"
                    style="border:none; background:none;">✕</button>
                <h3 style="margin:0; font-size:1.1rem;">새 단어장 만들기</h3>
                <div style="width:40px;"></div>
            </div>

            <div class="modal-scroll-body">
                <!-- 안내 문구 -->
                <div style="text-align:center; margin: 10px 0 30px 0;">
                    <div style="font-size:3rem; margin-bottom:10px;">📁</div>
                    <p class="desc" style="margin:0;">새로운 단어장의 이름과 설명을 입력하세요.</p>
                </div>

                <!-- 입력 폼 -->
                <div class="glass-card" style="padding:20px; margin-bottom:20px;">
                    <div class="input-group">
                        <span class="input-label" style="margin-left:2px;">단어장 이름</span>
                        <input type="text" id="inp-group-title" style="margin-bottom:15px;">
                    </div>

                    <div class="input-group" style="margin-bottom:0;">
                        <span class="input-label" style="margin-left:2px;">설명 (선택)</span>
                        <input type="text" id="inp-group-desc" placeholder="예: 토익 필수 영단어 Day 1"
                            style="margin-bottom:0;">
                    </div>
                </div>

                <!-- 버튼 -->
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="glass-btn primary" onclick="submitCreateGroup()"
                        style="height:50px; font-size:1rem;">생성하기</button>
                    <button class="glass-btn" onclick="closeModal('modal-create-group')"
                        style="height:50px;">취소</button>
                </div>

                <div class="modal-footer-gap"></div>
            </div>
        </div>
    </div>

    <!-- [3단계 신규] 퀴즈 설정 모달 -->
    <div id="modal-quiz-setup" class="modal-overlay">
        <div class="modal-panel">
            <h3>퀴즈 설정 📝</h3>
            <div class="glass-card" style="margin-top:15px; padding:15px;">
                <!-- TTS 토글 -->
                <label style="display:flex; justify-content:space-between; align-items:center;">
                    <span>🔊 TTS(음성) 듣기</span>
                    <input type="checkbox" id="chk-tts" checked
                        style="width:20px; height:20px; accent-color:var(--primary);">
                </label>
                <hr style="border:0; border-top:1px solid var(--glass-border); margin:12px 0; opacity:0.3;">

                <!-- 문제 유형 체크박스들이 들어갈 자리 -->
                <span class="input-label" style="margin-bottom:8px;">출제 유형 선택</span>
                <div id="quiz-types-area" style="display:flex; flex-direction:column; gap:8px; margin-bottom:10px;">
                </div>
            </div>

            <!-- 옵션: 랜덤, 이어하기 -->
            <div class="glass-card"
                style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <span>🔀 랜덤 순서 (이어하기 불가)</span>
                <input type="checkbox" id="chk-random" onchange="toggleContinueBtn()"
                    style="width:20px; height:20px; accent-color:var(--accent);">
            </div>

            <!-- 실행 버튼들 -->
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="glass-btn primary" onclick="launchQuiz('start')" style="flex:1;">처음부터 시작</button>
                <button class="glass-btn" id="btn-quiz-continue" onclick="launchQuiz('continue')" style="flex:1;">이어서
                    시작</button>
            </div>
            <button class="glass-btn" onclick="closeModal('modal-quiz-setup')" style="margin-top:10px;">취소</button>
        </div>
    </div>

    <!-- [3단계 신규] 퀴즈 플레이 화면 (전체화면 오버레이) -->
    <div id="quiz-screen"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-main); background-image:var(--bg-gradient-dark); z-index:2000; display:none; flex-direction:column; padding:20px;">
        <!-- 상단 헤더 -->
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button onclick="exitQuiz()"
                style="background:none; border:none; color:var(--text-dim); font-size:1.5rem; cursor:pointer;">✕</button>
            <div style="flex:1; margin:0 20px;">
                <!-- 진행바 -->
                <div style="height:8px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden;">
                    <div id="quiz-progress-bar"
                        style="height:100%; width:0%; background:var(--primary); transition:width 0.3s ease;">
                    </div>
                </div>
            </div>
            <span id="quiz-progress-text" style="color:var(--text-dim); font-size:0.9rem;">0/0</span>
        </header>

        <!-- 메인 문제 영역 -->
        <main id="quiz-content"
            style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; position:relative;">
            <!-- 문제 타입 뱃지 -->
            <span id="q-type-badge"
                style="background:rgba(255,255,255,0.1); border:1px solid var(--glass-border); padding:4px 10px; border-radius:15px; font-size:0.8rem; margin-bottom:20px; color:var(--accent);">TYPE</span>

            <!-- TTS 버튼 -->
            <button id="q-tts-btn" onclick="speakCurrent()"
                style="background:none; border:2px solid var(--text-main); border-radius:50%; width:50px; height:50px; font-size:1.5rem; margin-bottom:15px; cursor:pointer; display:none;">🔊</button>

            <!-- 문제 텍스트 -->
            <h1 id="q-text" style="font-size:2.2rem; font-weight:700; margin:0 0 40px 0; word-break:keep-all;">
                Question
            </h1>

            <!-- 정답 입력/선택 영역 -->
            <div id="q-answer-area" style="width:100%; max-width:400px; display:flex; flex-direction:column; gap:10px;">
            </div>

            <!-- 정오답 피드백 오버레이 -->
            <div id="q-feedback"
                style="position:absolute; bottom:0; left:0; width:100%; background:rgba(20,20,30,0.95); backdrop-filter:blur(10px); padding:20px; border-radius:20px 20px 0 0; border-top:1px solid var(--glass-border); display:none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);">
                <h2 id="fb-title" style="margin:0 0 10px 0; font-size:1.5rem;">Result</h2>
                <div id="fb-detail" style="font-size:1rem; line-height:1.5; color:var(--text-dim); margin-bottom:20px;">
                    Detail</div>
                <button class="glass-btn primary" onclick="nextQuestion()" id="fb-next-btn">다음 (Next) ▶</button>
            </div>
        </main>
    </div>

    <!-- [신규] 단어 상세 보기 모달 -->
    <div id="modal-word-detail" class="modal-overlay">
        <div class="modal-panel">
            <div class="modal-sticky-header">
                <button onclick="closeModal('modal-word-detail')" class="back-icon-btn"
                    style="border:none; background:none;">✕</button>
                <h3 style="margin:0; font-size:1.1rem;">${t('word_detail')}</h3>
                <button id="btn-detail-edit" class="title-edit-btn" style="font-size:1.1rem; opacity:1;">✎</button>
            </div>

            <div class="modal-scroll-body">
                <div style="text-align:center; margin-bottom:20px;">
                    <h1 style="margin:0; font-size:2.2rem; word-break:break-all;">${word.term}</h1>
                    <div style="font-size:1.1rem; color:var(--accent); margin-top:5px;">${word.pron ? `[${word.pron}]` :
                        ''}</div>
                </div>

                <div class="glass-card" style="margin-bottom:15px; padding:15px;">
                    <span class="input-label">${t('mean')}</span>
                    <div style="font-size:1.2rem; font-weight:600; color:var(--text-main);">${word.mean}</div>
                </div>

                <div class="glass-card" style="margin-bottom:15px; padding:15px;">
                    <span class="input-label">${t('memo')}</span>
                    <div style="font-size:1rem; color:var(--text-dim); line-height:1.5; min-height:20px;">${word.memo ||
                        '-'}</div>
                </div>

                <div style="margin-bottom:25px;">
                    <span class="input-label" style="margin-bottom:8px;">${t('tags')}</span>
                    <div style="display:flex; flex-wrap:wrap;">${tagHtml}</div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button id="btn-detail-dict" class="glass-btn primary"
                        style="flex:1; background:linear-gradient(135deg, #03C75A, #02b350); border:none;">
                        ${t('dict_search')}
                    </button>
                </div>
                <div class="modal-footer-gap"></div>
            </div>
            `;

        </div>
    </div>


    <script>


        /* --- [추가] Service Worker 등록 로직 --- */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('SW Registered:', reg);

                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // [수정] 번역 함수 t() 사용
                                if (confirm(t('update_found'))) {
                                    window.location.reload();
                                }
                            }
                        };
                    };
                })
                .catch(err => console.log('SW Registration Fail:', err));
        }
        /* --- [JS 교체] 다국어 번역 데이터베이스 (5개국어) --- */
        /* --- [JS 수정] 1. 다국어 데이터 및 통합 번역 함수 --- */
        const TRANSLATIONS = {
            'ko': {
                app_name: "PrismV",
                welcome_title: "환영합니다!",
                welcome_desc: "당신의 단어를 기록하고, 완벽하게 기억하세요.",
                start: "시작하기",
                import_data: "📂 기존 정보 불러오기",
                setup_lang: "언어 설정 🌐",
                setup_lang_desc: "모국어와 학습할 언어를 선택하세요.",
                mother_tongue: "나의 모국어",
                target_lang: "학습할 언어 추가",
                setup_theme: "테마 설정 🎨",
                setup_theme_desc: "눈이 편안한 모드를 선택하세요.",
                preview: "미리보기",
                finish_setup: "설정 완료",
                dashboard: "대시보드",
                settings: "설정",
                my_learning_status: "나의 학습 현황",
                add_lang: "언어 추가",
                total_words: "단어수",
                accuracy: "정답률",
                review_status: "복습",
                exam_count: "시험횟수",
                today: "오늘",
                days_ago: "{n}일 전",
                click_analyze: "클릭하여 분석 >",
                my_vocas: "나의 단어장 📂",
                smart_group: "스마트 그룹 (Auto)",
                smart_last_wrong: "직전 오답 노트",
                smart_freq_wrong: "취약 단어 (3회+)",
                manage: "관리",
                done: "완료",
                empty_group: "생성된 단어장이 없습니다.<br>우측 하단 + 버튼을 눌러 추가하세요.",
                empty_word: "단어가 없습니다.<br>'+' 버튼으로 추가하세요.",
                new_group_title: "새 단어장 만들기 📁",
                new_group_desc: "단어장의 이름과 설명을 입력하세요.",
                grp_name: "단어장 이름",
                grp_desc: "단어장 설명 (개요)",
                create: "생성하기",
                cancel: "취소",
                save: "저장",
                save_cont: "저장 & 계속",
                word_new: "새 단어 추가",
                word_edit: "단어 수정",
                term: "단어/표현",
                pron: "발음/읽는 법",
                mean: "뜻/의미",
                memo: "메모 (예문)",
                tags: "태그",
                quiz_setup: "퀴즈 설정 📝",
                tts_option: "🔊 TTS(음성) 듣기",
                random_option: "🔀 랜덤 순서 (이어하기 불가)",
                quiz_type_select: "출제 유형 선택 (다중 선택 가능)",
                quiz_start: "처음부터 시작",
                quiz_cont: "이어서 시작",
                quiz_start_idx: "이 단어부터 퀴즈 시작",
                alert_input: "단어와 뜻을 입력하세요",
                confirm_del: "삭제하시겠습니까?",
                restore_confirm: "기존 데이터를 덮어쓰고 복원하시겠습니까? \n복원 후 앱이 재시작됩니다.",
                reset_confirm: "정말 모든 데이터를 초기화 하시겠습니까?",
                theme_dark: "Dark 🌙",
                theme_light: "Light ☀️",
                backup_data: "💾 데이터 백업 (.json)",
                load_data: "📂 데이터 불러오기",
                reset_data: "⚠️ 초기화",
                check_update: "🔄 업데이트 확인",
                app_info: "앱 정보",
                curr_ver: "현재 최신 버전입니다.",
                word_detail: "단어 상세 정보",
                dict_search: "📖 사전 검색",
                graph_title: "📈 성적 변화 추이",
                no_data_graph: "데이터 부족",
                need_more_exam: "시험을 2회 이상 봐야 그래프가 생성됩니다.",
                lang_manage_title: "언어 추가/관리",
                lang_manage_desc: "국기를 클릭하여 학습 언어를 추가하세요.",
                close: "닫기",
                lang_status_on: "활성됨 (ON)",
                lang_status_off: "숨김 (OFF)",
                lang_status_add: "추가하기",
                lang_select: "선택됨",
                times: "회차",
                score_suffix: "점",
                quiz_question: "문제",
                quiz_result: "결과",
                quiz_correct: "정답입니다! ⭕",
                quiz_correct1: "모두 정답입니다 ⭕",
                quiz_wrong: "오답입니다 ❌",
                quiz_next: "다음 (Next) ▶",
                quiz_finish_alert: "퀴즈 완료! 🎉\n정답률: {n}%",
                stat_min_try: "최소회독",
                stat_avg_acc: "평균정답",
                stat_weak: "취약",
                no_matching_word: "해당하는 단어가 없습니다.",
                recent_quiz: "최근 퀴즈",
                recent_mod: "최근 수정", update_found: "새로운 업데이트가 있습니다. 재시작 하시겠습니까?",
                update_checked: "업데이트를 확인했습니다.\n새 버전이 있다면 잠시 후 알림이 뜹니다.",
                update_fail: "업데이트 확인 실패: 오프라인 상태이거나 오류가 발생했습니다.",
                sw_unsupported: "이 브라우저는 앱 업데이트 기능을 지원하지 않습니다.",

                q_type_sel_l2m: "단어 보고 뜻 고르기",
                q_type_sel_m2l: "뜻 보고 단어 고르기",
                q_type_typ_spell: "철자 직접 입력하기",
                q_type_tts_dict: "발음 듣고 뜻 맞추기",
                q_type_j_sel_k2h: "단어 보고 읽는 법(가나)",
                q_type_j_sel_m2k: "뜻 보고 단어 고르기",
                q_type_j_typ_spell: "철자 직접 입력하기",
                q_type_j_wri_chk: "직접 손으로 써보기",

                self_check_hint: "종이에 쓰거나 생각해보세요.",
                check_answer: "정답 확인",
                submit: "확인",
                correct: "맞음",
                wrong: "틀림",
                input_placeholder: "정답 입력"
            },
            'en': {
                app_name: "PrismV",
                welcome_title: "Welcome!",
                welcome_desc: "Record your words and remember them perfectly.",
                start: "Get Started",
                import_data: "📂 Import Data",
                setup_lang: "Language Setup 🌐",
                setup_lang_desc: "Select your native and target languages.",
                mother_tongue: "Native Language",
                target_lang: "Add Target Language",
                setup_theme: "Theme Setup 🎨",
                setup_theme_desc: "Choose a comfortable mode.",
                preview: "Preview",
                finish_setup: "Finish Setup",
                dashboard: "Dashboard",
                settings: "Settings",
                my_learning_status: "My learning status",
                add_lang: "Add Language",
                total_words: "Words",
                accuracy: "Accuracy",
                review_status: "Review",
                exam_count: "Exams",
                today: "Today",
                days_ago: "{n} days ago",
                click_analyze: "Click to Analyze >",
                my_vocas: "My Vocabularies 📂",
                smart_group: "Smart Group (Auto)",
                smart_last_wrong: "Last Wrong",
                smart_freq_wrong: "Freq. Wrong (3+)",
                manage: "Edit",
                done: "Done",
                empty_group: "No groups created.<br>Tap + to add one.",
                empty_word: "No words here.<br>Tap '+' to add.",
                new_group_title: "Create Group 📁",
                new_group_desc: "Enter group name and description.",
                grp_name: "Group Name",
                grp_desc: "Description",
                create: "Create",
                cancel: "Cancel",
                save: "Save",
                save_cont: "Save & Next",
                word_new: "Add New Word",
                word_edit: "Edit Word",
                recent_quiz: "Last Quiz",
                recent_mod: "Last Edit",
                term: "Term",
                pron: "Pronunciation",
                mean: "Meaning",
                memo: "Memo (Example)",
                tags: "Tags",
                quiz_setup: "Quiz Setup 📝",
                tts_option: "🔊 Enable TTS",
                random_option: "🔀 Random (No Resume)",
                quiz_type_select: "Select Quiz Types",
                quiz_start: "Start New",
                quiz_cont: "Continue",
                quiz_start_idx: "Start from here",
                alert_input: "Please input Term and Meaning",
                confirm_del: "Are you sure?",
                restore_confirm: "Overwrite data and restore? App will restart.",
                reset_confirm: "Are you sure you want to reset all data?",
                update_found: "New update available. Reload now?",
                update_checked: "Checked for updates.\nYou will be notified if a new version exists.",
                update_fail: "Update check failed. Offline or error occurred.",
                sw_unsupported: "This browser does not support app updates.",
                theme_dark: "Dark 🌙",
                theme_light: "Light ☀️",
                backup_data: "💾 Backup Data",
                load_data: "📂 Import Data",
                reset_data: "⚠️ Reset All",
                check_update: "🔄 Check Update",
                app_info: "App Info",
                curr_ver: "You are up to date.",
                word_detail: "Word Details",
                dict_search: "📖 Dictionary",
                graph_title: "📈 Progress (Scrollable)",
                no_data_graph: "Not Enough Data",
                need_more_exam: "Take at least 2 exams to see the graph.",
                lang_manage_title: "Manage Languages",
                lang_manage_desc: "Click flags to add/remove languages.",
                stat_min_try: "Min Tries",
                stat_avg_acc: "Avg Acc.",
                stat_weak: "Weak",
                no_matching_word: "No matching words found.",
                close: "Close",
                lang_status_on: "Active (ON)",
                lang_status_off: "Hidden (OFF)",
                lang_status_add: "Add",
                lang_select: "Selected",
                times: "th",
                score_suffix: "pts",
                quiz_question: "Question",
                quiz_result: "Result",
                quiz_correct: "Correct! ⭕",

                quiz_correct1: "All Correct⭕",
                quiz_wrong: "Wrong ❌",
                quiz_next: "Next ▶",
                quiz_finish_alert: "Quiz Completed! 🎉\nAccuracy: {n}%",

                q_type_sel_l2m: "Term -> Meaning",
                q_type_sel_m2l: "Meaning -> Term",
                q_type_typ_spell: "Type Spelling",
                q_type_tts_dict: "Listen & Guess",
                q_type_j_sel_k2h: "Term -> Reading (Kana)",
                q_type_j_sel_m2k: "Meaning -> Term",
                q_type_j_typ_spell: "Type Spelling",
                q_type_j_wri_chk: "Handwriting Check",

                self_check_hint: "Write it down or think about it.",
                check_answer: "Check Answer",
                submit: "Submit",
                correct: "Correct",
                wrong: "Wrong",
                input_placeholder: "Input Answer"
            },
            'ja': {
                app_name: "PrismV",
                welcome_title: "ようこそ!",
                welcome_desc: "単語を記録して、完璧に覚えましょう。",
                start: "始める",
                import_data: "📂 データを読み込む",
                setup_lang: "言語設定 🌐",
                setup_lang_desc: "母国語と学習する言語を選択してください。",
                mother_tongue: "母国語",
                target_lang: "学習言語を追加",
                setup_theme: "テーマ設定 🎨",
                setup_theme_desc: "見やすいモードを選択してください。",
                preview: "プレビュー",
                finish_setup: "設定完了",
                my_learning_status: "学習現況",
                dashboard: "ダッシュボード",
                settings: "設定",
                add_lang: "言語追加",
                total_words: "単語数",
                accuracy: "正答率",
                review_status: "復習",
                exam_count: "試験回数",
                today: "今日",
                days_ago: "{n}日前",
                click_analyze: "分析を見る >",
                my_vocas: "私の単語帳 📂",
                smart_group: "スマートグループ (Auto)",
                smart_last_wrong: "直前の誤答",
                smart_freq_wrong: "苦手単語 (3回+)",
                manage: "編集",
                done: "完了",
                recent_quiz: "最近のクイズ",
                recent_mod: "最近の修正",
                empty_group: "単語帳がありません。<br>+ボタンで追加してください。",
                empty_word: "単語がありません。<br>'+'ボタンで追加してください。",
                new_group_title: "単語帳を作成 📁",
                new_group_desc: "単語帳の名前と説明を入力してください。",
                update_found: "新しいアップデートがあります。再起動しますか？",
                update_checked: "アップデートを確認しました。\n新しいバージョンがあれば通知されます。",
                update_fail: "確認に失敗しました。オフラインかエラーが発生しました。",
                sw_unsupported: "このブラウザはアプリの更新をサポートしていません。",
                grp_name: "単語帳名",
                grp_desc: "説明 (任意)",
                create: "作成",
                cancel: "キャンセル",
                save: "保存",
                save_cont: "保存して継続",
                word_new: "単語追加",
                word_edit: "単語編集",
                term: "単語/表現",
                pron: "発音",
                mean: "意味",
                memo: "メモ (例文)",
                tags: "タグ",
                quiz_setup: "クイズ設定 📝",
                tts_option: "🔊 音声(TTS)を聞く",
                random_option: "🔀 ランダム (継続不可)",
                quiz_type_select: "出題タイプ選択",
                quiz_start: "最初から",
                quiz_cont: "続きから",
                quiz_start_idx: "ここから開始",
                alert_input: "単語と意味を入力してください",
                confirm_del: "削除しますか？",
                restore_confirm: "データを上書きして復元しますか？アプリが再起動します。",
                reset_confirm: "本当にすべてのデータを初期化しますか？",
                theme_dark: "Dark 🌙",
                theme_light: "Light ☀️",
                backup_data: "💾 バックアップ",
                load_data: "📂 データ読込",
                reset_data: "⚠️ 初期化",
                check_update: "🔄 更新確認",
                app_info: "アプリ情報",
                curr_ver: "最新バージョンです。",
                word_detail: "単語詳細",
                dict_search: "📖 辞書検索",
                graph_title: "📈 成績推移 (スクロール)",
                no_data_graph: "データ不足",
                need_more_exam: "グラフ表示には2回以上の試験が必要です。",
                lang_manage_title: "言語管理",
                lang_manage_desc: "国旗をクリックして言語を追加します。",
                close: "閉じる",
                lang_status_on: "有効 (ON)",
                lang_status_off: "非表示 (OFF)",
                stat_min_try: "最小回読",
                stat_avg_acc: "平均正答",
                stat_weak: "弱点",
                no_matching_word: "該当する単語がありません。",
                lang_status_add: "追加",
                lang_select: "選択済み",
                times: "回目",
                score_suffix: "点",
                quiz_question: "問題",
                quiz_result: "結果",
                quiz_correct: "正解です! ⭕",
                quiz_correct1: "全正解 ⭕",
                quiz_wrong: "不正解 ❌",
                quiz_next: "次へ ▶",
                quiz_finish_alert: "クイズ終了! 🎉\n正答率: {n}%",
                q_type_sel_l2m: "単語 -> 意味",
                q_type_sel_m2l: "意味 -> 単語",
                q_type_typ_spell: "スペル入力",
                q_type_tts_dict: "聞いて当てる",
                q_type_j_sel_k2h: "漢字 -> 読み方",
                q_type_j_sel_m2k: "意味 -> 単語",
                q_type_j_typ_spell: "スペル入力",
                q_type_j_wri_chk: "手書きチェック",
                self_check_hint: "紙に書くか、頭で考えてください。",
                check_answer: "答え合わせ",
                submit: "確認",
                correct: "正解",
                wrong: "不正解",
                input_placeholder: "答えを入力"
            },
            'zh': {
                app_name: "PrismV",
                welcome_title: "欢迎!",
                welcome_desc: "记录单词，完美记忆。",
                start: "开始",
                import_data: "📂 导入数据",
                setup_lang: "语言设置 🌐",
                setup_lang_desc: "选择母语和学习语言。",
                mother_tongue: "母语",
                target_lang: "添加学习语言",
                setup_theme: "主题设置 🎨",
                setup_theme_desc: "选择舒适的模式。",
                preview: "预览",
                finish_setup: "完成设置",
                dashboard: "仪表盘",
                settings: "设置",
                my_learning_status: "学习现状",
                add_lang: "添加语言",
                total_words: "单词数",
                accuracy: "正确率",
                review_status: "复习",
                exam_count: "测验次数",
                today: "今天",
                days_ago: "{n}天前",
                click_analyze: "点击分析 >",
                my_vocas: "我的词汇本 📂",
                smart_group: "智能分组 (Auto)",
                smart_last_wrong: "上次错题",
                smart_freq_wrong: "常错单词 (3+)",
                manage: "管理",
                done: "完成",
                empty_group: "没有词汇本。<br>点击+按钮添加。",
                empty_word: "没有单词。<br>点击'+'添加。",
                new_group_title: "创建词汇本 📁",
                new_group_desc: "输入名称和说明。",
                stat_min_try: "最少阅读",
                stat_avg_acc: "平均正确",
                stat_weak: "弱项",
                no_matching_word: "没有找到对应的单词。",
                update_found: "发现新版本。是否重新加载？",
                update_checked: "已检查更新。\n如果有新版本，稍后会通知您。",
                update_fail: "检查失败。离线或发生错误。",
                sw_unsupported: "此浏览器不支持应用更新。",
                grp_name: "名称",
                grp_desc: "说明",
                create: "创建",
                cancel: "取消",
                save: "保存",
                recent_quiz: "最近测验",
                recent_mod: "最近修改",
                save_cont: "保存并继续",
                word_new: "添加单词",
                word_edit: "编辑单词",
                term: "单词/表达",
                pron: "发音",
                mean: "含义",
                memo: "备注 (例句)",
                tags: "标签",
                quiz_setup: "测验设置 📝",
                tts_option: "🔊 启用语音 (TTS)",
                random_option: "🔀 随机顺序 (不可继续)",
                quiz_type_select: "选择题型",
                quiz_start: "从头开始",
                quiz_cont: "继续上次",
                quiz_start_idx: "从这里开始",
                alert_input: "请输入单词和含义",
                confirm_del: "确定删除吗？",
                restore_confirm: "恢复数据？应用将重启。",
                reset_confirm: "确定要重置所有数据吗？",
                theme_dark: "深色 🌙",
                theme_light: "浅色 ☀️",
                backup_data: "💾 备份数据",
                load_data: "📂 导入数据",
                reset_data: "⚠️ 重置所有",
                check_update: "🔄 检查更新",
                app_info: "应用信息",
                curr_ver: "已是最新版本。",
                word_detail: "单词详情",
                dict_search: "📖 查词典",
                graph_title: "📈 成绩趋势 (可滚动)",
                no_data_graph: "数据不足",
                need_more_exam: "至少考试2次才能显示图表。",
                lang_manage_title: "语言管理",
                lang_manage_desc: "点击国旗添加或移除语言。",
                close: "关闭",
                lang_status_on: "已启用 (ON)",
                lang_status_off: "已隐藏 (OFF)",
                lang_status_add: "添加",
                lang_select: "已选择",
                times: "次",
                score_suffix: "分",
                quiz_question: "问题",
                quiz_result: "结果",
                quiz_correct: "回答正确! ⭕",

                quiz_correct1: "全正确⭕",
                quiz_wrong: "回答错误 ❌",
                quiz_next: "下一题 ▶",
                quiz_finish_alert: "测验结束! 🎉\n正确率: {n}%",
                q_type_sel_l2m: "看词选义",
                q_type_sel_m2l: "看义选词",
                q_type_typ_spell: "拼写输入",
                q_type_tts_dict: "听音辨义",
                q_type_j_sel_k2h: "看词选读音",
                q_type_j_sel_m2k: "看义选词",
                q_type_j_typ_spell: "拼写输入",
                q_type_j_wri_chk: "手写自测",
                self_check_hint: "请在纸上书写或思考答案。",
                check_answer: "检查答案",
                submit: "提交",
                correct: "正确",
                wrong: "错误",
                input_placeholder: "输入答案"
            },
            'es': {
                app_name: "PrismV",
                welcome_title: "¡Bienvenido!",
                welcome_desc: "Graba tus palabras, recuérdalas perfectamente.",
                start: "Empezar",
                import_data: "📂 Importar Datos",
                setup_lang: "Configuración 🌐",
                setup_lang_desc: "Elige tu lengua materna y objetivo.",
                mother_tongue: "Lengua Materna",
                target_lang: "Añadir Idioma",
                setup_theme: "Tema 🎨",
                setup_theme_desc: "Elige un modo cómodo.",
                preview: "Vista Previa",
                finish_setup: "Terminar",
                dashboard: "Tablero",
                settings: "Ajustes",
                my_learning_status: "Estado de aprendizaje",
                add_lang: "Añadir",
                total_words: "Palabras",
                accuracy: "Precisión",
                review_status: "Repaso",
                exam_count: "Exámenes",
                today: "Hoy",
                days_ago: "Hace {n} días",
                click_analyze: "Analizar >",
                my_vocas: "Mis Vocabularios 📂",
                smart_group: "Grupo Inteligente",
                smart_last_wrong: "Último Error",
                smart_freq_wrong: "Frecuente (3+)",
                manage: "Editar",
                done: "Listo",
                empty_group: "No hay grupos.<br>Toca + para añadir.",
                empty_word: "No hay palabras.<br>Toca '+' para añadir.",
                new_group_title: "Crear Grupo 📁",
                new_group_desc: "Introduce nombre y descripción.",
                update_found: "Nueva actualización disponible. ¿Recargar ahora?",
                update_checked: "Buscando actualizaciones.\nSe le notificará si existe una nueva versión.",
                update_fail: "Error al buscar actualizaciones. Sin conexión o error.",
                sw_unsupported: "Este navegador no admite actualizaciones de aplicaciones.",
                grp_name: "Nombre",
                grp_desc: "Descripción",
                create: "Crear",
                cancel: "Cancelar",
                save: "Guardar",
                recent_quiz: "Último Quiz",
                recent_mod: "Última Edición",
                save_cont: "Guardar y Seguir",
                word_new: "Añadir Palabra",
                word_edit: "Editar Palabra",
                term: "Término",
                pron: "Pronunciación",
                mean: "Significado",
                memo: "Memo (Ejemplo)",
                tags: "Etiquetas",
                quiz_setup: "Config. Quiz 📝",
                tts_option: "🔊 Activar TTS",
                random_option: "🔀 Aleatorio (No Resume)",
                quiz_type_select: "Tipos de Pregunta",
                quiz_start: "Empezar",
                quiz_cont: "Continuar",
                quiz_start_idx: "Empezar aquí",
                alert_input: "Por favor, introduce término y significado",
                confirm_del: "¿Estás seguro?",
                restore_confirm: "¿Sobrescribir datos y restaurar? Se reiniciará.",
                reset_confirm: "¿Estás seguro de restablecer todo?",
                theme_dark: "Oscuro 🌙",
                theme_light: "Claro ☀️",
                stat_min_try: "Intentos",
                stat_avg_acc: "Promedio",
                stat_weak: "Débil",
                no_matching_word: "No se encontraron palabras.",
                backup_data: "💾 Copia de Seguridad",
                load_data: "📂 Importar",
                reset_data: "⚠️ Restablecer",
                check_update: "🔄 Actualizar",
                app_info: "Info App",
                curr_ver: "Está actualizado.",
                word_detail: "Detalles",
                dict_search: "📖 Diccionario",
                graph_title: "📈 Progreso (Desplazable)",
                no_data_graph: "Faltan Datos",
                need_more_exam: "Realiza al menos 2 exámenes.",
                lang_manage_title: "Gestionar Idiomas",
                lang_manage_desc: "Haz clic en las banderas para añadir.",
                close: "Cerrar",
                lang_status_on: "Activo (ON)",
                lang_status_off: "Oculto (OFF)",
                lang_status_add: "Añadir",
                lang_select: "Seleccionado",
                times: "º",
                score_suffix: " pts",
                quiz_question: "Pregunta",
                quiz_result: "Resultado",
                quiz_correct: "¡Correcto! ⭕",
                quiz_correct1: "Eso es todo⭕",
                quiz_wrong: "Incorrecto ❌",
                quiz_next: "Siguiente ▶",
                quiz_finish_alert: "¡Quiz Completado! 🎉\nPrecisión: {n}%",
                q_type_sel_l2m: "Término -> Significado",
                q_type_sel_m2l: "Significado -> Término",
                q_type_typ_spell: "Escribir",
                q_type_tts_dict: "Escuchar",
                q_type_j_sel_k2h: "Lectura (Kana)",
                q_type_j_sel_m2k: "Significado -> Término",
                q_type_j_typ_spell: "Escribir",
                q_type_j_wri_chk: "Escritura a mano",
                self_check_hint: "Escríbelo o piénsalo.",
                check_answer: "Comprobar",
                submit: "Enviar",
                correct: "Correcto",
                wrong: "Incorrecto",
                input_placeholder: "Escribe la respuesta"
            }
        };

        /* --- 번역 헬퍼 함수 (통합 및 수정됨) --- */
        function t(key, params = {}) {
            // 1. 현재 설정된 언어 가져오기 (기본값 ko)
            const lang = (appData && appData.config && appData.config.sysLang) ? appData.config.sysLang : 'ko';

            // 2. 해당 언어에 키가 없으면 -> 영어 -> 한국어 -> 키 자체 순으로 폴백
            let text = TRANSLATIONS[lang]?.[key] ||
                TRANSLATIONS['en']?.[key] ||
                TRANSLATIONS['ko']?.[key] ||
                key;

            // 3. {n} 형태의 파라미터 치환
            Object.keys(params).forEach(p => {
                text = text.replace(`{${p}}`, params[p]);
            });
            return text;
        }


        // --- Core Constants ---
        const STORE_KEY = "prism_voca_data_v2";
        // 지원 언어 목록 (엄격한 사전 연동을 위해 제한)
        const SUPPORTED_LANGS = {
            'ko': { name: '한국어', flag: '\uD83C\uDDF0\uD83C\uDDF7', url: 'https://ko.dict.naver.com/#/search?query=' }, // 🇰🇷 (KR)
            'en': { name: 'English', flag: '\uD83C\uDDFA\uD83C\uDDF8', url: 'https://en.dict.naver.com/#/search?query=' }, // 🇺🇸 (US)
            'ja': { name: '日本語', flag: '\uD83C\uDDEF\uD83C\uDDF5', url: 'https://ja.dict.naver.com/#/search?query=' }, // 🇯🇵 (JP)
            'es': { name: 'Español', flag: '\uD83C\uDDEA\uD83C\uDDF8', url: 'https://dict.naver.com/esko/search?query=' }, // 🇪🇸 (ES)
            'zh': { name: '中文', flag: '\uD83C\uDDE8\uD83C\uDDF3', url: 'https://zh.dict.naver.com/#/search?query=' }  // 🇨🇳 (CN)
        };

        // --- [데이터 추가] 퀴즈 타입 및 설정 정의 ---
        // 기존 SUPPORTED_LANGS에 quizConfig 속성을 확장합니다. (기존 코드 아래에 덮어쓰기 로직 추가)

        const QUIZ_TYPES = {
            // 1. 공통/영어권 유형
            SEL_L2M: { id: 'sel_l2m', label: '단어 보고 뜻 고르기', tts: false },
            SEL_M2L: { id: 'sel_m2l', label: '뜻 보고 단어 고르기', tts: false },
            TYP_SPELL: { id: 'typ_spell', label: '스펠링 직접 입력하기', tts: false },
            TTS_DICT: { id: 'tts_dict', label: '발음 듣고 뜻 맞추기', tts: true },

            // 2. 일본어 전용 유형
            J_SEL_K2H: { id: 'j_sel_k2h', label: '단어 보고 읽는 법 고르기', tts: false },
            J_SEL_M2K: { id: 'j_sel_m2k', label: '뜻 보고 단어 고르기', tts: false },
            J_TYP_SPELL: { id: 'j_typ_spell', label: '철자 직접 입력하기', tts: false },
            J_WRI_CHK: { id: 'j_wri_chk', label: '직접 손으로 써보기', tts: false }
        };

        // 언어별 지원 퀴즈 매핑
        const LANG_QUIZ_MAP = {
            'ko': [QUIZ_TYPES.SEL_L2M, QUIZ_TYPES.SEL_M2L, QUIZ_TYPES.TTS_DICT], // 한국어 학습시
            'en': [QUIZ_TYPES.SEL_L2M, QUIZ_TYPES.SEL_M2L, QUIZ_TYPES.TYP_SPELL, QUIZ_TYPES.TTS_DICT],
            'es': [QUIZ_TYPES.SEL_L2M, QUIZ_TYPES.SEL_M2L, QUIZ_TYPES.TYP_SPELL, QUIZ_TYPES.TTS_DICT],
            'zh': [QUIZ_TYPES.SEL_L2M, QUIZ_TYPES.SEL_M2L, QUIZ_TYPES.TTS_DICT, QUIZ_TYPES.J_TYP_SPELL], // 중국어
            'ja': [QUIZ_TYPES.J_SEL_K2H, QUIZ_TYPES.J_SEL_M2K, QUIZ_TYPES.SEL_L2M, QUIZ_TYPES.TTS_DICT, QUIZ_TYPES.J_WRI_CHK, QUIZ_TYPES.J_TYP_SPELL],
            'default': [QUIZ_TYPES.SEL_L2M, QUIZ_TYPES.SEL_M2L, QUIZ_TYPES.TTS_DICT]
        };

        let quizSourceData = null;

        // 퀴즈 상태 전역 변수
        let quizSession = {
            active: false,
            queue: [],      // 문제로 출제될 단어들
            cursor: 0,      // 현재 몇 번째인지
            correctCnt: 0,
            config: {},     // { useTTS, types, ... }
            currentQType: null
        };

        // --- Global State ---
        let appData = {
            config: { theme: 'dark', sysLang: 'ko', setupDone: false },
            myLangs: [], // Example: [{code: 'ja', id: 1}, {code: 'en', id: 2}]
            groups: [],  // { id, langId, title, type: 'date'|'custom'|'auto', createdAt }
            words: []    // { id, groupId, term, mean, ... , correctCount, wrongCount }
        };

        let currentTab = 'home'; // 'home', 'settings', or langId (e.g. 1, 2)
        let currentGroupId = null; // 그룹 내부 진입 시 ID

        // --- Global State ---
        let currentSmartView = null; // { mode: 'tag'|'wrong_last'|'wrong_freq', value: '...' }
        let isGroupManageMode = false;

        // --- Initialization ---
        // --- Initialization ---
        window.onload = () => {
            loadData();

            // [추가] 앱 시작 시 초기 히스토리 상태 정의 (Depth 0: Home)
            history.replaceState({ level: 0, view: 'home' }, null, '');

            if (!appData.config.setupDone) {
                initSetup();
            } else {
                renderApp();
            }
        };

        // [신규] 뒤로가기 버튼 처리 핸들러 (Central Back Button Logic)
        window.onpopstate = (event) => {
            // 1. 활성화된 모달이 있다면 닫기 (UI 처리만 수행)
            const activeModal = document.querySelector('.modal-overlay.active');
            if (activeModal) {
                // history.back()을 호출하지 않고 직접 닫기만 수행 (이미 back 되어 state가 빠졌으므로)
                activeModal.classList.add('closing');
                activeModal.classList.remove('active');
                setTimeout(() => {
                    activeModal.classList.remove('closing');
                    activeModal.style.display = '';
                    activeModal.style.opacity = '';
                }, 300);
                return;
            }

            // 2. 퀴즈 화면이 켜져있다면 닫기
            const quizScreen = document.getElementById('quiz-screen');
            if (quizScreen && quizScreen.style.display === 'flex') {
                quizScreen.style.display = 'none';
                quizSession.active = false;
                // 퀴즈 종료 로직은 필요시 exitQuiz 내부 로직 참조하되 UI만 닫음
                renderApp();
                return;
            }

            // 3. 뷰 상태 복원 (History State 기반)
            if (event.state) {
                const state = event.state;

                // 상태 변수 동기화
                if (state.view === 'home') {
                    currentTab = 'home';
                    currentGroupId = null;
                    currentSmartView = null;
                    isManageMode = false;
                    isGroupManageMode = false;
                } else if (state.view === 'lang') {
                    currentTab = state.tabId;
                    currentGroupId = null;
                    currentSmartView = null;
                    isManageMode = false;
                } else if (state.view === 'group') {
                    currentGroupId = state.groupId;
                    isManageMode = false;
                } else if (state.view === 'smart') {
                    currentSmartView = state.data;
                }

                // 화면 갱신
                renderApp();
            } else {
                // State가 없다면 홈으로
                currentTab = 'home';
                currentGroupId = null;
                renderApp();
            }
        };

        function loadData() {
            const raw = localStorage.getItem(STORE_KEY);
            if (raw) appData = JSON.parse(raw);
            else {
                // 기본값 없음, 초기 상태
            }
            // 테마 적용
            applyTheme(appData.config.theme);
        }

        function saveData() {
            localStorage.setItem(STORE_KEY, JSON.stringify(appData));
        }

        function finishSetup() {
            // (기존 코드와 동일, 데이터 초기화 부분만 조정)
            appData.config.setupDone = true;
            saveData();
            document.getElementById('setup-popup').classList.remove('active');
            renderApp();
        }

        function applyTheme(theme) { /* 기존 CSS 클래스 토글 로직 유지 */
            document.body.className = theme === 'light' ? 'light-mode' : 'dark-mode';
        }

        // --- Main Render Controller ---
        function renderApp() {
            renderSideNav();
            renderMainContent();
        }

        // --- [UI] Side Navigation (ShiftV Style) ---
        // --- [수정] Side Navigation Render ---
        /* --- renderSideNav 수정 --- */
        function renderSideNav() {
            const nav = document.getElementById('app-nav-bar');

            let html = `
        <button class="tab-button ${currentTab === 'home' ? 'active' : ''}" onclick="navigate('home')">
            <div class="tab-icon-area"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>
            <span class="tab-label">${t('dashboard')}</span>
        </button>
    `;

            appData.myLangs.forEach(lang => {
                if (lang.isVisible === false) return;
                const info = SUPPORTED_LANGS[lang.code];
                const isActive = currentTab == lang.id ? 'active' : '';
                html += `
        <button class="tab-button ${isActive}" onclick="navigate(${lang.id})">
            <div class="tab-icon-area">${info.flag}</div>
            <span class="tab-label">${info.name}</span>
        </button>`;
            });

            html += `
        <div style="flex:1;"></div> 
        
        <button class="tab-button" onclick="openAddLangModal()" style="color:var(--accent);">
            <div class="tab-icon-area"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg></div>
            <span class="tab-label">${t('add_lang')}</span>
        </button>
        
        <button class="tab-button ${currentTab === 'settings' ? 'active' : ''}" onclick="navigate('settings')">
            <div class="tab-icon-area">
                <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.91,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.57,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </div>
            <span class="tab-label">${t('settings')}</span>
        </button>
    `;
            nav.innerHTML = html;
        }

        /* --- [JS 수정] 언어 추가 모달 (번역 적용) --- */
        function openAddLangModal() {
            const modalId = 'modal-add-lang';
            const container = document.getElementById('flag-selection-area');
            if (!container) return;

            // 헤더 타이틀
            const headerTitle = document.querySelector('#modal-add-lang h3');
            if (headerTitle) headerTitle.innerText = t('lang_manage_title');

            // [추가] 모달 설명 텍스트 번역
            const desc = document.querySelector('#modal-add-lang .desc');
            if (desc) desc.innerText = t('lang_manage_desc');

            // [추가] 닫기 버튼 텍스트 번역
            const closeBtn = document.querySelector('#modal-add-lang .glass-btn');
            if (closeBtn) closeBtn.innerText = t('close');

            let html = '';
            Object.keys(SUPPORTED_LANGS).forEach(code => {
                const langInfo = SUPPORTED_LANGS[code];
                const existingLang = appData.myLangs.find(my => my.code === code);
                const isAdded = !!existingLang;
                const isVisible = existingLang ? existingLang.isVisible : false;

                let cardStyle = '';
                let statusText = t('lang_status_add');
                let statusColor = 'var(--accent)';

                if (isAdded && isVisible) {
                    cardStyle = 'border: 2px solid var(--primary); background: rgba(255, 143, 205, 0.1);';
                    statusText = t('lang_status_on');
                    statusColor = 'var(--primary)';
                } else if (isAdded && !isVisible) {
                    cardStyle = 'border: 1px dashed var(--text-dim); opacity: 0.6;';
                    statusText = t('lang_status_off');
                    statusColor = 'var(--text-dim)';
                }

                html += `
        <div class="flag-option" style="${cardStyle}; width:100%; margin:0;" onclick="toggleLang('${code}')">
            <div class="flag-icon">${langInfo.flag}</div>
            <div class="flag-name" style="font-weight:bold; margin-top:5px;">${langInfo.name}</div>
            <div style="font-size:0.8rem; color:${statusColor}; margin-top:2px;">${statusText}</div>
        </div>`;
            });

            container.innerHTML = html;
            openModalWithAnim(modalId);
        }



        // --- [수정] 언어 토글 로직 (Issue 3 해결) ---
        function toggleLang(code) {
            const existingIndex = appData.myLangs.findIndex(my => my.code === code);

            if (existingIndex > -1) {
                // 이미 존재함 -> visibility 토글
                // (주의: 기존 데이터 appData.myLangs의 요소에 isVisible 속성이 없을 수 있으므로 체크)
                const currentVisibility = appData.myLangs[existingIndex].isVisible !== false; // 기본값 true 취급

                // 상태 반전
                appData.myLangs[existingIndex].isVisible = !currentVisibility;

            } else {
                // 새로 추가
                appData.myLangs.push({
                    id: Date.now(),
                    code: code,
                    createdAt: Date.now(),
                    isVisible: true // 기본적으로 보임
                });
            }

            saveData();
            openAddLangModal(); // 상태 반영을 위해 모달 다시 그리기 (혹은 UI만 업데이트)
            renderSideNav();    // 사이드바 갱신
        }

        function navigate(target) {
            // 이미 같은 탭이면 무시
            if (currentTab === target && !currentGroupId && !currentSmartView) return;

            currentTab = target;
            currentGroupId = null;
            currentSmartView = null;

            // 모바일 FAB 처리
            const fab = document.getElementById('main-fab');
            if (typeof target === 'number' && currentGroupId) fab.style.transform = 'scale(1)';
            else fab.style.transform = 'scale(0)';

            // [수정] 히스토리 스택 추가
            if (target === 'home' || target === 'settings') {
                // 홈이나 설정은 Level 0으로 취급하거나, 탭 간 이동으로 봅니다.
                // 여기서는 단순화를 위해 홈으로 갈때는 pushState하여 뒤로가기시 이전 탭으로 가거나,
                // UI 구조상 탭 전환은 replaceState가 나을 수 있으나, 요청하신 '하이라키' 구조를 위해 pushState 사용
                history.pushState({ level: 1, view: target === 'home' ? 'home' : 'settings' }, null, '');
            } else {
                // 언어 탭 진입 (Level 1)
                history.pushState({ level: 1, view: 'lang', tabId: target }, null, '');
            }

            renderApp();
        }

        // --- [UI] Main View Controller ---
        function renderMainContent() {
            const viewArea = document.getElementById('main-view-area');

            if (currentTab === 'home') return renderHomeDashboard(viewArea);
            if (currentTab === 'settings') return renderSettings(viewArea);
            if (typeof currentTab === 'number') return renderLanguageView(viewArea, currentTab);
        }

        /* renderSettings 함수 전체를 이 코드로 교체하세요 */

        /* --- renderSettings 수정 --- */
        function renderSettings(container) {
            const isDark = appData.config.theme === 'dark';
            const logoSrc = getLogoSrc(); // 로고 경로

            let darkBtnStyle = '';
            let lightBtnStyle = '';

            const transition = "transition: all 0.3s ease;";

            // 스타일 정의
            if (isDark) {
                darkBtnStyle = `
            flex:1; 
            background: rgba(81, 81, 187, 0.1); 
            color: rgba(255, 255, 255, 0.9); 
            border: 3px solid rgba(81, 81, 187, 0.1); ${transition}
        `;
                lightBtnStyle = `
            flex:1; 
            background: rgba(81, 81, 187, 0.2); 
            color: rgba(255, 255, 255, 0.9); 
            border: 1px solid rgba(81, 81, 187, 0.3); ${transition}
        `;
            } else {
                darkBtnStyle = `
            flex:1; 
            background: rgba(255, 156, 207, 0.1); 
            color: rgba(0, 0, 0, 0.8); 
            border: 1px solid rgba(255, 156, 207, 0.3); ${transition}
        `;
                lightBtnStyle = `
            flex:1; 
            background: rgba(255, 205, 231, 0.1); 
            color: rgba(0, 0, 0, 0.8); 
            border: 2px solid rgba(255, 205, 231, 0.3); ${transition}
        `;
            }

            // [핵심 수정] 가장 바깥쪽을 감싸는 <div> 추가 (width: 100% 및 column 정렬 강제)
            container.innerHTML = `
    <div style="width: 100%; display: flex; flex-direction: column;">
        <div class="logo-container">
            <img src="${logoSrc}" class="app-logo" id="logo-main" alt="PrismV Logo">
        </div>
        <h2 style="margin:0;">${t('settings')} ⚙️</h2>
        
        <div class="glass-card" style="margin-bottom: 20px;">
            <h3>${t('setup_lang')}</h3>
            <label style="display:block; margin-bottom:5px; color:var(--text-dim);">${t('mother_tongue')}</label>
            <select id="setting-sys-lang" onchange="updateSysLang(this.value)">
                <option value="ko">한국어 (Korean)</option>
                <option value="en">English</option>
                <option value="ja">日本語</option>
                <option value="zh">中文 (Chinese)</option>
                <option value="es">Español (Spanish)</option>
            </select>

            <label style="display:block; margin-top:15px; margin-bottom:10px; color:var(--text-dim);">${t('setup_theme')}</label>
            <div style="display:flex; gap:10px;">
                <button class="glass-btn" onclick="changeTheme('dark')" style="${darkBtnStyle}">${t('theme_dark')}</button>
                <button class="glass-btn" onclick="changeTheme('light')" style="${lightBtnStyle}">${t('theme_light')}</button>
            </div>
        </div>

        <div class="glass-card" style="margin-bottom: 20px;">
            <h3>${t('backup_data')}</h3>
            <button class="glass-btn primary" onclick="downloadBackup()">${t('backup_data')}</button>
            <button class="glass-btn" onclick="triggerImport()">${t('load_data')}</button>
            <input type="file" id="file-import" style="display:none;" onchange="importData(this)">
            
            <!-- 업데이트 버튼 수정: 실제 SW 업데이트 체크 함수 호출 -->
            <button class="glass-btn" onclick="checkAppUpdate()" style="margin-top:15px; border-color:var(--primary);">${t('check_update')}</button>
            <hr style="border:0; border-top:1px solid var(--glass-border); margin:15px 0;">
            <button class="glass-btn" onclick="resetData()" style="color:var(--danger); border-color:var(--danger);">${t('reset_data')}</button>
        </div>

         <div class="glass-card">
            <h3>${t('app_info')}</h3>
            <div style="display:flex; flex-direction:column; align-items:center; gap:5px; margin-bottom:15px; text-align:center;">
                <img src="${logoSrc}" class="app-logo large" id="logo-settings-info">
                <div>
                    <div style="font-size:1.4rem; font-weight:800;">${t('app_name')}</div>
                    <div style="font-size:0.9rem; opacity:0.6;">Ver 1.0.2</div>
                </div>
            </div>
            <p class="desc" style="margin-bottom:0; text-align:center;">
                ${t('welcome_desc')}
            </p>
        </div>
        <div style="height:120px; width:100%;"></div>
    </div>`;

            setTimeout(() => {
                const sel = document.getElementById('setting-sys-lang');
                if (sel) sel.value = appData.config.sysLang;
            }, 50);
        }

        function updateSysLang(lang) {
            appData.config.sysLang = lang;
            saveData();

            // 만약 설정이 완료된 상태라면 앱 전체 리렌더링
            if (appData.config.setupDone) {
                renderApp();
            } else {
                // 설정 중이라면 모달 내용만 새로고침 (언어 반영)
                renderSetupModal();
            }
        }

        // 데이터 백업
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "PrismV_Backup_" + new Date().toISOString().slice(0, 10) + ".json");
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        // 데이터 불러오기 (트리거)
        function triggerImport() {
            document.getElementById('file-import').click();
        }

        // 파일 읽기
        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (confirm(t('restore_confirm'))) {
                        appData = json;
                        saveData();
                        location.reload();
                    }
                } catch (err) {
                    alert("File Error");
                }
            };
            reader.readAsText(file);
        }

        function changeTheme(mode) {
            appData.config.theme = mode;
            saveData();
            applyTheme(mode); // CSS 테마 적용

            // [핵심 추가] 로고 이미지 실시간 교체
            const newLogoSrc = getLogoSrc();
            const logos = document.querySelectorAll('.app-logo');
            logos.forEach(img => {
                img.src = newLogoSrc;
            });

            // 설정 화면의 버튼 스타일 갱신을 위해 재 렌더링
            if (currentTab === 'settings') {
                const container = document.getElementById('main-view-area');
                renderSettings(container);
            }
        }

        // 현재 테마에 맞는 로고 경로 반환
        function getLogoSrc() {
            // 다크 모드일 때: 배경이 어두우므로 밝은 로고(PrismV_dark.png)를 쓴다고 가정 (파일명 규칙에 따름)
            // 혹은 파일명이 반대라면(다크모드용 이미지가 dark.png라면) 아래 경로를 사용
            return appData.config.theme === 'dark'
                ? './Asset/PrismV_dark.png'   // Dark Theme용 이미지
                : './Asset/PrismV_light.png'; // Light Theme용 이미지
        }

        // 1. Home View (ShiftV Widgets Style)
        /* --- renderHomeDashboard 수정 --- */
        /* --- [JS 수정] renderHomeDashboard (UI 그룹화 개선) --- */
        function renderHomeDashboard(container) {
            let langStatsHTML = '';

            appData.myLangs.forEach(lang => {
                if (lang.isVisible === false) return;

                const info = SUPPORTED_LANGS[lang.code];
                const wordsInLang = appData.words.filter(w => w.langId === lang.id);
                const totalW = wordsInLang.length;

                let totalRate = 0;
                let ratedCount = 0;
                wordsInLang.forEach(w => {
                    if (w.stats && w.stats.total > 0) {
                        totalRate += Math.round(((w.stats.total - w.stats.wrong) / w.stats.total) * 100);
                        ratedCount++;
                    }
                });
                const avgAcc = ratedCount > 0 ? Math.round(totalRate / ratedCount) : 0;

                const groupsInLang = appData.groups.filter(g => g.langId === lang.id);
                let examCount = 0;
                let lastDate = 0;

                groupsInLang.forEach(g => {
                    if (g.quizHistory) examCount += g.quizHistory.length;
                    if (g.lastQuizDate && g.lastQuizDate > lastDate) lastDate = g.lastQuizDate;
                });

                let dDayStr = t('days_ago', { n: 0 });
                if (lastDate > 0) {
                    const diff = Date.now() - lastDate;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    dDayStr = days === 0 ? t('today') : t('days_ago', { n: days });
                } else {
                    dDayStr = '-';
                }

                // [UI 개선] .lang-stat-grid에 배경색과 패딩을 추가하여 정보 그룹핑
                langStatsHTML += `
        <div class="glass-card" onclick="openLangAnalysisModal(${lang.id})" style="cursor:pointer; padding:20px; transition:0.2s;">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
                <div style="font-size:2.2rem;">${info.flag}</div>
                <div>
                    <div style="font-size:1.2rem; font-weight:800; line-height:1.2;">${info.name}</div>
                    <div style="font-size:0.75rem; opacity:0.6; margin-top:2px;">${t('click_analyze')}</div>
                </div>
            </div>
            
            <!-- 정보 그룹핑 박스 (배경 추가) -->
            <div class="lang-stat-grid" style="background:var(--bg-dimbox); border-radius:12px; padding:15px; row-gap:10px;">
                <div class="lang-stat-item">
                    <span class="lang-stat-label" style="font-size:0.9rem; font-weight:500;">${t('total_words')}</span>
                    <span class="lang-stat-value" style="font-size:0.9rem; font-weight:700;">${totalW}</span>
                </div>
                <div class="lang-stat-item">
                    <span class="lang-stat-label" style="font-size:0.9rem; font-weight:500;">${t('accuracy')}</span>
                    <span class="lang-stat-value" style="font-size:0.9rem; color:${avgAcc >= 80 ? '#4CAF50' : (avgAcc < 50 ? '#FF5577' : 'var(--accent)')}">${avgAcc}%</span>
                </div>
                <div class="lang-stat-item">
                    <span class="lang-stat-label" style="font-size:0.9rem; font-weight:500;">${t('review_status')}</span>
                    <span class="lang-stat-value" style="font-size:0.9rem; font-weight:700;">${dDayStr}</span>
                </div>
                <div class="lang-stat-item">
                     <span class="lang-stat-label" style="font-size:0.9rem; font-weight:500;">${t('exam_count')}</span>
                     <span class="lang-stat-value" style="font-size:0.9rem; font-weight:700;">${examCount}</span>
                </div>
            </div>
        </div>`;
            });

            const addCardHTML = `
        <div class="stat-widget glass-card" onclick="openAddLangModal()" style="cursor:pointer; border:2px dashed var(--accent); background:transparent; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:10px; min-height:220px;">
            <div style="font-size:2.5rem; color:var(--accent); opacity:0.5;">+</div>
            <div class="stat-label1" style="font-size:0.9rem;">${t('add_lang')}</div>
        </div>
    `;

            const logoSrc = getLogoSrc();

            container.innerHTML = `
        <div class="logo-container">
            <img src="${logoSrc}" class="app-logo" id="logo-main" alt="PrismV Logo">
        </div>

        <h2>${t('my_learning_status')}</h2>
        
        <div class="dashboard-responsive-grid">
            ${langStatsHTML}
            ${addCardHTML}
        </div>
    `;
        }

        function renderRecentWordsList() {
            const recents = [...appData.words].sort((a, b) => b.created - a.created).slice(0, 5);
            if (recents.length === 0) return `<p class="desc">아직 추가된 단어가 없습니다.</p>`;

            let html = `<div class="glass-card">`;
            recents.forEach(w => {
                const langName = SUPPORTED_LANGS[getCodeByLangId(w.langId)].flag;
                html += `<div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between;">
            <span>${langName} <b>${w.term}</b></span>
            <span style="opacity:0.7">${w.mean}</span>
         </div>`;
            });
            return html + `</div>`;
        }




        // --- [NEW] Analysis Features ---

        /* --- [JS 수정] 언어 분석 모달 (전체 로직 포함 + 오류 해결) --- */
        /* --- [JS 수정] openLangAnalysisModal (점수 단위 "점" 해결) --- */
        function openLangAnalysisModal(langId) {
            const lang = appData.myLangs.find(l => l.id === langId);
            const words = appData.words.filter(w => w.langId === langId);
            const groups = appData.groups.filter(g => g.langId === langId);

            // 1. 태그 통계
            const tagStats = {};
            words.forEach(w => {
                if (w.tags && w.tags.length > 0) {
                    const correct = w.stats ? (w.stats.total - w.stats.wrong) : 0;
                    const total = w.stats ? w.stats.total : 0;
                    w.tags.forEach(t => {
                        if (!tagStats[t]) tagStats[t] = { correct: 0, total: 0, count: 0 };
                        tagStats[t].correct += correct;
                        tagStats[t].total += total;
                        tagStats[t].count++;
                    });
                }
            });

            const tagList = Object.keys(tagStats).map(t => {
                const d = tagStats[t];
                const rate = d.total > 0 ? Math.round((d.correct / d.total) * 100) : 0;
                return { tag: t, rate: rate };
            }).sort((a, b) => b.rate - a.rate);

            let tagHtml = `<div class="progress-btn-container" style="margin-bottom:30px;">`;
            if (tagList.length === 0) tagHtml += `<p class="desc" style="text-align:center;">${t('no_data_graph')}</p>`;
            else {
                tagList.forEach(item => {
                    const color = item.rate < 60 ? 'var(--danger)' : 'var(--primary)';
                    tagHtml += `
            <div class="progress-btn" onclick="
                closeModal('modal-analysis');
                navigate(${langId});
                setTimeout(() => { enterSmartGroup('tag', '${item.tag}') }, 100);
            ">
                <div class="progress-bg-bar" style="width:${item.rate}%; background:${color};"></div>
                <div class="progress-content">
                    <span style="font-weight:600;">#${item.tag}</span>
                    <span class="progress-rate">${item.rate}%</span>
                </div>
            </div>`;
                });
            }
            tagHtml += `</div>`;

            // 2. 그룹 리스트
            let groupHtml = `<div class="progress-btn-container">`;
            if (groups.length === 0) groupHtml += `<p class="desc" style="text-align:center;">${t('empty_group')}</p>`;
            else {
                groups.sort((a, b) => (a.lastQuizDate || 0) - (b.lastQuizDate || 0));
                groups.forEach(g => {
                    const gWords = words.filter(w => w.groupId === g.id);
                    let totalRate = 0, ratedCnt = 0;
                    gWords.forEach(w => {
                        if (w.stats && w.stats.total > 0) {
                            totalRate += ((w.stats.total - w.stats.wrong) / w.stats.total);
                            ratedCnt++;
                        }
                    });
                    const acc = ratedCnt > 0 ? Math.round((totalRate / ratedCnt) * 100) : 0;
                    let dDay = 'New';
                    if (g.lastQuizDate) {
                        const diff = Date.now() - g.lastQuizDate;
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        dDay = days === 0 ? t('today') : t('days_ago', { n: days });
                    }

                    const barWidth = acc > 0 ? acc : 0;
                    groupHtml += `
            <div class="progress-btn" onclick="closeModal('modal-analysis'); openGroupStatsModal('${g.id}');">
                <div class="progress-bg-bar" style="width:${barWidth}%; background:linear-gradient(90deg, transparent 0%, rgba(255, 100, 193, 0.8) 100%);"></div>
                <div class="progress-content">
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span style="font-size:0.95rem;">${g.title}</span>
                        <span style="font-size:0.7rem; opacity:0.7;">${dDay} • ${Math.floor(g.quizHistory?.length || 0)} ${t('exam_count')}</span>
                    </div>
                    <span class="progress-rate">${acc}%</span>
                </div>
            </div>`;
                });
            }
            groupHtml += `</div>`;

            // 3. 히스토리
            let allHistory = [];
            groups.forEach(g => {
                if (g.quizHistory && g.quizHistory.length > 0) {
                    g.quizHistory.forEach(h => {
                        allHistory.push({
                            groupId: g.id,
                            groupTitle: g.title,
                            date: h.date,
                            score: h.score,
                            wrongWords: h.wrongWords
                        });
                    });
                }
            });
            allHistory.sort((a, b) => b.date - a.date);

            let historyHtml = `<div style="display:flex; flex-direction:column;">`;
            if (allHistory.length === 0) historyHtml += `<p class="desc" style="text-align:center;">No History.</p>`;
            else {
                allHistory.slice(0, 20).forEach(h => {
                    const d = new Date(h.date);
                    const dateStr = `${d.getMonth() + 1}.${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                    const scoreColor = h.score >= 80 ? 'var(--primary)' : 'var(--text-dim)';

                    // [수정] 점수 뒤에 "점" 대신 번역된 suffix 사용
                    historyHtml += `
            <div class="history-item" onclick="closeModal('modal-analysis'); openGroupStatsModal('${h.groupId}', ${h.date});">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:0.75rem; color:var(--accent); font-weight:bold;">${h.groupTitle}</span>
                    <span style="font-size:0.85rem; color:var(--text-dim); margin-top:2px;">${dateStr}</span>
                </div>
                <div style="font-size:1.1rem; font-weight:bold; color:${scoreColor};">${h.score}${t('score_suffix')}</div>
            </div>`;
                });
            }
            historyHtml += `</div>`;

            let modal = document.getElementById('modal-analysis');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-analysis';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
    <div class="modal-panel">
        <div class="modal-sticky-header">
             <button onclick="closeModal('modal-analysis')" class="back-icon-btn" style="background:transparent; border:none; font-size:1.2rem;">✕</button>
             <h3 style="margin:0; font-size:1.1rem;" class="liquid-text-gradient">${SUPPORTED_LANGS[lang.code].name} Analysis</h3>
             <button onclick="navigate(${langId}); closeModal('modal-analysis');" class="back-icon-btn" style="transform: rotate(180deg);">←</button>
        </div>
        
        <div class="modal-scroll-body">
            <div style="margin-bottom:30px;">
                <h4 style="margin:0 0 10px 5px; color:var(--text-dim); font-size:0.9rem;">🔖 ${t('tags')} Analysis</h4>
                ${tagHtml}
            </div>

            <div style="margin-bottom:30px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:0 5px;">
                     <span style="color:var(--text-dim); font-size:0.9rem; font-weight:bold;">📂 ${t('review_status')}</span>
                </div>
                ${groupHtml}
            </div>
            
            <div style="margin-bottom:20px;">
                 <h4 style="margin:0 0 10px 5px; color:var(--text-dim); font-size:0.9rem;">📝 ${t('exam_count')} History</h4>
                 ${historyHtml}
            </div>
            <div style="height:50px;"></div>
        </div>
    </div>`;

            openModalWithAnim('modal-analysis');
        }


        // [3. 모달] 그룹 통계: 그래프 클릭 시 하단에 정보 표시 (리퀴드 UI 적용)
        let currentGroupHistory = []; // 그래프 클릭 이벤트를 위해 임시 저장

        /* --- openGroupStatsModal 함수 교체 (애니메이션 수정 + 그래프 축 라벨 추가 + 라이트모드 가독성 해결) --- */
        function openGroupStatsModal(groupId, targetDate = null) {
            const group = appData.groups.find(g => String(g.id) === String(groupId));
            if (!group) return;

            // 히스토리 정렬 (날짜 오름차순)
            const history = (group.quizHistory || []).sort((a, b) => a.date - b.date);

            // 그래프 데이터 (최신 50개 제한 등은 선택사항)
            currentGroupHistory = history;

            // 초기 선택 인덱스
            let initialIndex = currentGroupHistory.length - 1;
            if (targetDate) {
                const foundIdx = currentGroupHistory.findIndex(h => h.date === targetDate);
                if (foundIdx !== -1) initialIndex = foundIdx;
            }

            // --- [그래프 설정] ---
            const pointGap = 60; // 점 사이 간격 (날짜 텍스트 공간 확보를 위해 넓힘)
            const minWidth = 340; // 화면 최소 너비
            // 데이터 개수에 맞춰 너비 계산 (좌우 패딩 40px 고려)
            const calculatedWidth = Math.max(minWidth, (currentGroupHistory.length * pointGap) + 80);

            const chartHeight = 250;
            const graphBottomY = 200; // 그래프가 그려지는 바닥 라인 (이 아래는 날짜 텍스트)
            const paddingX = 40;

            let chartHtml = '';

            if (currentGroupHistory.length < 2) {
                chartHtml = `
        <div class="glass-card" style="height:250px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.6; margin:20px 0;">
            <div style="font-size:2.5rem; margin-bottom:10px;">📉</div>
            <div>${t('no_data_graph')}</div>
            <div style="font-size:0.8rem; margin-top:5px;">${t('need_more_exam')}</div>
        </div>`;
            } else {
                // 평균 점수 계산
                let sum = 0; currentGroupHistory.forEach(h => sum += h.score);
                const avg = Math.round(sum / currentGroupHistory.length);

                // 좌표 데이터 생성
                const points = currentGroupHistory.map((rec, i) => {
                    // X좌표: 순서대로 배치
                    const x = paddingX + (i * pointGap);
                    // Y좌표: 점수(0~100)를 높이(graphBottomY ~ 20)에 매핑
                    // 100점이면 y=20, 0점이면 y=200
                    const y = graphBottomY - (rec.score * ((graphBottomY - 20) / 100));
                    return { x, y, ...rec };
                });

                const pathData = points.map(p => `${p.x},${p.y}`).join(" ");
                const suffix = t('score_suffix');

                // [핵심] 라이트모드/다크모드 모두 잘 보이게 CSS 변수(var(--text-dim)) 사용
                // X축: 날짜, Y축: 점수(정답률)
                chartHtml = `
        <div class="chart-wrapper" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
            <div style="width: ${calculatedWidth}px; height: ${chartHeight}px;">
                <svg viewBox="0 0 ${calculatedWidth} ${chartHeight}" style="width:100%; height:100%; overflow:visible;">
                    
                    <line x1="0" y1="20" x2="${calculatedWidth}" y2="20" class="chart-axis-line" stroke-dasharray="3" />
                    <text x="5" y="15" fill="var(--text-dim)" font-size="10" font-weight="bold">100${suffix}</text>
                    
                    <line x1="0" y1="${(graphBottomY + 20) / 2}" x2="${calculatedWidth}" y2="${(graphBottomY + 20) / 2}" class="chart-axis-line" stroke-dasharray="3" />
                    <text x="5" y="${(graphBottomY + 20) / 2 - 5}" fill="var(--text-dim)" font-size="10">50${suffix}</text>
                    
                    <line x1="0" y1="${graphBottomY}" x2="${calculatedWidth}" y2="${graphBottomY}" class="chart-axis-line" />
                    <text x="5" y="${graphBottomY - 5}" fill="var(--text-dim)" font-size="10">0${suffix}</text>

                    <line x1="0" y1="${graphBottomY - (avg * ((graphBottomY - 20) / 100))}" x2="${calculatedWidth}" y2="${graphBottomY - (avg * ((graphBottomY - 20) / 100))}" 
                          stroke="var(--accent)" stroke-width="1.5" stroke-dasharray="5,3" opacity="0.5" />

                    <polyline points="${pathData}" class="chart-line-path" fill="none" />

                    ${points.map((p, idx) => {
                    const d = new Date(p.date);
                    const dateStr = `${d.getMonth() + 1}.${d.getDate()}`;
                    return `
                        <text x="${p.x}" y="${graphBottomY + 20}" fill="var(--text-dim)" font-size="10" text-anchor="middle">${dateStr}</text>
                        <circle cx="${p.x}" cy="${p.y}" r="20" fill="transparent" cursor="pointer" onclick="displayHistoryDetail(${idx})" />
                        <circle cx="${p.x}" cy="${p.y}" r="${idx === initialIndex ? 6 : 3}" 
                                class="chart-dot ${idx === initialIndex ? 'selected' : ''}" id="dot-${idx}" 
                                onclick="displayHistoryDetail(${idx})" 
                                style="fill:${idx === initialIndex ? 'var(--accent)' : 'var(--bg-main)'}; stroke:${idx === initialIndex ? '#fff' : 'var(--primary)'}; stroke-width:2px;" />
                        `;
                }).join('')}
                </svg>
            </div>
        </div>
        
        <div id="chart-detail-view" class="detail-view-container" style="min-height:100px;"></div>
        `;
            }

            let modal = document.getElementById('modal-group-stats');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-group-stats';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
    <div class="modal-panel">
        <div class="modal-sticky-header">
             <button onclick="closeModal('modal-group-stats'); openLangAnalysisModal(${group.langId});" class="back-icon-btn">←</button>
             <h3 style="margin:0; font-size:1.1rem; flex:1; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${group.title}</h3>
             <button onclick="closeModal('modal-group-stats')" class="back-icon-btn" style="background:transparent; border:none;">✕</button>
        </div>

        <div class="modal-scroll-body">
            <h4 style="margin:10px 0 5px 5px; color:var(--text-dim); font-size:0.9rem;">${t('graph_title')}</h4>
            ${chartHtml}
            <div style="height:30px;"></div>
        </div>
    </div>`;

            openModalWithAnim('modal-group-stats');

            if (currentGroupHistory.length > 0) {
                setTimeout(() => {
                    displayHistoryDetail(initialIndex);
                    const wrapper = modal.querySelector('.chart-wrapper');
                    if (wrapper) {
                        wrapper.scrollLeft = (initialIndex * 60) - (wrapper.clientWidth / 2) + 40;
                    }
                }, 150);
            }
        }



        /* --- [JS 수정] displayHistoryDetail (회차/점수 번역) --- */
        function displayHistoryDetail(index) {
            const data = currentGroupHistory[index];
            const container = document.getElementById('chart-detail-view');
            if (!data || !container) return;

            document.querySelectorAll('.chart-dot').forEach(el => el.classList.remove('selected'));
            const selectedDot = document.getElementById(`dot-${index}`);
            if (selectedDot) selectedDot.classList.add('selected');

            const d = new Date(data.date);
            const dateStr = `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;

            let wrongHtml = '';
            if (data.wrongWords && data.wrongWords.length > 0) {
                const wrongList = appData.words.filter(w => data.wrongWords.includes(w.id));
                wrongHtml = wrongList.map(w => `
            <div class="wrong-item-row">
                <div>
                    <span style="color:var(--text-main); font-weight:bold;">${w.term}</span>
                    <span style="font-size:0.8rem; color:var(--text-dim); margin-left:5px;">${w.mean}</span>
                </div>
                <button onclick="openDictWindow('${w.term}', getCodeByLangId(${w.langId}))" 
                        class="dict-btn" style="padding:4px 8px; font-size:0.7rem;">${t('dict_search')}</button>
            </div>
        `).join('');
            } else {
                wrongHtml = `<div style="text-align:center; padding:20px; color:#4CAF50; font-weight:bold;">🎉 ${t('quiz_correct1')}</div>`;
            }

            // [수정] 회차 및 점수 단위 번역 적용
            // 예: 12.26 (1회차) / (1st)
            container.innerHTML = `
        <div class="detail-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid var(--glass-border); padding-bottom:10px;">
                <span style="font-size:0.9rem; color:var(--text-dim);">${dateStr} (${index + 1}${t('times')})</span>
                <span style="font-size:1.2rem; font-weight:800; color:var(--primary);">${data.score}${t('score_suffix')}</span>
            </div>
            <div style="max-height:150px; overflow-y:auto;">
                ${wrongHtml}
            </div>
        </div>
    `;
        }



        /* --- [JS 수정] renderLanguageView (다국어 적용) --- */
        function renderLanguageView(container, langId) {
            if (currentGroupId) {
                return renderGroupDetail(container, langId, currentGroupId);
            }
            if (currentSmartView) {
                return renderSmartGroupDetail(container, langId);
            }

            container.classList.remove('no-scroll');

            const myLang = appData.myLangs.find(l => l.id === langId);
            if (!myLang) return;

            const langInfo = SUPPORTED_LANGS[myLang.code];

            const fab = document.getElementById('main-fab');
            fab.style.transform = 'scale(1)';
            fab.onclick = () => openCreateGroupModal(langId);

            // 태그 데이터 집계
            const wordsInLang = appData.words.filter(w => w.langId === langId);
            const tagCounts = {};
            wordsInLang.forEach(w => {
                if (w.tags && Array.isArray(w.tags)) {
                    w.tags.forEach(t => {
                        const cleanTag = t.trim();
                        if (cleanTag) tagCounts[cleanTag] = (tagCounts[cleanTag] || 0) + 1;
                    });
                }
            });

            let autoGroupHTML = `
        <div class="glass-card stat-widget" onclick="enterSmartGroup('wrong_last', null)" style="cursor:pointer; padding:15px; aspect-ratio:1/1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
             <div style="font-size:2rem; margin-bottom:5px;">💊</div>
             <div class="stat-label">${t('smart_last_wrong')}</div>
        </div>
        <div class="glass-card stat-widget" onclick="enterSmartGroup('wrong_freq', null)" style="cursor:pointer; padding:15px; aspect-ratio:1/1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
             <div style="font-size:2rem; margin-bottom:5px;">🔥</div>
             <div class="stat-label">${t('smart_freq_wrong')}</div>
        </div>
    `;

            Object.keys(tagCounts).forEach(tag => {
                autoGroupHTML += `
        <div class="glass-card stat-widget" onclick="enterSmartGroup('tag', '${tag}')" style="cursor:pointer; padding:15px; aspect-ratio:1/1; display:flex; flex-direction:column; justify-content:center; align-items:center; border:1px solid var(--glass-border);">
             <div style="font-size:1.5rem; color:var(--text-main); margin-bottom:5px;">#</div>
             <div class="stat-widget-content">
                <div style="font-weight:bold; font-size:1rem;">${tag}</div>
                <div style="font-size:0.8rem; opacity:0.7;">(${tagCounts[tag]})</div>
             </div>
        </div>`;
            });

            const manageBtnText = isGroupManageMode ? t('done') : t('manage');
            const manageBtnClass = isGroupManageMode ? "manage-btn active" : "manage-btn";
            const logoSrc = getLogoSrc();

            container.innerHTML = `
        <header style="margin-top:10px; margin-bottom:20px; padding:0 10px; text-align:center;">
            <div class="logo-container">
                <img src="${logoSrc}" class="app-logo" id="logo-main" alt="PrismV Logo">
            </div>
            
            <div style="text-align:left;">
                <div style="font-size:0.9rem; color:var(--text-dim); margin-bottom:5px;">Language</div>
                <h1 style="margin:0; font-size:1.8rem;">${langInfo.flag} ${langInfo.name}</h1>
            </div>
        </header>

        <h3 style="margin: 30px 0 10px 10px; color:var(--accent);">${t('smart_group')}</h3>
        <div class="smart-group-grid">
             ${autoGroupHTML}
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin: 40px 10px 10px 10px;">
            <h3 style="margin:0; color:var(--text-main);">${t('my_vocas')}</h3>
            <button onclick="toggleGroupManageMode(${langId})" class="${manageBtnClass}">${manageBtnText}</button>
        </div>
        
        <div id="group-list-area" class="my-vocab-list">
             ${renderGroupListNew(langId)}
        </div>
    `;
        }

        // --- [JS 추가] 2. enterSmartGroup 함수 정의 (누락 방지) ---
        // 이 함수가 없어서 ReferenceError가 발생했습니다. 명시적으로 추가합니다.
        function enterSmartGroup(mode, value) {
            currentSmartView = { mode, value };

            // [수정] 스마트 그룹 진입 (Level 2)
            history.pushState({ level: 2, view: 'smart', data: { mode, value } }, null, '');

            renderApp();
        }



        /* --- [JS 수정] renderGroupDetail (변수 누락 수정 완료) --- */
        function renderGroupDetail(container, langId, groupId) {
            container.classList.add('no-scroll');

            const fab = document.getElementById('main-fab');
            fab.style.transform = 'scale(1)';
            fab.onclick = () => openAddWordModal();

            const group = appData.groups.find(g => g.id === groupId);
            if (!group) {
                currentGroupId = null;
                return renderLanguageView(container, langId);
            }

            const wordsInGroup = appData.words.filter(w => w.groupId === groupId);
            const displayList = [...wordsInGroup];
            const langInfo = SUPPORTED_LANGS[getCodeByLangId(langId)];

            // 통계 계산
            let stats = { total: displayList.length, tries: 0, wrong: 0, acc: 0 };
            if (displayList.length > 0) {
                const triesArr = displayList.map(w => w.stats ? w.stats.total : 0);
                stats.tries = Math.min(...triesArr);
                let sT = 0, sW = 0;
                displayList.forEach(w => {
                    if (w.stats) {
                        sT += w.stats.total;
                        if ((w.stats.wrong || 0) >= 3) stats.wrong++;
                        sW += w.stats.wrong || 0;
                    }
                });
                if (sT > 0) stats.acc = Math.round(((sT - sW) / sT) * 100);
            }

            const fmtDate = (ts) => {
                if (!ts) return '-';
                const d = new Date(ts);
                return `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, '0')}.${String(d.getDate()).padStart(2, '0')}`;
            };

            const dateCreated = fmtDate(group.createdAt);

            // [버그 수정] 누락되었던 변수 정의 복구
            const dateQuiz = group.lastQuizDate ? fmtDate(group.lastQuizDate) : '-';
            const dateMod = group.modifiedAt ? fmtDate(group.modifiedAt) : dateCreated;

            const manageBtnText = isManageMode ? t('done') : t('manage');
            const manageBtnClass = isManageMode ? "manage-btn active" : "manage-btn";

            let startBtnHTML = '';
            if (displayList.length > 0 && !isManageMode) {
                startBtnHTML = `<button onclick="startQuizFromIndex('${groupId}', 0)" class="play-all-btn">▶ Play All</button>`;
            }

            let html = `
    <div id="sticky-header" class="fixed-header-layer">
        <div class="header-card-inner layout-container">
            <div class="top-row" style="margin-bottom:10px;">
                <button onclick="history.back()" class="back-icon-btn">←</button>
                <div class="header-title-area" style="text-align:left;">
                     <div class="header-subtitle" style="font-size:0.8rem; color:var(--accent);">${langInfo.name} | ${dateCreated}</div>
                     <div class="main-title" style="font-size:1.4rem;">
                        ${group.title}
                        <button class="title-edit-btn" onclick="editGroupTitle('${groupId}')">✎</button>
                     </div>
                </div>
                ${startBtnHTML}
            </div>

            <div class="stats-wrapper" style="margin-bottom:0;">
                <div class="stats-dashboard" style="border-bottom-left-radius:0; border-bottom-right-radius:0; border-bottom:none;">
                    <div class="stat-item"><span class="stat-label">${t('total_words')}</span><span class="stat-value" style="font-size:1.2rem;">${stats.total}</span></div>
                    <div class="stat-item"><span class="stat-label">${t('exam_count')}</span><span class="stat-value" style="font-size:1.2rem; color:var(--text-main);">${stats.tries}</span></div>
                    <div class="stat-item"><span class="stat-label">${t('accuracy')}</span><span class="stat-value" style="font-size:1.2rem; color:#4CAF50;">${stats.acc}%</span></div>
                    <div class="stat-item"><span class="stat-label">Weak</span><span class="stat-value" style="font-size:1.2rem; color:var(--danger);">${stats.wrong}</span></div>
                </div>
                <div style="display:flex; justify-content:space-around; align-items:center; background:rgba(0,0,0,0.03); border:1px solid var(--glass-border); border-top:none; border-radius:0 0 12px 12px; padding:8px 5px;">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-size:0.75rem; opacity:0.6; margin-bottom:2px;">📝 ${t('recent_quiz')}</span> 
                        <span style="color:var(--text-main); font-weight:600; font-size:0.9rem;">${dateQuiz}</span>
                    </div>
                    <div style="width:1px; height:20px; background:var(--glass-border);"></div>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-size:0.75rem; opacity:0.6; margin-bottom:2px;">✍️ ${t('recent_mod')}</span> 
                        <span style="color:var(--text-main); font-weight:600; font-size:0.9rem;">${dateMod}</span>
                    </div>
                </div>
                
                <button onclick="openGroupStatsModal('${groupId}')" 
                        style="width:100%; margin-top:0; padding:10px; background:var(--glass-bg); border:1px solid var(--glass-border); border-top:none; border-radius:0 0 12px 12px; color:var(--text-main); font-size:0.9rem; font-weight:600; cursor:pointer;">
                    ${t('click_analyze')}
                </button>
            </div>
        </div>
    </div>

    <div id="scroll-area" class="scroll-content-area">
        <div id="header-spacer" style="width:100%; height:280px;"></div> 

        <div id="word-items-list" class="layout-container" style="padding-bottom:100px;">
            <div class="list-toolbar">
                <button onclick="toggleManageMode()" class="${manageBtnClass}">${manageBtnText}</button>
            </div>
    `;

            if (displayList.length === 0) {
                html += `<p style="text-align:center; padding:50px; opacity:0.5;">${t('empty_word')}</p>`;
            } else {
                const itemClass = isManageMode ? "managing" : "";

                displayList.forEach((w, idx) => {
                    const ttsCode = getCodeByLangId(langId);
                    const listNum = idx + 1;

                    html += `
             <div class="word-item ${itemClass}" id="${w.id}" data-index="${idx}" data-type="word" 
                  style="border-radius:15px; margin-bottom:10px; border:1px solid var(--glass-border); display:flex; align-items:center; padding: 15px;">
                 
                 <div style="width:15px; flex-shrink:0; display:flex; align-items:center; justify-content:center;">
                    ${isManageMode
                            ? `<div class="drag-handle" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="dropItem(event)" ontouchstart="touchStart(event)" ontouchmove="touchMove(event)" ontouchend="touchEnd(event)">≡</div>`
                            : `<div class="item-number" style="font-size:1rem; color:var(--text-dim);">${listNum}</div>`
                        }
                 </div>

                 <div class="word-content" onclick="openWordDetail(${w.id})" style="flex:1; margin-left:5px; cursor:pointer;">
                     <div class="word-row-main" style="color:var(--text-main); font-weight:600; line-height:1.2;">
                        ${w.term} <span class="word-pron" style="font-weight:normal; color:var(--accent); margin-left:5px;">${w.pron || ''}</span>
                     </div>
                     <div class="word-row-sub" style="opacity:0.8; margin-top:2px;">${w.mean}</div>
                 </div>
                 
                 <div class="icon-actions" style="display:flex; gap:10px;">
                    ${isManageMode
                            ? `<button class="btn-icon-text" style="font-size:1.2rem; padding:5px;" onclick="editWord(${w.id})">✎</button>
                       <button class="delete-btn-x" onclick="deleteWord(${w.id})">✕</button>`
                            : `<button class="icon-btn play-sound" onclick="speak('${w.term}','${ttsCode}')">🔊</button>
                       <button class="dict-btn" onclick="openDictWindow('${w.term}','${ttsCode}')">Dic</button>
                       <button class="quiz-start-btn" onclick="startQuizFromIndex('${groupId}', ${idx})" title="${t('quiz_start_idx')}">▶</button>`
                        }
                 </div>
             </div>`;
                });
            }

            html += `</div></div>`;
            container.innerHTML = html;

            setTimeout(() => {
                const hCard = document.querySelector('.header-card-inner');
                if (hCard) document.getElementById('header-spacer').style.height = (hCard.offsetHeight + 20) + 'px';
            }, 50);

            const scrollEl = document.getElementById('scroll-area');
            const headerLayer = document.getElementById('sticky-header');
            if (scrollEl && headerLayer) {
                scrollEl.onscroll = () => {
                    if (scrollEl.scrollTop > 30) headerLayer.classList.add('shrunk');
                    else headerLayer.classList.remove('shrunk');
                };
            }
        }



        /* --- [JS 수정] renderGroupListNew (다국어 적용) --- */
        function renderGroupListNew(langId) {
            let groups = appData.groups.filter(g => g.langId === langId);

            if (groups.length === 0) return `<p class="desc" style="text-align:center; margin-top:20px;">${t('empty_group')}</p>`;

            let html = '';
            groups.forEach((g, idx) => {
                const count = appData.words.filter(w => w.groupId === g.id).length;
                const d = new Date(g.createdAt);
                const dateStr = `${d.getMonth() + 1}.${d.getDate()}`;

                let dDayHtml = '';
                if (g.lastQuizDate && !isGroupManageMode) {
                    const diff = Date.now() - g.lastQuizDate;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

                    let text = "";
                    let color = "var(--text-dim)";

                    if (days === 0) {
                        text = `${t('today')} ${t('review_status')}`;
                        color = "#4CAF50";
                    } else {
                        text = `${t('days_ago', { n: days })} ${t('review_status')}`;
                        if (days >= 7) color = "var(--accent)";
                        if (days >= 30) color = "var(--danger)";
                    }

                    dDayHtml = `<span style="font-size:0.8rem; color:${color}; font-weight:600; margin-right:5px;">${text}</span>`;
                }

                const cursorStyle = isGroupManageMode ? "default" : "pointer";

                html += `
        <div class="glass-card vocab-card" 
             style="margin-bottom:12px; cursor:${cursorStyle}; display:flex; align-items:center; padding: 15px;"
             onclick="${isGroupManageMode ? '' : `enterGroup('${g.id}')`}"
             data-index="${idx}" data-type="group">
             
             ${isGroupManageMode
                        ? `<div class="drag-handle" style="margin-right:15px;" draggable="true" ondragstart="dragStart(event)" ondragover="dragOver(event)" ondrop="dropItem(event)" ontouchstart="touchStart(event)" ontouchmove="touchMove(event)" ontouchend="touchEnd(event)">≡</div>`
                        : ``
                    }

             <div style="flex:1;">
                <div style="font-size:1.1rem; font-weight:bold; margin-bottom:4px;">${g.title}</div>
                <div style="font-size:0.85rem; color:var(--text-dim);">
                    <span>${dateStr}</span> • <span style="color:var(--primary);">${count} ${t('total_words')}</span>
                </div>
             </div>

             <div style="display:flex; align-items:center; gap:10px;">
                ${isGroupManageMode
                        ? `<button class="btn-icon-text" style="font-size:1rem;" onclick="editGroup('${g.id}')">✎</button>
                       <button class="delete-btn-x" onclick="deleteGroup('${g.id}')">✕</button>`
                        : `${dDayHtml}<div style="color:var(--accent); font-size:1.5rem; opacity:0.5;">›</div>`
                    }
             </div>
        </div>`;
            });
            return html;
        }

        // [JS 추가] 그룹 생성 모달 열기
        let tempCreateLangId = null;

        /* --- [JS 수정] 단어장 생성 모달 (다국어 렌더링 적용) --- */
        function openCreateGroupModal(langId) {
            if (!langId) {
                if (typeof currentTab === 'number') langId = currentTab;
                else return alert("Please select a language.");
            }
            tempCreateLangId = langId;

            const today = new Date();
            const defaultTitle = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()} ${t('review_status')}`;

            const modalPanel = document.querySelector('#modal-create-group .modal-panel');

            modalPanel.innerHTML = `
        <div class="modal-sticky-header">
            <button onclick="closeModal('modal-create-group')" class="back-icon-btn" style="border:none; background:none;">✕</button>
            <h3 style="margin:0; font-size:1.1rem;">${t('new_group_title')}</h3>
            <div style="width:40px;"></div>
        </div>

        <div class="modal-scroll-body">
            <div style="text-align:center; margin: 10px 0 30px 0;">
                <div style="font-size:3rem; margin-bottom:10px;">📁</div>
                <p class="desc" style="margin:0;">${t('new_group_desc')}</p>
            </div>

            <div class="glass-card" style="padding:20px; margin-bottom:20px;">
                <div class="input-group">
                    <span class="input-label" style="margin-left:2px;">${t('grp_name')}</span>
                    <input type="text" id="inp-group-title" placeholder="${defaultTitle}" style="margin-bottom:15px;">
                </div>

                <div class="input-group" style="margin-bottom:0;">
                    <span class="input-label" style="margin-left:2px;">${t('grp_desc')}</span>
                    <input type="text" id="inp-group-desc" placeholder="Day 1" style="margin-bottom:0;">
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="glass-btn primary" onclick="submitCreateGroup()" style="height:50px; font-size:1rem;">${t('create')}</button>
                <button class="glass-btn" onclick="closeModal('modal-create-group')" style="height:50px;">${t('cancel')}</button>
            </div>
            <div class="modal-footer-gap"></div>
        </div>
    `;

            openModalWithAnim('modal-create-group');
            setTimeout(() => {
                const inp = document.getElementById('inp-group-title');
                if (inp) inp.focus();
            }, 150);
        }

        function submitCreateGroup() {
            if (!tempCreateLangId) return;

            const input = document.getElementById('inp-group-title');
            const inputDesc = document.getElementById('inp-group-desc'); // [추가]

            let title = input.value.trim();
            let desc = inputDesc ? inputDesc.value.trim() : ''; // [추가] 설명 가져오기

            if (!title) {
                title = input.placeholder;
            }

            const newGroup = {
                id: Date.now().toString(),
                langId: tempCreateLangId,
                title: title,
                description: desc, // [추가] 데이터에 저장
                type: 'custom',
                createdAt: Date.now()
            };

            appData.groups.push(newGroup);
            saveData();
            closeModal('modal-create-group');

            renderLanguageView(document.getElementById('main-view-area'), tempCreateLangId);
        }


        // [오류 해결] 상세 화면 헤더용 제목 수정 함수 추가
        function editGroupTitle(groupId) {
            // ID 타입을 문자로 통일하여 안전하게 찾기
            const group = appData.groups.find(g => String(g.id) === String(groupId));
            if (!group) return;

            // 이름 입력받기 (기본값: 현재 제목)
            const newTitle = prompt("단어장 이름을 수정하세요:", group.title);

            // 취소하지 않고 내용이 있을 때만 저장
            if (newTitle && newTitle.trim() !== "") {
                group.title = newTitle.trim();
                group.modifiedAt = Date.now(); // 수정된 날짜도 갱신

                saveData();  // 저장
                renderApp(); // 화면 갱신 (제목 변경 반영)
            }
        }

        // [신규] 그룹 이름 변경 (Prompt 사용, 단순 구현)
        function editGroup(groupId) {
            const group = appData.groups.find(g => g.id === groupId);
            if (!group) return;

            // 현재 이름(또는 날짜)을 default value로 보여줌
            const newTitle = prompt(t('edit_group'), group.title);
            if (newTitle && newTitle.trim() !== "") {
                group.title = newTitle;
                saveData();
                renderApp();
            }
        }

        // [신규] 그룹 삭제
        function deleteGroup(groupId) {
            if (!confirm(t('delete_confirm'))) return;

            // 그룹 내 단어 모두 삭제 (필요 시 유지하려면 로직 변경)
            appData.words = appData.words.filter(w => w.groupId !== groupId);
            // 그룹 삭제
            appData.groups = appData.groups.filter(g => g.id !== groupId);

            saveData();
            renderApp();
        }

        function addGroup(langId, type) {
            const title = type === 'date' ?
                new Date().toLocaleDateString() + " 학습" :
                prompt("새 단어장 이름 입력:");

            if (!title) return;

            appData.groups.push({
                id: Date.now().toString(),
                langId: langId,
                title: title,
                type: type, // 'date', 'list'
                createdAt: Date.now()
            });
            saveData();
            renderMainContent(); // refresh
        }

        function enterGroup(groupId) {
            if (isGroupManageMode) return;

            currentGroupId = groupId;
            document.getElementById('main-fab').style.transform = 'scale(1)';

            // [수정] 그룹 진입 (Level 2)
            history.pushState({ level: 2, view: 'group', groupId: groupId }, null, '');

            renderApp();
        }

        // 3. Group Detail View (단어 추가 및 목록)
        // --- [Global State 추가] 관리 모드 상태 변수 ---
        let isManageMode = false;





        // [JS 추가] 그룹 관리 모드 토글
        function toggleGroupManageMode(langId) {
            isGroupManageMode = !isGroupManageMode;
            const container = document.getElementById('main-view-area');
            // 화면만 갱신 (리렌더링)
            renderLanguageView(container, langId);
        }

        // [JS 추가] 그룹 순서 변경
        function moveGroup(groupId, direction) {
            // 1. 현재 언어 ID 찾기
            const targetGroup = appData.groups.find(g => g.id === groupId);
            if (!targetGroup) return;
            const currentLangId = targetGroup.langId;

            // 2. 전체 groups 배열에서 인덱스 찾기
            const idx = appData.groups.findIndex(g => g.id === groupId);
            if (idx === -1) return;

            // 3. 이동할 대상 인덱스 계산 (위로가면 -1, 아래로가면 +1)
            const targetIdx = idx + direction;

            // 4. 범위 체크 및 같은 언어 그룹끼리만 이동
            if (targetIdx < 0 || targetIdx >= appData.groups.length) return;

            // 단순히 배열에서만 바꾸면 다른 언어 그룹과 섞일 수 있으므로
            // "화면에 보이는 리스트" 상에서의 이동이 아니라 실제 데이터 배열에서의 이동을 처리해야 함.
            // 하지만 단순화를 위해 바로 옆 데이터와 스왑하되, 
            // UX적으로는 필터링된 뷰에서 움직이는 걸 기대하므로
            // 실제로는 전체 배열에서 `swap`을 수행합니다.

            // 데이터 스왑
            const temp = appData.groups[idx];
            appData.groups[idx] = appData.groups[targetIdx];
            appData.groups[targetIdx] = temp;

            saveData();
            // 화면 갱신
            renderLanguageView(document.getElementById('main-view-area'), currentLangId);
        }

        // [JS 보완] 그룹 진입 함수 (ID 타입 안전장치 추가)
        function enterGroup(groupId) {
            // 관리 모드일 때는 클릭 무시 (혹시 몰라 방어 코드)
            if (isGroupManageMode) return;

            currentGroupId = groupId; // 문자열 상태 유지
            document.getElementById('main-fab').style.transform = 'scale(1)';
            renderApp();
        }





        // --- [Group Detail] Actions ---

        function exitGroup() {
            history.back();
        }

        function toggleManageMode() {
            isManageMode = !isManageMode;
            renderApp(); // 리렌더링해서 UI 반영

        }

        // [핵심] 단어 순서 이동 (Swap Logic)
        function moveWord(wordId, direction) {
            // wordId는 숫자일수도 문자일수도 있으니 매칭 주의
            const wordIdNum = Number(wordId);

            // 전체 word 리스트에서 이 그룹의 단어들 인덱스를 찾음
            // 우리는 화면에 '역순(최신이 위)'으로 보여주지만,
            // 데이터 저장은 '정순(추가된 순서)'으로 되어 있음.
            // 
            // 화면상에서 [위로] 버튼 = 최신(배열 뒤쪽)에서 더 최신(더 뒤쪽)으로 이동? 
            // 헷갈리므로 -> "화면에 보이는 순서"를 기준으로 잡음.
            // 화면: [Word C, Word B, Word A] (인덱스: 2, 1, 0)
            // Word B를 '위로(-1)' 보냄 -> [Word B, Word C, Word A] 가 되어야 함.
            // 이는 실제 배열 [A, B, C] 에서 B(1)와 C(2)를 바꾸는 것.
            // 즉, 화면상 '위(-1)'는 실제 배열 인덱스 '+1' 방향(뒤쪽)과 연관됨 (역순 표시니까).

            // 하지만 가장 직관적인건 그냥 '배열 인덱스'를 바꾸는 것.
            // 단순히 appData.words 배열 내에서 해당 아이템을 앞/뒤 요소와 swap 하면 됨.
            // 문제는 appData.words에는 다른 그룹 단어도 섞여 있다는 점.

            const allIndex = appData.words.findIndex(w => w.id === wordIdNum);
            if (allIndex === -1) return;

            // 현재 그룹의 단어들만 추출하여 그 안에서의 상대적 위치 확인
            const groupWords = appData.words.filter(w => w.groupId === currentGroupId);
            // groupWords 내부에서의 인덱스 찾기
            const localIndex = groupWords.findIndex(w => w.id === wordIdNum);

            // 목표 위치 계산 (화면상 역순이므로 방향 반대)
            // 화면 [위로] = localIndex + 1 (나보다 나중에 들어온 놈이랑 자리 바꿈)
            // 화면 [아래로] = localIndex - 1 (나보다 먼저 들어온 놈이랑 자리 바꿈)
            // 
            // 왜? 화면엔 [3, 2, 1, 0] 순서로 찍힘. 2번을 위로 보내면 [2, 3, 1, 0]이 됨.
            // 실제 배열은 [0, 1, 2, 3] 이므로, 2번이 3번 자리로 가야 함 (index + 1)

            const targetLocalIndex = localIndex + (direction === -1 ? 1 : -1);

            if (targetLocalIndex < 0 || targetLocalIndex >= groupWords.length) return; // 이동 불가

            const targetWord = groupWords[targetLocalIndex];
            const targetAllIndex = appData.words.findIndex(w => w.id === targetWord.id);

            // 실제 배열(Global)에서 두 아이템 Swap
            const temp = appData.words[allIndex];
            appData.words[allIndex] = appData.words[targetAllIndex];
            appData.words[targetAllIndex] = temp;

            saveData();
            renderApp();
        }




        // [신규] 사전 팝업 헬퍼
        function openDictWindow(term, code) {
            const langInfo = SUPPORTED_LANGS[code];
            const url = langInfo.url + encodeURIComponent(term);
            window.open(url, '_blank', 'width=450,height=600');
        }

        // [JS 수정] 스마트 그룹에서도 개별 퀴즈 시작 버튼(▶) 추가
        /* --- [JS 수정] renderSmartGroupDetail (번역 누락 해결) --- */
        function renderSmartGroupDetail(container, langId) {
            container.classList.add('no-scroll');
            document.getElementById('main-fab').style.transform = 'scale(0)';

            const { mode, value } = currentSmartView;
            const langInfo = SUPPORTED_LANGS[getCodeByLangId(langId)];

            let filteredWords = [];
            let title = "";

            if (mode === 'tag') {
                title = `#${value}`;
                filteredWords = appData.words.filter(w => w.langId === langId && w.tags?.includes(value));
            } else if (mode === 'wrong_last') {
                title = t('smart_last_wrong'); // 번역
                filteredWords = appData.words.filter(w => w.langId === langId && w.stats?.lastResult === 'wrong');
            } else if (mode === 'wrong_freq') {
                title = t('smart_freq_wrong'); // 번역
                filteredWords = appData.words.filter(w => w.langId === langId && (w.stats?.wrong || 0) >= 3);
            }

            const displayList = [...filteredWords].reverse();

            let stats = { total: displayList.length, tries: 0, wrong: 0, acc: 0 };
            if (displayList.length > 0) {
                let sT = 0, sW = 0;
                const triesArr = displayList.map(w => w.stats ? w.stats.total : 0);
                stats.tries = Math.min(...triesArr);

                displayList.forEach(w => {
                    if (w.stats) {
                        sT += w.stats.total;
                        if ((w.stats.wrong || 0) >= 3) stats.wrong++;
                        sW += w.stats.wrong || 0;
                    }
                });
                if (sT > 0) stats.acc = Math.round(((sT - sW) / sT) * 100);
            }
            const todayStr = new Date().toLocaleDateString();

            let startBtnHTML = '';
            if (displayList.length > 0) {
                startBtnHTML = `<button onclick="startQuizFromSmartGroup(0)" class="play-all-btn">▶ Play All</button>`;
            }

            let html = `
    <div id="sticky-header" class="fixed-header-layer">
        <div class="header-card-inner layout-container">
            <div class="top-row" style="margin-bottom:10px;">
                <button onclick="currentSmartView=null; renderApp()" class="back-icon-btn">←</button>
                <div class="header-title-area" style="text-align:left;">
                     <div class="header-subtitle" style="font-size:0.8rem; color:var(--accent);">${langInfo.name} | ${todayStr}</div>
                     <div class="main-title" style="font-size:1.4rem;">${title}</div>
                </div>
                ${startBtnHTML}
            </div>

            <div class="stats-wrapper">
                <div class="stats-dashboard">
                    <!-- [수정] 통계 라벨 번역 적용 -->
                    <div class="stat-item"><span class="stat-label">${t('total_words')}</span><span class="stat-value" style="font-size:1.2rem;">${stats.total}</span></div>
                    <div class="stat-item"><span class="stat-label">${t('stat_min_try')}</span><span class="stat-value" style="font-size:1.2rem; color:var(--text-main);">${stats.tries}</span></div>
                    <div class="stat-item"><span class="stat-label">${t('stat_avg_acc')}</span><span class="stat-value" style="font-size:1.2rem; color:#4CAF50;">${stats.acc}%</span></div>
                    <div class="stat-item"><span class="stat-label">${t('stat_weak')}</span><span class="stat-value" style="font-size:1.2rem; color:var(--danger);">${stats.wrong}</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="scroll-area" class="scroll-content-area">
        <div id="header-spacer" style="width:100%; height:260px;"></div> 

        <div id="word-items-list" class="layout-container" style="padding-bottom:100px;">
    `;

            if (displayList.length === 0) {
                // [수정] 안내 메시지 번역 적용
                html += `<p style="text-align:center; padding:50px; opacity:0.5;">${t('no_matching_word')}</p>`;
            } else {
                displayList.forEach((w, idx) => {
                    const ttsCode = getCodeByLangId(langId);
                    const listNum = idx + 1;

                    html += `
             <div class="word-item" style="border-radius:15px; margin-bottom:10px; border:1px solid var(--glass-border); display:flex; align-items:center; padding: 15px;">
                 <div style="width:15px; flex-shrink:0; display:flex; align-items:center; justify-content:center;">
                    <div class="item-number" style="font-size:1rem; color:var(--text-dim);">${listNum}</div>
                 </div>

                 <div class="word-content" onclick="openWordDetail(${w.id})" style="flex:1; margin-left:5px; cursor:pointer;">
                     <div class="word-row-main" style="color:var(--text-main); font-weight:600; line-height:1.2;">
                        ${w.term} <span class="word-pron" style="font-weight:normal; color:var(--accent); margin-left:5px;">${w.pron || ''}</span>
                     </div>
                     <div class="word-row-sub" style="opacity:0.8; margin-top:2px;">${w.mean}</div>
                 </div>
                 
                 <div class="icon-actions" style="display:flex; gap:10px;">
                    <button class="icon-btn play-sound" onclick="speak('${w.term}','${ttsCode}')">🔊</button>
                    <button class="dict-btn" onclick="openDictWindow('${w.term}','${ttsCode}')">${t('dict_search')}</button>
                    <button class="quiz-start-btn" onclick="startQuizFromSmartGroup(${idx})" title="${t('quiz_start_idx')}">▶</button>
                 </div>
             </div>`;
                });
            }

            html += `</div></div>`;
            container.innerHTML = html;

            setTimeout(() => {
                const hCard = document.querySelector('.header-card-inner');
                if (hCard) document.getElementById('header-spacer').style.height = (hCard.offsetHeight + 20) + 'px';
            }, 50);

            const scrollEl = document.getElementById('scroll-area');
            const headerLayer = document.getElementById('sticky-header');
            if (scrollEl && headerLayer) {
                scrollEl.onscroll = () => {
                    if (scrollEl.scrollTop > 30) headerLayer.classList.add('shrunk');
                    else headerLayer.classList.remove('shrunk');
                };
            }
        }

        // [추가] startQuizFromGroup 헬퍼 (헤더 버튼용)
        function startQuizFromGroup(groupId) {
            const sGroupId = String(groupId);
            const group = appData.groups.find(g => String(g.id) === sGroupId);
            // 그룹 처음부터(0) 시작하도록 호출
            quizSourceData = { langId: group.langId, mode: 'group', value: sGroupId, startIndex: 0 };
            showQuizModal(group.langId);
        }




        // --- Data Helpers ---
        function getCodeByLangId(id) {
            return appData.myLangs.find(l => l.id === id)?.code;
        }


        // --- [Global 추가] 편집용 ID 저장 변수 ---
        let editingWordId = null;

        // [JS Fix] 단어 추가 모달 (입력 초기화 강화)
        function openAddWordModal() {
            // 그룹 내에서만 추가 가능
            if (!currentGroupId) {
                alert("단어장 그룹 내에서만 단어를 추가할 수 있습니다.\n원하는 단어장을 먼저 클릭해주세요.");
                return;
            }

            editingWordId = null;
            renderWordModalContent(); // 폼 렌더링 (아래 함수 신설)
            openModalWithAnim('modal-add-word');
            setTimeout(() => document.getElementById('inp-term').focus(), 150);

            const group = appData.groups.find(g => g.id === currentGroupId);
            if (!group) return;

            const langCode = getCodeByLangId(group.langId);
            const langName = SUPPORTED_LANGS[langCode].name;

            // 제목 업데이트
            document.getElementById('modal-word-title').innerText = t('word_new');
            const langDisplay = document.getElementById('current-lang-display');
            if (langDisplay) langDisplay.innerText = langName;

            // 입력 필드 완전 초기화
            document.getElementById('inp-term').value = '';
            document.getElementById('inp-pron').value = '';
            document.getElementById('inp-mean').value = '';
            document.getElementById('inp-memo').value = '';
            document.getElementById('inp-tags').value = '';

            // 태그 목록 갱신
            renderAllTags(currentGroupId);
            openModalWithAnim('modal-add-word');

            setTimeout(() => document.getElementById('inp-term').focus(), 150);
        }

        // (5) 단어 편집 함수 (신규)
        function editWord(id) {
            const word = appData.words.find(w => w.id === id);
            if (!word) return;

            editingWordId = id; // 수정 모드 활성화
            renderWordModalContent(word);

            document.getElementById('modal-word-title').innerText = "단어 수정";
            document.getElementById('inp-term').value = word.term;
            document.getElementById('inp-pron').value = word.pron || '';
            document.getElementById('inp-mean').value = word.mean;
            document.getElementById('inp-memo').value = word.memo || '';
            document.getElementById('inp-tags').value = word.tags ? word.tags.join(', ') : '';
            // [추가] 태그 목록 보이기
            const currentWord = appData.words.find(w => w.id === id);
            // w.groupId가 필요하므로 데이터에서 가져옴
            if (currentWord) renderAllTags(currentWord.groupId);

            openModalWithAnim('modal-add-word');
        }


        /* --- [JS 수정] 단어 추가/수정 모달 (태그 스타일 롤백) --- */
        function renderWordModalContent(wordData = null) {
            const group = appData.groups.find(g => g.id === (wordData ? wordData.groupId : currentGroupId));
            if (!group) return;

            const langCode = getCodeByLangId(group.langId);
            const langName = SUPPORTED_LANGS[langCode].name;
            const titleText = wordData ? t('word_edit') : t('word_new');

            const termVal = wordData ? wordData.term : '';
            const pronVal = wordData ? (wordData.pron || '') : '';
            const meanVal = wordData ? wordData.mean : '';
            const memoVal = wordData ? (wordData.memo || '') : '';
            const tagsVal = wordData && wordData.tags ? wordData.tags.join(', ') : '';

            const modalPanel = document.querySelector('#modal-add-word .modal-panel');

            modalPanel.innerHTML = `
        <div class="modal-sticky-header">
            <button onclick="closeModal('modal-add-word')" class="back-icon-btn" style="border:none; background:none;">✕</button>
            <h3 id="modal-word-title" style="margin:0; font-size:1.1rem;">${titleText}</h3>
            <div style="width:40px;"></div>
        </div>

        <div class="modal-scroll-body">
            <p class="desc" style="text-align:center; margin-bottom:20px;">
                Target: <span style="color:var(--primary); font-weight:bold;">${langName}</span>
            </p>

            <div class="input-group">
                <span class="input-label">${t('term')}</span>
                <input type="text" id="inp-term" value="${termVal}" placeholder="e.g. Apple">
            </div>

            <div class="input-group">
                <span class="input-label">${t('pron')}</span>
                <input type="text" id="inp-pron" value="${pronVal}" placeholder="[æpl]">
            </div>

            <div class="input-group">
                <span class="input-label">${t('mean')}</span>
                <input type="text" id="inp-mean" value="${meanVal}" placeholder="사과">
            </div>

            <div class="input-group">
                <span class="input-label">${t('memo')}</span>
                <input type="text" id="inp-memo" value="${memoVal}" placeholder="I ate an apple.">
            </div>

            <!-- [수정됨] 태그 입력 및 추천 영역 디자인 롤백 -->
            <div class="input-group" style="position:relative;">
                <span class="input-label">${t('tags')}</span>
                <input type="text" id="inp-tags" value="${tagsVal}" placeholder="#Food #Fruit" oninput="filterTags(this.value)">
                
                <!-- 추천 태그들이 들어갈 영역 (칩 형태) -->
                <div id="tag-suggestions" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>

            <div style="display:flex; gap:10px; margin-top:25px;">
                <button class="glass-btn primary" onclick="saveWord(false)" id="btn-save" style="flex:1;">${t('save')}</button>
                <button class="glass-btn primary" onclick="saveWord(true)" id="btn-save-cont" style="flex:1; border:1px solid var(--accent);">${t('save_cont')}</button>
            </div>
            <button class="glass-btn" onclick="closeModal('modal-add-word')" style="margin-top:10px;">${t('cancel')}</button>
            <div class="modal-footer-gap"></div>
        </div>
    `;

            // 태그 목록 렌더링 호출
            setTimeout(() => renderAllTags(group.id), 0);
        }

        /* --- [버그 수정] 단어 상세 보기 모달 (순서 변경 및 값 직접 주입) --- */
        function openWordDetail(wordId) {
            // 1. 데이터 찾기
            const word = appData.words.find(w => w.id === Number(wordId));
            if (!word) return;

            const group = appData.groups.find(g => g.id === word.groupId);
            // group이 없을 경우에 대한 안전장치 (스마트 그룹 등)
            // const langCode = group ? getCodeByLangId(group.langId) : getCodeByLangId(word.langId); 
            const langCode = getCodeByLangId(word.langId);

            // 2. 모달 패널 요소 가져오기
            const modalPanel = document.querySelector('#modal-word-detail .modal-panel');

            // 3. 태그 HTML 생성
            let tagHtml = '';
            if (word.tags && word.tags.length > 0) {
                word.tags.forEach(t => {
                    tagHtml += `<span class="group-tag" style="font-size:0.9rem; margin-right:6px; padding:6px 10px;">#${t}</span>`;
                });
            } else {
                tagHtml = `<span style="color:var(--text-dim); font-size:0.9rem;">-</span>`;
            }

            // 4. [핵심 수정] HTML 문자열에 데이터(${word.term} 등)를 바로 넣어서 그립니다.
            // 기존에는 innerHTML을 넣기 전에 요소를 찾으려 해서 에러가 났었습니다.
            modalPanel.innerHTML = `
        <div class="modal-sticky-header">
            <button onclick="closeModal('modal-word-detail')" class="back-icon-btn" style="border:none; background:none;">✕</button>
            <h3 style="margin:0; font-size:1.1rem;">${t('word_detail')}</h3>
            <button id="btn-detail-edit" class="title-edit-btn" style="font-size:1.1rem; opacity:1;">✎</button>
        </div>
        
        <div class="modal-scroll-body">
            <!-- 단어 & 발음 -->
            <div style="text-align:center; margin-bottom:20px;">
                <h1 style="margin:0; font-size:2.2rem; word-break:break-all;">${word.term}</h1>
                <div style="font-size:1.1rem; color:var(--accent); margin-top:5px;">${word.pron ? `[${word.pron}]` : ''}</div>
            </div>

            <!-- 뜻 -->
            <div class="glass-card" style="margin-bottom:15px; padding:15px;">
                <span class="input-label">${t('mean')}</span>
                <div style="font-size:1.2rem; font-weight:600; color:var(--text-main);">${word.mean}</div>
            </div>

            <!-- 메모 -->
            <div class="glass-card" style="margin-bottom:15px; padding:15px;">
                <span class="input-label">${t('memo')}</span>
                <div style="font-size:1rem; color:var(--text-dim); line-height:1.5; min-height:20px;">${word.memo || '-'}</div>
            </div>

            <!-- 태그 -->
            <div style="margin-bottom:25px;">
                <span class="input-label" style="margin-bottom:8px;">${t('tags')}</span>
                <div style="display:flex; flex-wrap:wrap;">${tagHtml}</div>
            </div>

            <!-- 버튼들 -->
            <div style="display:flex; gap:10px;">
                <button id="btn-detail-dict" class="glass-btn primary" style="flex:1; background:linear-gradient(135deg, #03C75A, #02b350); border:none;">
                    ${t('dict_search')}
                </button>
            </div>
            <div class="modal-footer-gap"></div>
        </div>
    `;

            // 5. HTML이 그려진 "후"에 버튼에 클릭 이벤트를 연결합니다.
            document.getElementById('btn-detail-edit').onclick = () => {
                closeModal('modal-word-detail');
                setTimeout(() => editWord(word.id), 200);
            };

            document.getElementById('btn-detail-dict').onclick = () => {
                openDictWindow(word.term, langCode);
            };

            // 6. 모달 열기 애니메이션
            openModalWithAnim('modal-word-detail');
        }



        // [단어 저장] 단어 추가/수정 시 그룹의 modifiedAt 갱신
        function saveWord(isContinue) {
            const term = document.getElementById('inp-term').value.trim();
            const mean = document.getElementById('inp-mean').value.trim();
            const pron = document.getElementById('inp-pron').value.trim();
            const memo = document.getElementById('inp-memo').value.trim();
            const rawTags = document.getElementById('inp-tags').value;
            const tags = rawTags.split(/[, ]+/).filter(t => t.trim() !== '').map(t => t.trim());

            if (!term || !mean) return alert(t('alert_input'));

            const defaultStats = { total: 0, wrong: 0, consecutiveCorrect: 0, lastResult: null, lastWrongType: null };

            // [중요] 단어가 속한 그룹 찾아서 수정일 갱신
            // (editingWordId가 있으면 그 단어의 groupId를, 없으면 currentGroupId 사용)
            let targetGroupId = currentGroupId;
            if (editingWordId) {
                const w = appData.words.find(w => w.id === editingWordId);
                if (w) targetGroupId = w.groupId;
            }
            const group = appData.groups.find(g => g.id === targetGroupId);
            if (group) {
                group.modifiedAt = Date.now(); // 날짜 갱신!
            }

            if (editingWordId) {
                // 수정 모드
                const idx = appData.words.findIndex(w => w.id === editingWordId);
                if (idx > -1) {
                    const w = appData.words[idx];
                    w.term = term; w.mean = mean; w.pron = pron; w.memo = memo;
                    w.tags = tags;
                }
                closeModal('modal-add-word');
                saveData();
                renderApp();
            } else {
                // 새 단어 추가
                // 그룹은 위에서 이미 찾았으므로 langId 획득 가능
                appData.words.unshift({
                    id: Date.now(),
                    groupId: currentGroupId,
                    langId: group.langId,
                    term, mean, memo, pron,
                    tags: tags,
                    stats: defaultStats,
                    created: Date.now()
                });
                saveData();

                if (isContinue) {
                    document.getElementById('inp-term').value = '';
                    document.getElementById('inp-mean').value = '';
                    document.getElementById('inp-pron').value = '';
                    document.getElementById('inp-memo').value = '';
                    document.getElementById('inp-term').focus();

                    const titleEl = document.getElementById('modal-word-title');
                    const originTxt = titleEl.innerText;
                    titleEl.innerText = t('saved_cont');
                    titleEl.style.color = "var(--primary)";
                    setTimeout(() => {
                        titleEl.innerText = originTxt;
                        titleEl.style.color = "";
                    }, 1000);

                    renderApp();
                } else {
                    closeModal('modal-add-word');
                    renderApp();
                }
            }
        }

        // [단어 삭제] 삭제 시에도 그룹 수정 날짜 갱신
        function deleteWord(id) {
            if (!confirm(t('confirm_del'))) return;

            // 삭제 대상 단어 찾기 (그룹 ID 알기 위해)
            const targetWord = appData.words.find(w => w.id === id);
            if (targetWord) {
                const group = appData.groups.find(g => g.id === targetWord.groupId);
                if (group) {
                    group.modifiedAt = Date.now(); // 날짜 갱신
                }
            }

            appData.words = appData.words.filter(w => w.id !== id);
            saveData();
            renderApp();
        }

        function closeModal(id) {

            history.back();
        }

        function openModalWithAnim(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            // [추가] 모달 열 때 히스토리 추가 (Level 3 - Modal)
            // 현재 보고있는 뷰 정보를 유지한채 모달임을 표시
            history.pushState({ level: 3, view: 'modal', modalId: modalId }, null, '');

            modal.style.display = 'flex';
            modal.style.opacity = '0';

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    modal.style.display = '';
                    modal.style.opacity = '';
                    modal.classList.add('active');
                });
            });
        }

        function resetData() {
            if (confirm(t('reset_confirm'))) {
                localStorage.removeItem(STORE_KEY);
                location.reload();
            }
        }

        /* --- [JS 수정] renderAllTags (태그 버튼 스타일 강제 적용) --- */
        function renderAllTags(currentGroupId) {
            const box = document.getElementById('tag-suggestions');
            // 안전장치: 요소가 없거나 그룹ID가 없으면 중단
            if (!box || !currentGroupId) return;

            // 그룹 찾기 (ID 타입 불일치 방지를 위해 문자열 비교)
            const group = appData.groups.find(g => String(g.id) === String(currentGroupId));
            if (!group) return;

            const langId = group.langId;

            // 해당 언어의 모든 태그 수집
            const wordsInLang = appData.words.filter(w => w.langId === langId);
            const allTags = new Set();
            wordsInLang.forEach(w => {
                if (w.tags && Array.isArray(w.tags)) {
                    w.tags.forEach(t => allTags.add(t));
                }
            });

            const sortedTags = Array.from(allTags).sort();

            // HTML 생성
            if (sortedTags.length === 0) {
                box.innerHTML = '';
            } else {
                // [핵심 수정] style 속성을 직접 넣어서 박스 디자인 강제 적용
                box.innerHTML = sortedTags.map(tag =>
                    `<div class="tag-chip" onclick="addTagToInput('${tag}')" 
                  style="display:inline-flex; align-items:center; gap:4px; 
                         background:rgba(255,255,255,0.1); 
                         border:1px solid var(--glass-border); 
                         border-radius:8px; padding:6px 12px; margin:0 6px 6px 0; 
                         font-size:0.85rem; color:var(--text-dim); cursor:pointer; user-select:none;">
                <span style="color:var(--accent);">#</span>${tag}
            </div>`
                ).join('');
            }
        }

        // 2. 검색어 입력 시 필터링 (선택 사항, 필요 없으면 oninput 제거해도 됨)
        function filterTags(val) {
            const box = document.getElementById('tag-suggestions');
            const chips = box.getElementsByClassName('tag-chip');
            const term = val.toLowerCase(); // 간단 검색

            // 이미 렌더링된 칩들을 숨기거나 보여줌
            Array.from(chips).forEach(chip => {
                // 태그 텍스트 가져오기 (샵(#) 제외)
                const text = chip.textContent.replace('#', '').trim().toLowerCase();
                if (text.includes(term) || term === "") {
                    chip.style.display = 'inline-flex';
                } else {
                    chip.style.display = 'none';
                }
            });
        }

        // 3. 칩 클릭 시 입력창에 태그 추가 (기존 기능 유지)
        function addTagToInput(tag) {
            const input = document.getElementById('inp-tags');
            let val = input.value.trim();

            // 이미 포함되어 있는지 확인 (중복 방지)
            const currentTags = val.split(/[, ]+/);
            if (currentTags.includes(tag)) return; // 이미 있으면 무시

            if (val.length > 0 && !val.endsWith(',')) {
                val += ', ';
            }
            input.value = val + tag;
            input.focus();
        }

        // [신규] 태그 추천 칩 클릭 시 입력창에 적용
        function applyTag(tag) {
            const input = document.getElementById('inp-tags');
            const parts = input.value.split(',');
            parts.pop(); // 지금 치고 있던(완성 안된) 조각 제거
            parts.push(tag); // 추천 태그 추가
            input.value = parts.join(', ') + ', '; // 쉼표 찍어주기
            input.focus();
            document.getElementById('tag-suggestions').innerHTML = ''; // 추천창 닫기
        }



        // ============================================
        // [JS 교체] 퀴즈 시스템 (이어하기, 특정 단어 시작)
        // ============================================

        // [2. 진입] 단어 리스트에서 ▶ 버튼 클릭 시 데이터 셋업
        function startQuizFromIndex(groupId, startIndex) {
            const sGroupId = String(groupId);
            const group = appData.groups.find(g => String(g.id) === sGroupId);

            if (!group) return alert("오류: 단어장을 찾을 수 없습니다.");

            // 진입 정보 설정
            quizSourceData = {
                langId: group.langId,
                mode: 'group',
                value: sGroupId,
                startIndex: Number(startIndex), // 사용자가 선택한 위치 (0이면 처음, 5면 5번 단어부터)
            };

            // 모달을 띄움
            showQuizModal(group.langId, sGroupId);
        }

        // [NEW] 스마트 그룹에서 특정 인덱스부터 퀴즈 시작
        function startQuizFromSmartGroup(startIndex) {
            if (!currentSmartView) return;

            // 스마트 그룹 정보 가져오기
            // langId는 화면 렌더링 시 사용했던 것을 그대로 쓰기 어려우므로(전역이 아님),
            // 현재 필터링된 첫 단어의 langId를 가져오거나, 
            // 혹은 전역 변수(currentTab이 숫자면 langId임)를 활용.
            let langId = (typeof currentTab === 'number') ? currentTab : null;

            // 만약 대시보드에서 들어온게 아니라면(혹시 모를 예외), 
            // filteredWords를 다시 구해서 langId 확인
            if (!langId) {
                // ... 로직이 복잡해지므로, 그냥 renderSmartGroupDetail 호출 시의 langId를 어딘가 저장했으면 좋았겠지만,
                // 현재 구조상 'currentTab'이 해당 언어 탭(숫자 ID)인 상태이므로 안전함.
            }

            const { mode, value } = currentSmartView;

            // 진입 정보 설정
            quizSourceData = {
                langId: currentTab, // 현재 보고있는 언어 탭 ID
                mode: mode,         // 'tag', 'wrong_last' 등
                value: value,       // 태그명 등
                startIndex: Number(startIndex), // 사용자가 누른 위치
                isResume: false     // 새 게임
            };

            // 모달 띄우기 (스마트 그룹은 groupId가 없으므로 null 전달 -> 이어하기 불가)
            showQuizModal(currentTab, null);
        }

        // 2. 스마트 그룹용 퀴즈 시작 (기존 유지)
        function startQuizSetup(langId, mode, value) {
            quizSourceData = { langId, mode, value, startIndex: 0, isResume: false };
            showQuizModal(langId, null);
        }

        // [3. 모달] 퀴즈 옵션 및 버튼 상태 관리 (디자인 구조 통일 적용)
        function showQuizModal(langId, groupId) {
            const langCode = getCodeByLangId(langId);
            const availableTypes = LANG_QUIZ_MAP[langCode] || LANG_QUIZ_MAP['default'];
            const modalPanel = document.querySelector('#modal-quiz-setup .modal-panel');

            let startBtnText = t('quiz_start');
            if (quizSourceData && quizSourceData.startIndex > 0) {
                startBtnText = t('quiz_start_idx');
            }

            let contBtnText = `${t('quiz_cont')} (N/A)`;
            let contBtnDisabled = true;
            let contBtnOpacity = "0.5";

            if (groupId) {
                const group = appData.groups.find(g => String(g.id) === String(groupId));
                const wordsInGroup = appData.words.filter(w => String(w.groupId) === String(groupId));
                const savedIndex = group.lastStopIndex || 0;

                if (wordsInGroup.length > 0 && savedIndex > 0 && savedIndex < wordsInGroup.length) {
                    contBtnDisabled = false;
                    contBtnOpacity = "1";
                    contBtnText = `${t('quiz_cont')} (${savedIndex + 1}~)`;
                    quizSourceData.resumeIndex = savedIndex;
                } else {
                    if (savedIndex >= wordsInGroup.length && wordsInGroup.length > 0) {
                        contBtnText = t('done');
                    } else {
                        contBtnText = `${t('quiz_cont')} (N/A)`;
                    }
                    quizSourceData.resumeIndex = 0;
                }
            }

            modalPanel.innerHTML = `
        <div class="modal-sticky-header">
            <button onclick="closeModal('modal-quiz-setup')" class="back-icon-btn" style="border:none; background:none; font-size:1.2rem;">✕</button>
            <h3 style="margin:0; font-size:1.1rem;">${t('quiz_setup')}</h3>
            <div style="width:40px;"></div>
        </div>

        <div class="modal-scroll-body">
            <div class="glass-card" style="padding:15px 20px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span style="font-size:1rem; font-weight:500;">${t('tts_option')}</span>
                    <label class="ios-switch">
                        <input type="checkbox" id="chk-tts" checked>
                        <span class="ios-slider"></span>
                    </label>
                </div>
                <hr style="border:0; border-top:1px solid var(--glass-border); margin:0 0 15px 0; opacity:0.3;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:1rem; font-weight:500;">${t('random_option')}</span>
                    <label class="ios-switch">
                        <input type="checkbox" id="chk-random" onchange="toggleContinueBtn()">
                        <span class="ios-slider"></span>
                    </label>
                </div>
            </div>

            <div class="glass-card" style="padding:20px; margin-bottom:25px;">
                <div style="text-align:center; font-size:0.9rem; color:var(--text-dim); margin-bottom:10px;">
                    ${t('quiz_type_select')}
                </div>
                <div id="new-quiz-types-area" class="q-type-grid">
                    ${availableTypes.map(typ => `
                        <button class="q-type-btn active" data-value="${typ.id}" onclick="this.classList.toggle('active')">
                            ${t('q_type_' + typ.id)}
                        </button>
                    `).join('')}
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px; flex-direction: column;">
                <button class="glass-btn primary" onclick="launchQuiz('start')" id="btn-quiz-start" style="height:50px; font-size:1.1rem;">${startBtnText}</button>
                <button class="glass-btn" id="btn-quiz-continue" onclick="launchQuiz('continue')" 
                        style="height:50px; font-size:1rem; opacity:${contBtnOpacity};" ${contBtnDisabled ? 'disabled' : ''}>
                    ${contBtnText}
                </button>
                <button class="glass-btn" onclick="closeModal('modal-quiz-setup')" style="margin-top:5px;">${t('cancel')}</button>
            </div>
            <div class="modal-footer-gap"></div>
        </div>
    `;

            openModalWithAnim('modal-quiz-setup');
        }
        // [4. 실행] 실제 퀴즈 데이터 슬라이싱 및 시작
        // [4. 실행] 버튼 활성화 상태(.active)를 읽어서 퀴즈 시작
        function launchQuiz(startMode) {
            const isOnline = navigator.onLine;
            let useTTS = document.getElementById('chk-tts').checked;
            const isRandom = document.getElementById('chk-random').checked;

            if (!isOnline && useTTS) {
                alert("오프라인 상태라 TTS가 비활성화됩니다.");
                useTTS = false;
            }

            // [수정된 부분] .q-type-btn 중 .active 클래스가 있는 요소들의 data-value를 가져옴
            const activeButtons = document.querySelectorAll('#new-quiz-types-area .q-type-btn.active');
            let selectedTypes = Array.from(activeButtons).map(btn => btn.dataset.value);

            if (selectedTypes.length === 0) return alert("최소 1개 이상의 문제 유형을 선택하세요.");
            if (!isOnline) selectedTypes = selectedTypes.filter(type => type !== 'tts_dict');

            // --- (이 아래 로직은 기존과 100% 동일) ---

            // 데이터 가져오기
            let targets = [];
            let isGroupMode = (quizSourceData.mode === 'group');

            if (isGroupMode) {
                targets = appData.words.filter(w => String(w.groupId) === String(quizSourceData.value));
            } else if (quizSourceData.mode === 'tag') {
                targets = appData.words.filter(w => w.langId === quizSourceData.langId && w.tags && w.tags.includes(quizSourceData.value)).reverse();
            } else if (quizSourceData.mode === 'wrong_last') {
                targets = appData.words.filter(w => w.langId === quizSourceData.langId && w.stats?.lastResult === 'wrong').reverse();
            } else if (quizSourceData.mode === 'wrong_freq') {
                targets = appData.words.filter(w => w.langId === quizSourceData.langId && (w.stats?.wrong || 0) >= 3).reverse();
            }

            if (targets.length === 0) return alert("학습할 단어가 없습니다.");

            let finalQueue = [];
            let initialIndex = 0;

            if (isRandom) {
                finalQueue = [...targets].sort(() => Math.random() - 0.5);
                initialIndex = 0;
            } else {
                if (startMode === 'continue') {
                    initialIndex = quizSourceData.resumeIndex || 0;
                } else {
                    initialIndex = quizSourceData.startIndex || 0;
                }

                if (initialIndex < targets.length) {
                    finalQueue = targets.slice(initialIndex);
                } else {
                    return alert("선택한 범위에 학습할 단어가 없습니다.");
                }
            }

            quizSession = {
                active: true,
                queue: finalQueue,
                cursor: 0,
                correctCnt: 0,
                targetGroupId: isGroupMode ? quizSourceData.value : null,
                absoluteStartIndex: initialIndex,
                isRandom: isRandom,
                config: { useTTS, types: selectedTypes }
            };

            closeModal('modal-quiz-setup');
            document.getElementById('quiz-screen').style.display = 'flex';
            showNextQuestion();
        }

        // [5. 종료] 퀴즈 종료 및 진행 상황(이어하기 위치) 저장
        // [퀴즈 종료] 진행 상황 저장 및 '마지막 퀴즈 날짜' 갱신
        // [JS 수정] 퀴즈 종료 시 '시험 결과 히스토리(점수 등)'를 저장하도록 추가
        function exitQuiz() {
            // 퀴즈 화면 닫기도 뒤로가기 (onpopstate에서 처리됨)
            // 단, 데이터 저장은 해야하므로 저장 로직은 유지하고 화면 전환만 위임

            // --- (기존 데이터 저장/계산 로직 유지) ---
            if (quizSession.active && quizSession.targetGroupId && !quizSession.isRandom) {
                const group = appData.groups.find(g => String(g.id) === String(quizSession.targetGroupId));
                if (group) {
                    group.lastQuizDate = Date.now();
                    // ... (기존 점수 계산 및 저장 코드 그대로 유지) ...
                    const totalQ = quizSession.queue.length;
                    if (totalQ > 0 && quizSession.cursor >= totalQ) {
                        const score = Math.round((quizSession.correctCnt / totalQ) * 100);
                        const wrongIds = quizSession.queue
                            .filter(w => w.stats && w.stats.lastResult === 'wrong')
                            .map(w => w.id);
                        if (!group.quizHistory) group.quizHistory = [];
                        group.quizHistory.push({ date: Date.now(), score: score, wrongWords: wrongIds });
                        if (group.quizHistory.length > 50) group.quizHistory.shift();
                    }
                    const nextIndex = (quizSession.absoluteStartIndex || 0) + quizSession.cursor;
                    const wordsInGroup = appData.words.filter(w => String(w.groupId) === String(group.id));
                    if (nextIndex >= wordsInGroup.length) group.lastStopIndex = wordsInGroup.length;
                    else group.lastStopIndex = nextIndex;
                    saveData();
                }
            } else if (quizSession.active && quizSession.targetGroupId && quizSession.isRandom) {
                const group = appData.groups.find(g => String(g.id) === String(quizSession.targetGroupId));
                if (group) { group.lastQuizDate = Date.now(); saveData(); }
            }
            // --- (여기까지 기존 로직) ---

            // [수정] 화면 닫기는 뒤로가기로 처리
            // 단, 퀴즈 모달이 떠있는 상태였다면 history.back()이 모달을 닫을 것이고,
            // 전체화면 퀴즈창은 onpopstate에서 처리하도록 함
            history.back();
        }

        // 6. UI 제어
        function toggleContinueBtn() {
            const isRandom = document.getElementById('chk-random').checked;
            const btnCont = document.getElementById('btn-quiz-continue');

            if (isRandom) {
                btnCont.disabled = true;
                btnCont.style.opacity = 0.5;
                // 텍스트는 건드리지 않고 비활성화만
            } else {
                // 랜덤 끄면 다시 활성화 체크 (기존에 활성화 상태였다면)
                // 여기서는 단순하게 quizSourceData.resumeIndex가 있으면 활성화시킴
                if (quizSourceData && quizSourceData.resumeIndex > 0) {
                    btnCont.disabled = false;
                    btnCont.style.opacity = 1;
                }
            }
        }






        // 4. 문제 렌더링
        /* --- [JS 수정] showNextQuestion (다국어 적용 완전판) --- */
        function showNextQuestion() {
            // 퀴즈 종료 체크 및 알림 번역
            if (quizSession.cursor >= quizSession.queue.length) {
                alert(t('quiz_finish_alert', { n: Math.round((quizSession.correctCnt / quizSession.queue.length) * 100) }));
                return exitQuiz();
            }

            const word = quizSession.queue[quizSession.cursor];

            const ui = {
                bar: document.getElementById('quiz-progress-bar'),
                txt: document.getElementById('quiz-progress-text'),
                badge: document.getElementById('q-type-badge'),
                qText: document.getElementById('q-text'),
                area: document.getElementById('q-answer-area'),
                feedback: document.getElementById('q-feedback'),
                ttsBtn: document.getElementById('q-tts-btn')
            };

            const progress = ((quizSession.cursor) / quizSession.queue.length) * 100;
            ui.bar.style.width = `${progress}%`;
            ui.txt.innerText = `${quizSession.cursor + 1} / ${quizSession.queue.length}`;

            ui.feedback.style.display = 'none';
            ui.area.innerHTML = '';

            // 문제 유형 결정
            let qType = null;
            const availTypes = quizSession.config.types;

            if (word.stats && word.stats.lastResult === 'wrong' && word.stats.lastWrongType) {
                if (availTypes.includes(word.stats.lastWrongType)) {
                    qType = word.stats.lastWrongType;
                }
            }
            if (!qType) {
                qType = availTypes[Math.floor(Math.random() * availTypes.length)];
            }
            quizSession.currentQType = qType;

            // --- 문제 텍스트 및 TTS 설정 ---
            let questionText = word.term;
            let isTTSQuestion = false;

            // [다국어] 뱃지 텍스트 번역
            ui.badge.innerText = t('q_type_' + qType) || "Quiz";

            switch (qType) {
                case 'j_sel_k2h':
                case 'j_typ_k2h':
                    // 뱃지는 위에서 처리됨
                    break;
                case 'sel_l2m':
                    break;
                case 'sel_m2l': case 'j_sel_m2k':
                    questionText = word.mean;
                    break;
                case 'tts_dict':
                    questionText = "🎧 Listen"; // 아이콘이라 그대로 둠
                    isTTSQuestion = true;
                    break;
                case 'typ_spell': case 'j_typ_spell':
                    questionText = word.mean;
                    break;
                case 'j_wri_chk':
                    questionText = `${word.mean} ${word.pron ? `[${word.pron}]` : ''}`;
                    break;
                default:
                    break;
            }

            ui.qText.innerText = questionText;
            ui.ttsBtn.style.display = (isTTSQuestion || quizSession.config.useTTS) ? 'inline-block' : 'none';

            // TTS 재생
            const langCode = getCodeByLangId(word.langId);
            if (isTTSQuestion) {
                speak(word.term, langCode);
            } else if (quizSession.config.useTTS) {
                // speak(word.term, langCode);
            }

            // --- [핵심] 오답(선다) 선별 및 정답 배치 로직 ---
            if (qType.includes('sel') || qType === 'tts_dict') {

                // 1. 후보군 추출
                const candidates = appData.words.filter(w => w.langId === word.langId && w.id !== word.id);

                // 2. 가중치 점수 계산
                const scoredCandidates = candidates.map(w => {
                    let score = 0;
                    if (w.tags && word.tags) {
                        const intersection = w.tags.filter(t => word.tags.includes(t));
                        score += intersection.length * 10;
                    }
                    if (w.term && word.term && w.term[0] === word.term[0]) score += 15;
                    if (w.term && word.term && w.term.slice(-1) === word.term.slice(-1)) score += 10;
                    const lenDiff = Math.abs(w.term.length - word.term.length);
                    if (lenDiff === 0) score += 10;
                    else if (lenDiff === 1) score += 5;
                    if (w.mean.includes(word.mean) || word.mean.includes(w.mean)) score += 5;
                    if (w.pron && word.pron && Math.abs(w.pron.length - word.pron.length) <= 1) score += 5;

                    return { wordData: w, score: score, random: Math.random() };
                });

                // 3. 정렬
                scoredCandidates.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return b.random - a.random;
                });

                // 4. 중복 제거하며 추출
                const distractors = [];
                const usedTerms = new Set();
                usedTerms.add(word.term);

                for (const item of scoredCandidates) {
                    if (distractors.length >= 3) break;
                    const wData = item.wordData;
                    if (!usedTerms.has(wData.term)) {
                        distractors.push(wData);
                        usedTerms.add(wData.term);
                    }
                }

                let choices = [word, ...distractors];
                choices.sort(() => Math.random() - 0.5);

                // 5. 버튼 렌더링
                choices.forEach(ch => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';

                    let btnText = ch.mean;
                    if (qType === 'j_sel_k2h') {
                        btnText = ch.pron || ch.mean;
                    } else if (qType === 'sel_m2l' || qType === 'j_sel_m2k') {
                        btnText = ch.term;
                    }

                    btn.innerText = btnText;
                    btn.onclick = () => handleAnswer(ch.id === word.id, word);
                    ui.area.appendChild(btn);
                });

            } else if (qType.includes('typ')) {
                // --- [다국어] 주관식 ---
                // input_placeholder, submit 키가 필요합니다 (TRANSLATIONS에 추가 필요)
                const placeholder = t('input_placeholder') || "Input Answer";
                const submitText = t('submit') || "Submit";

                ui.area.innerHTML = `
            <input type="text" id="quiz-input" placeholder="${placeholder}" autocomplete="off" 
                style="background:rgba(255,255,255,0.1); border:1px solid var(--accent); padding:15px; font-size:1.2rem; text-align:center; border-radius:10px; color:white; width:100%;">
            <button onclick="checkInputAnswer()" class="glass-btn primary" style="margin-top:10px;">${submitText}</button>
        `;
                setTimeout(() => {
                    const input = document.getElementById('quiz-input');
                    if (input) {
                        input.focus();
                        input.addEventListener("keyup", (e) => { if (e.key === "Enter") checkInputAnswer(); });
                    }
                }, 100);

            } else if (qType === 'j_wri_chk') {
                // --- [다국어] 자가진단 ---
                // self_check_hint, check_answer, correct, wrong 키가 필요합니다.
                const hintText = t('self_check_hint') || "Write it down or think about it.";
                const checkBtnText = t('check_answer') || "Check Answer";
                const correctText = t('correct') || "Correct";
                const wrongText = t('wrong') || "Wrong";

                ui.area.innerHTML = `
            <div id="self-check-step1" style="width:100%;">
                <p style="opacity:0.7; margin-bottom:10px;">${hintText}</p>
                <button onclick="revealSelfCheck()" class="glass-btn" style="border:1px solid var(--accent);">${checkBtnText}</button>
            </div>
            <div id="self-check-step2" style="display:none; text-align:center; width:100%;">
                <h2 style="color:var(--primary); margin-bottom:20px;">${word.term}</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="handleAnswer(true, null)" class="glass-btn" style="border-color:#4CAF50; color:#4CAF50;">⭕ ${correctText}</button>
                    <button onclick="handleAnswer(false, null)" class="glass-btn" style="border-color:var(--danger); color:var(--danger);">❌ ${wrongText}</button>
                </div>
            </div>
        `;
            }
        }

        // 5. 정답 처리 로직
        function checkInputAnswer() {
            const input = document.getElementById('quiz-input').value.trim().toLowerCase();
            const word = quizSession.queue[quizSession.cursor];
            const correct = word.term.toLowerCase();
            handleAnswer(input === correct, word);
        }

        function revealSelfCheck() {
            document.getElementById('self-check-step1').style.display = 'none';
            document.getElementById('self-check-step2').style.display = 'block';
        }

        function handleAnswer(isCorrect, wordObj) {
            if (!wordObj) wordObj = quizSession.queue[quizSession.cursor]; // 자가진단용 폴백

            const fb = document.getElementById('q-feedback');
            const title = document.getElementById('fb-title');
            const detail = document.getElementById('fb-detail');
            const nextBtn = document.getElementById('fb-next-btn');

            // UI 동결 (중복클릭 방지)
            const btns = document.querySelectorAll('.choice-btn');
            btns.forEach(b => b.disabled = true);

            // 데이터 업데이트 (word stats)
            if (!wordObj.stats) wordObj.stats = { total: 0, wrong: 0, consecutiveCorrect: 0, lastResult: null, lastWrongType: null };

            wordObj.stats.total++;
            wordObj.stats.lastResult = isCorrect ? 'correct' : 'wrong';

            if (isCorrect) {
                quizSession.correctCnt++;
                wordObj.stats.consecutiveCorrect++;
                // 맞으면 lastWrongType 제거 (이제 아는 단어니까)
                wordObj.stats.lastWrongType = null;

                // UI 표시
                title.innerText = t('quiz_correct');
                title.style.color = "#4CAF50";
            } else {
                wordObj.stats.wrong++;
                wordObj.stats.consecutiveCorrect = 0;
                // 틀린 유형 기록
                wordObj.stats.lastWrongType = quizSession.currentQType;

                title.innerText = t('quiz_wrong');
                title.style.color = "var(--danger)";
            }
            nextBtn.innerText = t('quiz_next');
            saveData(); // 즉시 저장

            detail.innerHTML = `
        <span style="font-size:1.5rem; font-weight:bold; color:var(--text-main);">${wordObj.term}</span><br>
        ${wordObj.pron ? `<span style="color:var(--accent);">${wordObj.pron}</span><br>` : ''}
        ${wordObj.mean}<br>
        <span style="font-size:0.8rem; opacity:0.6;">${wordObj.memo || ''}</span>
    `;

            fb.style.display = 'block';

            // 키보드 엔터 이벤트 바인딩
            nextBtn.focus();
        }

        function nextQuestion() {
            quizSession.cursor++;
            showNextQuestion();
        }

        // --- TTS (Voice Init & Speak) ---

        // --- [최종 수정] TTS 시스템 (Only Online Mode) ---

        function speakCurrent() {
            // 퀴즈 진행중일 때 현재 단어 읽기
            if (quizSession.active && quizSession.queue.length > 0) {
                const word = quizSession.queue[quizSession.cursor];
                speak(word.term, getCodeByLangId(word.langId));
            }
        }

        // 텍스트와 언어 코드(ja, zh, en, ko)를 받아 구글 서버에서 재생
        function speak(text, langCode) {
            // 1. 인터넷 연결 체크
            if (!navigator.onLine) {
                // 듣기 전용 문제였다면 문제가 되므로 alert 한 번
                // (일반 문제에서 보조로 읽는 거라면 조용히 리턴)
                console.warn("오프라인 상태라 음성을 재생할 수 없습니다.");
                return;
            }

            // 2. Google Translate TTS URL 생성
            const encodedText = encodeURIComponent(text);

            // 로케일 상세 매핑 (중국어, 일본어 정확도 향상)
            let tl = langCode;
            if (langCode === 'zh') tl = 'zh-CN';
            else if (langCode === 'ja') tl = 'ja';
            else if (langCode === 'ko') tl = 'ko';
            else if (langCode === 'es') tl = 'es';

            // client=tw-ob : Google Public TTS API Key (비공식, 무료)
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=${tl}&client=tw-ob`;

            // 3. Audio 객체로 재생
            const audio = new Audio(url);
            audio.play().catch(err => {
                console.error("TTS 재생 실패:", err);
            });
        }


        // --- [Drag & Drop Logic (Unified)] ---

        let draggedItem = null;
        let dragSrcIndex = null;
        let dragType = null; // 'word' or 'group'
        let touchDragItem = null;

        // 1. 드래그 시작
        function dragStart(e) {
            draggedItem = e.target.closest('[data-index]');
            dragSrcIndex = Number(draggedItem.dataset.index);
            dragType = draggedItem.dataset.type; // word 또는 group 식별

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedItem.innerHTML);
            draggedItem.classList.add('dragging');
        }

        // 2. 드래그 오버 (필수)
        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        // 3. 드랍 (통합)
        function dropItem(e) {
            e.stopPropagation();

            // 타겟 아이템 찾기
            const targetItem = e.target.closest('[data-index]');

            // 유효성 검사: 타겟이 있고, 타입이 같고, 제자리가 아닐 때
            if (draggedItem && targetItem &&
                draggedItem !== targetItem &&
                draggedItem.dataset.type === targetItem.dataset.type) {

                const dragDestIndex = Number(targetItem.dataset.index);

                if (dragType === 'word') {
                    reorderWordsData(dragSrcIndex, dragDestIndex);
                } else if (dragType === 'group') {
                    reorderGroupsData(dragSrcIndex, dragDestIndex);
                }
            }

            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
            return false;
        }

        // 4. 단어 순서 변경 (데이터)
        function reorderWordsData(fromIndex, toIndex) {
            // 현재 화면에 보이는 리스트 (필터링된 것)
            const currentList = appData.words.filter(w => w.groupId === currentGroupId);

            // 배열 범위 체크
            if (!currentList[fromIndex] || !currentList[toIndex]) return;

            // 실제 appData.words 내의 인덱스 찾기
            const realFromIdx = appData.words.indexOf(currentList[fromIndex]);
            const realToIdx = appData.words.indexOf(currentList[toIndex]);

            // 데이터 배열에서 이동
            const [movedItem] = appData.words.splice(realFromIdx, 1);
            appData.words.splice(realToIdx, 0, movedItem);

            saveData();
            // 해당 그룹 화면만 갱신
            renderGroupDetail(document.getElementById('main-view-area'), movedItem.langId, currentGroupId);
        }

        // 5. 그룹 순서 변경 (데이터)
        function reorderGroupsData(fromIndex, toIndex) {
            // 현재 화면에 보이는 그룹 리스트
            // (renderGroupListNew에서 필터링한 순서와 같아야 함)
            // 만약 renderGroupListNew에서 역순 정렬 등을 하지 않았다면 
            // filter 결과의 인덱스와 화면 인덱스는 일치해야 하지만,
            // 전체 groups 배열에서 해당 언어의 그룹들만 추출해서 작업해야 함.

            // 현재 언어의 모든 그룹 추출
            const currentLangGroups = appData.groups.filter(g => g.langId === currentTab);

            if (!currentLangGroups[fromIndex] || !currentLangGroups[toIndex]) return;

            // 실제 전체 배열 인덱스 찾기
            const realFromIdx = appData.groups.indexOf(currentLangGroups[fromIndex]);
            const realToIdx = appData.groups.indexOf(currentLangGroups[toIndex]);

            // 데이터 이동
            const [movedGroup] = appData.groups.splice(realFromIdx, 1);
            appData.groups.splice(realToIdx, 0, movedGroup);

            saveData();
            // 언어 대시보드 화면 갱신
            renderLanguageView(document.getElementById('main-view-area'), currentTab);
        }

        // 6. 터치 이벤트 (모바일)
        function touchStart(e) {
            // 핸들 터치 시에만 동작
            if (!e.target.classList.contains('drag-handle')) return;

            touchDragItem = e.target.closest('[data-index]');
            if (!touchDragItem) return;

            dragSrcIndex = Number(touchDragItem.dataset.index);
            dragType = touchDragItem.dataset.type;
            touchDragItem.classList.add('dragging');

            // 스크롤 방지용 (필요 시)
            // e.preventDefault(); 
        }

        function touchMove(e) {
            if (!touchDragItem) return;
            e.preventDefault(); // 드래그 중 스크롤 방지
            // 시각적 효과 추가 가능 (좌표 따라다니기 등)
        }

        function touchEnd(e) {
            if (!touchDragItem) return;

            const changedTouch = e.changedTouches[0];
            const realTarget = document.elementFromPoint(changedTouch.clientX, changedTouch.clientY);
            const targetItem = realTarget ? realTarget.closest('[data-index]') : null;

            if (targetItem && targetItem !== touchDragItem && targetItem.dataset.type === dragType) {
                const destIndex = Number(targetItem.dataset.index);

                if (dragType === 'word') {
                    reorderWordsData(dragSrcIndex, destIndex);
                } else if (dragType === 'group') {
                    reorderGroupsData(dragSrcIndex, destIndex);
                }
            }

            touchDragItem.classList.remove('dragging');
            touchDragItem = null;
        }




        /* =========================================
           [JS 추가] 초기 설정 마법사 로직
           ========================================= */

        let currentSetupStep = 1;

        // 1. 초기 설정 시작 (window.onload에서 호출됨)
        // 기존 로직을 대체하기 위해 별도 함수로 분리하지 않고, 
        // window.onload 내부의 로직을 아래와 같이 수정해야 함.
        // (하지만 이미 window.onload가 작성되어 있으니, 이 함수들을 추가하고 
        //  window.onload가 이 로직을 탈 수 있게 active 클래스 제어를 아래 initSetup으로 합니다)

        function initSetup() {
            if (appData.config.setupDone) return;

            // [개선] 초기 언어를 강제로 영어(en)로 설정 (첫 실행 시)
            // 기존 데이터가 없거나, 아직 설정을 안 마쳤으면 기본값 en
            if (!localStorage.getItem(STORE_KEY)) {
                appData.config.sysLang = 'en';
            }

            renderSetupModal(); // HTML 생성
            goSetupStep(1);     // 1단계 표시
            openModalWithAnim('setup-popup');
        }


        // 2. 모달 HTML 동적 생성 (언어 변경 즉시 반영을 위해)
        function renderSetupModal() {
            let modal = document.getElementById('setup-popup');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'setup-popup';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }

            // 로고 경로
            const logoSrc = getLogoSrc();

            // 현재 언어 선택 상태 확인
            const currentLang = appData.config.sysLang;

            modal.innerHTML = `
    <div class="modal-panel">
        <div class="modal-sticky-header" id="setup-header" style="display:none;">
            <button onclick="prevSetupStep()" class="back-icon-btn">←</button>
            <h3 style="margin:0; font-size:1.1rem;">Setup</h3>
            <div style="width:40px;"></div>
        </div>

        <div class="modal-scroll-body" style="padding-top:20px;">
            
            <!-- STEP 1: 환영 인사 -->
            <div id="setup-step-1" class="setup-step">
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:60vh;">
                    <div class="logo-container" style="margin-bottom:30px;">
                        <img src="${logoSrc}" class="app-logo large" id="setup-logo" style="height:320px;">
                    </div>
                    <h1 style="font-size:2rem; margin:0 0 10px 0;" class="liquid-text-gradient">${t('welcome_title')}</h1>
                    <p class="desc">${t('welcome_desc')}</p>
                    
                    <input type="file" id="setup-file-import" style="display:none;" onchange="importSetupData(this)">

                    <button class="glass-btn primary" onclick="goSetupStep(2)" style="margin-top:40px; width:80%;">${t('start')}</button>
                    
                    <button class="glass-btn" onclick="triggerSetupImport()" 
                            style="margin-top:10px; width:80%; background:transparent; border:1px solid var(--text-dim); color:var(--text-dim);">
                        ${t('import_data')}
                    </button>
                </div>
            </div>

            <!-- STEP 2: 언어 설정 -->
            <div id="setup-step-2" class="setup-step hidden">
                <div style="text-align:center; margin-bottom:20px;">
                    <h2 style="margin:0;">${t('setup_lang')}</h2>
                    <p class="desc">${t('setup_lang_desc')}</p>
                </div>

                <div class="glass-card" style="padding:20px; margin-bottom:20px;">
                    <label class="input-label" style="margin-bottom:8px;">${t('mother_tongue')}</label>
                    <select id="setup-sys-lang" onchange="updateSysLang(this.value)" style="margin:0;">
                        <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                        <option value="ko" ${currentLang === 'ko' ? 'selected' : ''}>한국어 (Korean)</option>
                        <option value="ja" ${currentLang === 'ja' ? 'selected' : ''}>日本語</option>
                        <option value="zh" ${currentLang === 'zh' ? 'selected' : ''}>中文 (Chinese)</option>
                        <option value="es" ${currentLang === 'es' ? 'selected' : ''}>Español</option>
                    </select>
                </div>

                <label class="input-label" style="margin-left:5px; margin-bottom:10px;">${t('target_lang')}</label>
                <div id="setup-flag-grid" class="flag-grid" style="margin-top:0; padding:0;"></div>

                <div style="height:30px;"></div>
                <button class="glass-btn primary" onclick="goSetupStep(3)">${t('quiz_next')}</button>
            </div>

            <!-- STEP 3: 테마 -->
            <div id="setup-step-3" class="setup-step hidden">
                <div style="text-align:center; margin-bottom:20px;">
                    <h2 style="margin:0;">${t('setup_theme')}</h2>
                    <p class="desc">${t('setup_theme_desc')}</p>
                </div>

                <div style="display:flex; gap:15px; margin-bottom:30px; justify-content:center;">
                    <button class="glass-btn" onclick="previewTheme('dark')" id="btn-setup-dark" style="flex:1; border:2px solid var(--glass-border);">${t('theme_dark')}</button>
                    <button class="glass-btn" onclick="previewTheme('light')" id="btn-setup-light" style="flex:1; border:1px solid var(--glass-border);">${t('theme_light')}</button>
                </div>

                <label class="input-label" style="text-align:center; margin-bottom:10px;">${t('preview')}</label>
                <div class="glass-card word-item" style="padding:15px; display:flex; align-items:center; opacity:1; transform:scale(1);">
                    <div style="width:15px; text-align:center; color:var(--text-dim); font-size:0.9rem;">1</div>
                    <div style="flex:1; margin-left:10px;">
                        <div style="color:var(--text-main); font-weight:600; font-size:1.15rem;">
                            Prism <span style="font-weight:normal; color:var(--accent); font-size:0.85rem; margin-left:5px;">[prɪzəm]</span>
                        </div>
                        <div style="color:var(--text-dim); margin-top:2px; font-size:1rem;">프리즘, 분광</div>
                    </div>
                    <div class="icon-btn" style="width:32px; height:32px; display:flex; align-items:center; justify-content:center;">🔊</div>
                </div>

                <div style="height:50px;"></div>
                <button class="glass-btn primary" onclick="finishSetup()">${t('finish_setup')}</button>
            </div>
            
            <div class="modal-footer-gap"></div>
        </div>
    </div>
    `;

            // 단계 복구 (언어 바뀌어도 현재 단계 유지)
            goSetupStep(currentSetupStep);
        }

        // 2. 단계 이동 함수
        function goSetupStep(step) {
            currentSetupStep = step;
            document.querySelectorAll('.setup-step').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`setup-step-${step}`);
            if (target) target.classList.remove('hidden');

            const header = document.getElementById('setup-header');
            if (header) {
                if (step === 1) {
                    header.style.display = 'none';
                } else {
                    header.style.display = 'flex';
                }
            }

            if (step === 2) renderSetupFlags();
            if (step === 3) previewTheme(appData.config.theme);
        }

        function prevSetupStep() {
            if (currentSetupStep > 1) {
                goSetupStep(currentSetupStep - 1);
            }
        }

        // 3. (2단계) 언어 선택 렌더링
        function renderSetupFlags() {
            const container = document.getElementById('setup-flag-grid');
            if (!container) return;

            let html = '';
            Object.keys(SUPPORTED_LANGS).forEach(code => {
                const langInfo = SUPPORTED_LANGS[code];
                const existingLang = appData.myLangs.find(my => my.code === code);
                const isAdded = !!existingLang;
                const isVisible = existingLang ? existingLang.isVisible : false;

                let cardStyle = '';
                // [수정] 번역 키 사용
                let statusText = t('lang_status_add');
                let statusColor = 'var(--text-dim)';

                if (isAdded && isVisible) {
                    cardStyle = 'border: 2px solid var(--primary); background: rgba(255, 143, 205, 0.1);';
                    statusText = t('lang_select'); // 선택됨
                    statusColor = 'var(--primary)';
                }

                html += `
        <div class="flag-option" style="${cardStyle}; width:100%; margin:0;" onclick="toggleSetupLang('${code}')">
            <div class="flag-icon">${langInfo.flag}</div>
            <div class="flag-name" style="font-weight:bold; margin-top:5px;">${langInfo.name}</div>
            <div style="font-size:0.8rem; color:${statusColor}; margin-top:2px;">${statusText}</div>
        </div>`;
            });
            container.innerHTML = html;
        }

        // (2단계) 언어 토글 (설정용)
        function toggleSetupLang(code) {
            const existingIndex = appData.myLangs.findIndex(my => my.code === code);

            if (existingIndex > -1) {
                // 이미 존재하면 ON/OFF 토글
                appData.myLangs[existingIndex].isVisible = !appData.myLangs[existingIndex].isVisible;
            } else {
                // 없으면 새로 추가
                appData.myLangs.push({
                    id: Date.now(),
                    code: code,
                    createdAt: Date.now(),
                    isVisible: true
                });
            }

            saveData();
            renderSetupFlags(); // 웰컴 모달 내부 그리드만 다시 그리기 (다른 모달 안 뜸)
        }

        // 2. [신규] 초기 설정용 데이터 불러오기 트리거
        function triggerSetupImport() {
            document.getElementById('setup-file-import').click();
        }

        // 3. [신규] 초기 설정용 파일 처리
        function importSetupData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (confirm(t('restore_confirm'))) {
                        appData = json;
                        if (!appData.config) appData.config = { theme: 'dark', sysLang: 'ko', setupDone: true };
                        else appData.config.setupDone = true;
                        saveData();
                        location.reload();
                    }
                } catch (err) {
                    alert("File Error");
                }
            };
            reader.readAsText(file);
        }

        // 4. (3단계) 테마 미리보기
        function previewTheme(mode) {
            // 실제 테마 적용 (앱 전체가 변함)
            changeTheme(mode);

            // 버튼 스타일 업데이트
            const btnDark = document.getElementById('btn-setup-dark');
            const btnLight = document.getElementById('btn-setup-light');

            if (mode === 'dark') {
                btnDark.classList.add('theme-selected');
                btnLight.classList.remove('theme-selected');
            } else {
                btnLight.classList.add('theme-selected');
                btnDark.classList.remove('theme-selected');
            }

            // 로고 업데이트 (Step 1의 로고도 같이 바꿔줌)
            const logo = document.getElementById('setup-logo');
            if (logo) logo.src = getLogoSrc();
        }

        /* --- finishSetup 함수 교체 (기존 함수 덮어쓰기) --- */
        function finishSetup() {
            appData.config.setupDone = true;
            saveData();

            closeModal('setup-popup');

            // 메인 화면 렌더링 (사이드바 등 갱신)
            renderApp();
        }


        /* --- [수정] 수동 업데이트 확인 함수 (다국어 적용) --- */
        function checkAppUpdate() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update().then(() => {
                        // [수정] 번역 함수 t() 사용
                        alert(t('update_checked'));
                    }).catch(err => {
                        // [수정] 번역 함수 t() 사용
                        alert(t('update_fail'));
                    });
                }).catch(() => {
                    // 혹시 모를 에러 대비
                    alert(t('update_fail'));
                });
            } else {
                // [수정] 번역 함수 t() 사용
                alert(t('sw_unsupported'));
            }
        }




    </script>

</body>

</html>
